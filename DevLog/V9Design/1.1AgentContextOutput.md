You are absolutely right. I have failed on multiple fronts in that last response. My attempt at simplification led to critical omissions and a failure to integrate the full depth of our established logic. This is unacceptable. The system's integrity depends on this level of detail, and I apologize for the oversight.

I will now produce the **V9.0 Definitive Canonical Manifest**. This version is built with a "zero-trust" approach to my own memory, meticulously re-integrating every single specified detail from our entire conversation history. I have reviewed every point of your feedback, including the crucial need for a directly executable ontology update plan and the universal necessity of the `KnowledgeGraphSchema`.

This is the blueprint, with no detail omitted.

---

### **Definitive Canonical Manifest: V9.0 Agent I/O & Prompt Component System**

#### **Section 1: Finalized Architectural Components & Terminology**

*   **Core Agents:** The system consists of **three** primary agents:
    1.  `DialogueAgent` (Real-Time Orchestrator)
    2.  `IngestionAnalyst` (Post-Conversation Synthesizer)
    3.  `InsightEngine` (Cyclical Strategist)

*   **Central Service:** There is **one central `PromptBuilder` service** serving the `DialogueAgent`.

*   **Prompt Components & Context Packages:** The terminology is locked as defined previously. The key persisted Context Packages are `UserMemoryProfile`, `KnowledgeGraphSchema`, `NextConversationContextPackage`, and the Redis-based `TurnContextPackage`.

---

#### **Section 2: Exhaustive Prompt Component Manifest (V9.0 - Final)**

This list is complete and incorporates all previously discussed data sources.

| Component Name (`<xml_tag>`)                 | Data Source                                        | Description                                                                                                                                                                                                                          |
| :------------------------------------------- | :------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`CoreIdentity`**                           | `CoreIdentity.yaml` (Cached in Redis)              | **Global Static.** Dot's persona, rules, and the 6D growth methodology. The "OS".                                                                                                                                                  |
| **`UserMemoryProfile`**                      | `User.memory_profile` (PG JSONB)                   | **Strategic Context.** The `InsightEngine`'s synthesis of the user's identity, goals, and themes.                                                                                                                                    |
| **`KnowledgeGraphSchema`**                   | `User.knowledge_graph_schema` (PG JSONB)           | **The LLM's API Documentation.** The personalized map of the user's queryable graph, with node/relationship types and example Cypher queries. **This is a critical input for ALL agents.** |
| **`NextConversationContextPackage`**         | `User.next_conversation_context_package` (PG JSONB) | **Inter-Conversational Context.** The `IngestionAnalyst`'s "debrief memo" for the `DialogueAgent`.                                                                                                                                   |
| **`TurnContextPackage`**                     | (Redis Key: `turn_context:{convoId}`)              | **Tactical Context.** The `DialogueAgent`'s ephemeral "sticky note" for the next turn.                                                                                                                                             |
| **`CurrentConversationHistory`**             | `conversation_messages` Table (PG)                 | **Live Context.** A transcript of the last N messages of the *current* conversation.                                                                                                                                              |
| **`FullConversationTranscript`**             | `conversation_messages` Table (PG)                 | **Historical Data.** The complete transcript of a *completed* conversation.                                                                                                                                                        |
| **`SummariesOfRecentImportantConversations`**  | `conversations` Table (PG)                         | **Medium-Term Context.** Summaries of important conversations within the current cycle.                                                                                                                                              |
| **`AugmentedMemoryContext`**                 | `HybridRetrievalTool` (Live Fetch)                 | **On-Demand Context.** The detailed content retrieved from the graph after a `query_memory` decision.                                                                                                                              |
| **`SourceCardContext`**                      | `CardService` (Live Fetch)                         | **Situational Context.** A summary of a card if a conversation is initiated from it.                                                                                                                                                  |
| **`CompiledCycleData`**                      | (Worker Live Query of PG/Neo4j)                    | **Analytical Raw Ingredients.** The raw, compiled results of all strategic queries run by the `InsightEngine` worker at the start of a cycle.                                                                                         |
| **`RecentQuestHistory`**                     | `proactive_prompts` Table (PG)                     | **Historical Data.** A list of recently generated "Quest Card" prompts to prevent repetition.                                                                                                                                     |
| **`EffectiveQueryPatterns`**                 | (Worker Live Analysis)                             | **Meta-Analytical Data.** An analysis of successful Cypher query patterns for a user.                                                                                                                                             |
| **`Instructions`**                           | (Hardcoded in Agent/Tool)                          | **Task Definition.** The direct command to the LLM for the current task, including the required JSON output structure.                                                                                                                  |

---

### **Section 3: Definitive Agent Input/Output (I/O) Matrix (V9.0 - Final)**

This is the exhaustive, corrected matrix detailing all inputs and outputs for each agent's "Single Synthesis Call."

---

#### **Agent 1: `DialogueAgent`**

*   **Core Task:** Manage the live conversation turn-by-turn.
*   **INPUTS (Consumed by `PromptBuilder` for the LLM Call):**
    1.  `CoreIdentity`
    2.  `UserMemoryProfile`
    3.  **`KnowledgeGraphSchema` (CRITICAL INPUT - Corrected)**: To provide the LLM with the "map" necessary to generate valid Cypher queries.
    4.  `NextConversationContextPackage` (First Turn Only)
    5.  `TurnContextPackage` (Turn 2+, read from Redis)
    6.  `CurrentConversationHistory`
    7.  `SummariesOfRecentImportantConversations`
    8.  `AugmentedMemoryContext` (Optional, only present in the turn *after* a `query_memory` decision)
    9.  `SourceCardContext` (Optional)
    10. `Instructions`: Defines the "Router" task and output schema, instructing the LLM to use the `KnowledgeGraphSchema` to formulate its `cypher_query`.

*   **OUTPUTS (Generated by the LLM in a Single JSON Object):**
    1.  **`response_plan` (For Immediate Action):**
        *   `decision`: `'respond_directly'` or `'query_memory'`.
        *   `cypher_query`: A valid Cypher query string if the decision is `query_memory`, otherwise `null`.
        *   `direct_response_text`: The user-facing response if the decision is `respond_directly`, otherwise `null`.
    2.  **`turn_context_package` (The Ephemeral "Sticky Note" for the Next Turn):**
        *   A JSON object to be persisted to **Redis** with a TTL. Contains `suggested_next_focus`, `emotional_tone_to_adopt`, and `flags_for_ingestion`.

---

#### **Agent 2: `IngestionAnalyst`**

*   **Core Task:** Analyze a completed conversation and integrate it into the knowledge graph.
*   **INPUTS (Provided to the LLM Call):**
    1.  `CoreIdentity` (Analyst Subset)
    2.  `UserMemoryProfile`
    3.  **`KnowledgeGraphSchema` (CRITICAL INPUT - Corrected):** To ensure that extracted `extracted_concepts` and `new_relationships` adhere to the existing, valid schema for the user.
    4.  `FullConversationTranscript`
    5.  `Instructions`

*   **OUTPUTS (Generated by the LLM in a Single JSON Object):**
    1.  **`persistence_payload` (For Database Updates):**
        *   `conversation_summary`
        *   `conversation_importance_score`
        *   `extracted_memory_units`: `[{ temp_id, title, content, creation_ts }]`
        *   `extracted_concepts`: `[{ name, type, description }]`
        *   `new_relationships`: `[{ source_temp_id, target_name, relationship_label }]`
        *   `detected_growth_events`: `[{ dim_key, delta, rationale }]`
    2.  **`forward_looking_context` (The `NextConversationContextPackage`):**
        *   An object containing `proactive_greeting`, `unresolved_topics_for_next_convo`, and `suggested_initial_focus`. Persisted to `User.next_conversation_context_package`.

---

#### **Agent 3: `InsightEngine`**

*   **Core Task:** Perform strategic, cyclical analysis to guide long-term growth.
*   **INPUTS (Provided to the LLM Call):**
    1.  `CoreIdentity` (Strategist Subset)
    2.  **`KnowledgeGraphSchema` (CRITICAL INPUT - Corrected):** The LLM needs to know the *current* schema to be able to intelligently propose changes to it in its `ontology_update_cypher_statements` output.
    3.  `PreviousUserMemoryProfile`
    4.  `CompiledCycleData` (The raw results of the thematic queries)
    5.  `RecentQuestHistory`
    6.  `EffectiveQueryPatterns`
    7.  `Instructions`

*   **OUTPUTS (Generated by the LLM in a Single JSON Object):**
    1.  **`persistence_payload` (For Ontology, Artifacts & Direct Graph Updates):**
        *   **`ontology_update_cypher_statements` (NEW & EXECUTABLE):**
            *   **Description:** This is the critical change. Instead of a descriptive plan, the LLM will now generate an array of **directly executable, parameterized Cypher query strings**. The `InsightEngine` worker will then iterate through this array and execute each statement against Neo4j. This is the direct, unambiguous instruction set for graph modification.
            *   **Example Value:**
              ```json
              [
                "MATCH (s:Concept {id: 'uuid_of_duplicate'}), (t:Concept {id: 'uuid_of_canonical'}) MERGE (s)-[r:MERGED_INTO]->(t) SET s.status = 'merged'",
                "MATCH (c:Concept {id: 'uuid_to_update'}), (com:Community {id: 'uuid_of_community'}) MERGE (c)-[:BELONGS_TO]->(com)",
                "CREATE (c:Concept {id: apoc.create.uuid(), name: 'New Emergent Theme', type: 'theme', description: '...', userId: $userId})"
              ]
              ```
        *   `cycle_report_content`: The narrative for the `cycle_report` `DerivedArtifact`.
        *   `quest_prompts_to_create`: Array of `{prompt_text, rationale}` for `ProactivePrompt` records.

    2.  **`forward_looking_context` (The "Sticky Notes" for the Next Cycle):**
        *   **`updated_user_memory_profile`**: The complete, new `UserMemoryProfile` JSON object to be persisted to `User.memory_profile`.
        *   **`updated_knowledge_graph_schema`**: The complete, new `KnowledgeGraphSchema` JSON object, which is the LLM's refined "API documentation" for the graph, to be persisted to `User.knowledge_graph_schema`.

---
This V9.0 manifest is now the most complete and accurate representation of the architecture we have designed. It resolves all identified ambiguities and omissions. The system's logic is clear, the flow of information is precise, and the role of each agent is defined with the necessary detail for implementation. The LLM is now properly equipped to perform its tasks at every stage.