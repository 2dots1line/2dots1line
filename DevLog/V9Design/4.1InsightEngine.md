Understood. I will now update the canonical guide for the `InsightEngine` worker to fully align with the **V9.0 Definitive Canonical Manifest** and all our refined architectural decisions, including the crucial role of the "Global Cypher Query Library" and the explicit, executable nature of its ontology update outputs.

Key changes from the V8 version you provided to the new V9.0 standard:

1.  **V9.0 Terminology:** Using "Context Package," `KnowledgeGraphSchema`, `CompiledCycleData`, etc.
2.  **"Single Synthesis Call" Principle:** The `InsightEngine`'s LLM call generates *all* its outputs (ontology updates, `UserMemoryProfile`, `KnowledgeGraphSchema`, cycle report, quest prompts) in one go.
3.  **Comprehensive Input Manifest:** Ensuring its LLM call receives all necessary inputs, including the *current* `KnowledgeGraphSchema` and `EffectiveQueryPatterns`.
4.  **Executable Ontology Updates:** The LLM output for ontology changes is now an array of directly executable Cypher statements.
5.  **Global Cypher Query Library:** Explicitly stating that the "Execute Global Queries" step uses a dedicated `InsightQueryLibrary` module to fetch the `CompiledCycleData`.
6.  **Corrected File Paths:** Reflecting the V9.0 monorepo structure.

Here is the updated canonical guide for the V9.0 `InsightEngine` worker.

---

### **Canonical Guide: The V9.0 `InsightEngine` Worker**

#### **1. Core Job Responsibility & Philosophy**

The `InsightEngine` is an **asynchronous background worker** responsible for the **strategic, "slow loop" processing of a user's entire knowledge graph**. Its purpose is to move beyond tactical data to uncover deep, longitudinal patterns, perform holistic ontology refinement, update the user's strategic profiles, and proactively generate guidance for future growth.

**Primary Mandate:**
To execute a "cycle" for an eligible user. This involves:
1.  Performing **deterministic, hypothesis-driven global queries** against the user's graph using a curated `InsightQueryLibrary` to compile comprehensive `CompiledCycleData`.
2.  Making a **single, synthesis LLM call** with this data to:
    *   Generate an **executable `OntologyUpdatePlan`** (as Cypher statements).
    *   Generate a new, updated **`UserMemoryProfile`**.
    *   Generate a new, updated **`KnowledgeGraphSchema`**.
    *   Generate content for a user-facing **`cycle_report`**.
    *   Generate prompts for **"Quest Cards."**
3.  Persisting all these outputs.

It is the system's long-term strategic planner and knowledge consolidator.

**Architectural Principle:** The `InsightEngine` operates **strategically and periodically**. Its high computational cost is justified by the high value of its outputs. It is triggered by a combination of time and user activity.

**Location:** `workers/insight-worker/src/InsightEngine.ts`

#### **2. Detailed Workflow: Processing a Single User Cycle**

This is the strictly defined, deterministic sequence of operations executed when a user is deemed eligible for a cycle refresh.

**Trigger:** A cron-scheduled job in the `insight-worker` identifies eligible users and places a job with `{ userId }` onto the `insight-queue`. An `InsightEngine` worker instance picks up this job.

##### **Phase I: Data Compilation (Deterministic Code - The "Raw Ingredients")**

This phase gathers all necessary data for the LLM's strategic synthesis.

1.  **Fetch Core Context Packages:** The worker calls the `UserRepository` to fetch the user's current:
    *   `PreviousUserMemoryProfile` (the `User.memory_profile` from the *start* of this cycle)
    *   `KnowledgeGraphSchema` (the *current* `User.knowledge_graph_schema`)
2.  **Execute Global Thematic Queries via `InsightQueryLibrary`:**
    *   **Dependency:** `InsightQueryLibrary` from `packages/database/src/neo4j/queries/insight-queries.ts`.
    *   **Action:** The worker systematically calls methods on the `InsightQueryLibrary` (e.g., `getStalledGoals()`, `getTopSalientValues()`, `getEmergingConceptSpikes()`, etc. – corresponding to the approved list of 20 strategic questions).
    *   **Output:** The raw, structured results from all these queries are compiled into a single, large JSON object: the **`CompiledCycleData`**.
3.  **Fetch Supporting Context:**
    *   `RecentQuestHistory`: Fetched from the `proactive_prompts` table.
    *   `EffectiveQueryPatterns`: Generated by the worker by analyzing successful `DialogueAgent` Cypher queries from the last cycle.

##### **Phase II: Strategic Synthesis & Planning (The Single Synthesis LLM Call)**

This is the core cognitive step.

1.  **Invoke Specialized `LLMInsightTool` (or directly use `LLMChatTool` with a master prompt):**
    *   **Input Prompt Components (Assembled by the worker's internal formatter):**
        1.  `CoreIdentity` (Strategist Subset)
        2.  `KnowledgeGraphSchema` (Current version, so the LLM knows what it can suggest changes to)
        3.  `PreviousUserMemoryProfile`
        4.  `CompiledCycleData` (The rich output from Phase I)
        5.  `RecentQuestHistory`
        6.  `EffectiveQueryPatterns`
        7.  `Instructions`: The master prompt defining the strategic synthesis task and the required comprehensive JSON output structure (see below).
    *   **Action:** The LLM performs a global analysis and generates a single JSON object containing all strategic outputs.

2.  **Expected LLM Output JSON Structure (V9.0 - Comprehensive):**
    ```json
    {
      "persistence_payload": {
        "ontology_update_cypher_statements": [ // Directly executable, parameterized Cypher
          "MATCH (s:Concept {id: $dupId}), (t:Concept {id: $canonId}) WHERE s.userId = $userId AND t.userId = $userId MERGE (s)-[r:MERGED_INTO]->(t) SET s.status = 'merged'",
          "CREATE (c:Concept {id: apoc.create.uuid(), name: 'New Discovered Theme X', type: 'theme', description: '...', userId: $userId})"
          // ... more Cypher statements for creates, archives, relationship changes, community updates ...
        ],
        "cycle_report_content": "A warm, narrative summary of the user's progress this cycle...",
        "quest_prompts_to_create": [
          {
            "prompt_text": "I noticed a strong theme of 'Resilience' in your recent entries, but we haven't explored how it connects to your goal of 'Career Change'. What thoughts come up around that?",
            "rationale": "Connects a prominent theme to an active goal."
          }
        ]
      },
      "forward_looking_context": {
        "updated_user_memory_profile": { /* ... complete new UserMemoryProfile object ... */ },
        "updated_knowledge_graph_schema": { /* ... complete new KnowledgeGraphSchema object, potentially refined ... */ }
      }
    }
    ```

##### **Phase III: Persistence, Graph Update & State Propagation (Deterministic Code)**

1.  **Receive & Validate JSON:** The `InsightEngine` worker receives the single structured JSON and validates its schema.
2.  **Process `persistence_payload`:**
    *   **Ontology Updates:** The worker iterates through the `ontology_update_cypher_statements` array. For each statement, it opens a Neo4j transaction and **executes the Cypher query directly**, passing the `$userId` and any other necessary parameters. This ensures the graph is modified exactly as the LLM planned. *This is a critical change: the LLM generates the precise operations.*
    *   Create `DerivedArtifact` in PostgreSQL for the `cycle_report_content`.
    *   Create `ProactivePrompt` records in PostgreSQL for each item in `quest_prompts_to_create`.
3.  **Process `forward_looking_context` (State Propagation):**
    *   Save the `updated_user_memory_profile` to `User.memory_profile` in PostgreSQL.
    *   Save the `updated_knowledge_graph_schema` to `User.knowledge_graph_schema` in PostgreSQL.
4.  **Invoke `CardFactory`:** The worker calls `CardFactory.createCardsForEntities()` with the new `DerivedArtifact` (for the cycle report) and the new `ProactivePrompt` entities (for the quests).
5.  **Cycle Completion:** Update the user's `last_cycle_started_at` timestamp and reset their `concepts_created_in_cycle` counter to `0` in the `User` table.

**Completion:** The job is marked as complete in the BullMQ queue.

---

#### **3. Dependencies & Collaborators (V9.0)**

| Component Name                 | Type          | Location                                                                | Role & Responsibility                                                                                                                              |
| :----------------------------- | :------------ | :---------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Scheduler (Cron Job)**       | **Upstream**  | (Within `insight-worker`)                                               | Triggers the `InsightEngine` by querying for eligible users and queueing jobs.                                                                       |
| `StrategicSynthesisTool`       | **Tool (Composite)** | (Configured via `tool_composition.json`, uses atomic `LLMChatTool`) | Performs the core LLM call for strategic synthesis.                                                                                                |
| `InsightQueryLibrary`          | **Dependency**| `packages/database/src/neo4j/queries/insight-queries.ts`                | Provides methods to execute the suite of 20+ deterministic, thematic Cypher queries to generate `CompiledCycleData`.                                |
| `CardFactory`                  | **Service**   | `services/card-service/src/CardFactory.ts`                              | Downstream service to create `Card`s for Quests and Cycle Reports.                                                                                   |
| `UserRepository`, `ProactivePromptRepository`, `DerivedArtifactRepository` | **Dependencies**| `packages/database/src/repositories/`                                   | Persist `UserMemoryProfile`, `KnowledgeGraphSchema`, quest prompts, and cycle reports.                                                               |
| **Neo4j Client**               | **Dependency**| `packages/database/`                                                    | Directly executes the `ontology_update_cypher_statements` generated by the LLM.                                                                      |

---

#### **4. Updated Flowchart: V9.0 InsightEngine Worker Flow (Single Synthesis, Executable Ontology Plan)**

```
                                          ┌────────────────────────────────┐
                                          │      `insight-queue`           │
                                          │       (Job: { userId })        │
                                          └───────────────┬────────────────┘
                                                          │ 1. Worker picks up job
                                                          ▼
                                          ┌────────────────────────────────┐
                                          │  `InsightEngine.processCycle()`  │
                                          └───────────────┬────────────────┘
                                                          │ 2. PHASE I: Data Compilation
                                                          │    - Fetch User.memory_profile (prev), User.knowledge_graph_schema
                                                          │    - Call InsightQueryLibrary -> CompileCycleData
                                                          │    - Fetch RecentQuestHistory, EffectiveQueryPatterns
                                                          │
                                                          │ 3. PHASE II: Invoke StrategicSynthesisTool (Composite)
                                          ┌───────────────▼───────────────┐
                                          │   `StrategicSynthesisTool`    │
                                          │  (Single LLM call, returns JSON with persistence_payload, │
                                          │   user_facing_artifacts, & forward_looking_context)       │
                                          └───────────────┬───────────────┘
                                                          │ 4. Receives & validates comprehensive JSON
                                                          │
          ┌───────────────────────────────────────────────┼──────────────────────────────────────────────┐
          │ 5a. PROCESS `persistence_payload`             │ 5b. PROCESS `forward_looking_context`        │
          ▼                                               ▼                                              │
┌──────────────────────────┐                        ┌──────────────────────────────────────────┐         │
│  ONTOLOGY & ARTIFACTS    │                        │  UPDATE USER STRATEGIC STATE             │         │
│ - Execute `ontology_update_cypher_statements` (N4J)│- Save `updated_user_memory_profile` (PG)│         │
│ - Create `cycle_report` DerivedArtifact (PG)      │- Save `updated_knowledge_graph_schema` (PG)│       │
│ - Create `ProactivePrompt` records (PG)         │ └──────────────────────────────────────────┘         │
└────────────┬─────────────┘                                                                             │
             │ 6. Gathers new DerivedArtifact (report) & ProactivePrompts (quests)                       │
             │                                                                                           │
             │ 7. Invokes Card Factory                                                                   │
           ┌─▼─────────────┐                                                                             │
           │ `CardFactory` │                                                                             │
           │ (Creates `Card` │                                                                           │
           │ records in PG)  │                                                                           │
           └─┬─────────────┘                                                                             │
             │ 8. Card creation complete                                                                 │
             │                                                                                           │
             └───────────────────────────────────┬───────────────────────────────────────────────────────┘
                                                 │ 9. Cycle Completion: Update User.last_cycle_started_at, reset counter
                                                 │
                                                 ▼
                                   ┌────────────────────────────────┐
                                   │        Job Marked Complete     │
                                   └────────────────────────────────┘
```

This V9.0 canonical guide for the `InsightEngine` worker is now complete, consistent, and directly reflects all our architectural decisions. It emphasizes its strategic role, its use of a dedicated query library, and the critical output of executable Cypher statements for ontology updates, ensuring a robust and intelligent cyclical processing loop.