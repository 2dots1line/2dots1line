### **`5.1_V11.0_Monorepo_and_Deployment.md`**

---

# **V11.0 Monorepo Structure and Deployment Strategy**

**Document Version:** 11.0 (Headless Service Architecture)
**Purpose:** To define the complete monorepo structure and deployment architecture for the 2dots1line V11.0 platform, emphasizing the new headless service pattern.

## **1. Monorepo Directory Structure**

```
2D1L/                                      # Root directory
â”œâ”€â”€ apps/                                  # Frontend applications & API Gateway
â”‚   â”œâ”€â”€ api-gateway/                       # â­ MAIN HTTP SERVER (Port 3001)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app.ts                     # Express app configuration
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts                  # Server entry point
â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/               # REST API controllers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation.controller.ts    # DIRECT calls to DialogueAgent
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ card.controller.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ graph.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/                # Auth, logging, validation
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ logging.middleware.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validation.middleware.ts
â”‚   â”‚   â”‚   â””â”€â”€ routes/                    # Route definitions
â”‚   â”‚   â”‚       â””â”€â”€ v1/
â”‚   â”‚   â”‚           â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ web-app/                           # Next.js frontend (Port 3000)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app/                       # App Router pages
â”‚   â”‚   â”‚   â”œâ”€â”€ components/                # React components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ 2d-canvas/            # 2D Card Canvas
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ 3d-cosmos/            # 3D Knowledge Cosmos
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/                    # Zustand state management
â”‚   â”‚   â”‚   â””â”€â”€ services/                  # API client services
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ next.config.js
â”‚   â””â”€â”€ storybook/                         # Component development
â”‚       â”œâ”€â”€ demo.html
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ services/                              # ğŸš¨ V11.0: HEADLESS BUSINESS LOGIC LIBRARIES
â”‚   â”œâ”€â”€ dialogue-service/                  # DialogueAgent & PromptBuilder (LIBRARY)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ DialogueAgent.ts           # Main agent class
â”‚   â”‚   â”‚   â”œâ”€â”€ PromptBuilder.ts           # Context compilation
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                   # Export main classes
â”‚   â”‚   â”œâ”€â”€ package.json                   # NO server dependencies
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ user-service/                      # User management logic (LIBRARY)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ UserService.ts             # User business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthService.ts             # Authentication logic
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ card-service/                      # Card creation logic (LIBRARY)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ CardService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ CardFactory.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ config-service/                    # Configuration management (LIBRARY)
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ ConfigService.ts
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ workers/                               # ğŸ”„ STANDALONE WORKER PROCESSES
â”‚   â”œâ”€â”€ conversation-timeout-worker/       # Redis key expiry listener (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationTimeoutWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                   # PM2 entry point
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ ingestion-worker/                  # IngestionAnalyst processor (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ IngestionAnalyst.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ insight-worker/                    # InsightEngine processor (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ InsightEngine.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ InsightDataCompiler.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ card-worker/                       # Card generation processor (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ CardWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ graph-projection-worker/           # 3D projection processor (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ GraphProjectionWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ embedding-worker/                  # Vector embedding processor (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ EmbeddingWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ graph-sync-worker/                 # Neo4j synchronization (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ GraphSyncWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ notification-worker/               # WebSocket/SSE events (PM2)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ NotificationWorker.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ maintenance-worker/                # System maintenance (PM2)
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ MaintenanceWorker.ts
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ packages/                              # SHARED LIBRARIES & UTILITIES
â”‚   â”œâ”€â”€ shared-types/                      # TypeScript type definitions
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/                  # Database entity types
â”‚   â”‚   â”‚   â”œâ”€â”€ api/                       # API request/response types
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/                        # AI-related types
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ database/                          # Database layer (Prisma, Neo4j, Weaviate)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/              # Data access layer
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserRepository.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationRepository.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MemoryRepository.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CardRepository.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConceptRepository.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GraphProjectionRepository.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ services/                  # Database service classes
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PostgresService.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Neo4jService.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WeaviateService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ prisma-client.ts           # Prisma singleton
â”‚   â”‚   â”‚   â”œâ”€â”€ DatabaseService.ts         # Main database orchestrator
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ prisma/                        # Prisma schema & migrations
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.prisma
â”‚   â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ schemas/                       # Non-relational schemas
â”‚   â”‚   â”‚   â”œâ”€â”€ neo4j.cypher
â”‚   â”‚   â”‚   â””â”€â”€ weaviate.json
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ tool-registry/                     # AI Tool architecture
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ ToolRegistry.ts            # Central tool factory
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts                   # Tool type definitions
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ tools/                             # Individual AI tools
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ atomic/                    # Basic tools
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LLMChatTool.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HybridRetrievalTool.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ specialized/               # Domain-specific tools
â”‚   â”‚   â”‚   â”œâ”€â”€ composite/                 # Complex composite tools
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HolisticAnalysisTool.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ StrategicSynthesisTool.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ ai-clients/                        # AI service integrations
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ google/                    # Gemini client
â”‚   â”‚   â”‚   â”œâ”€â”€ deepseek/                  # DeepSeek client
â”‚   â”‚   â”‚   â””â”€â”€ interfaces/                # Common AI interfaces
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ core-utils/                        # Shared utilities
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ constants.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ validation/
â”‚   â”‚   â”‚   â”œâ”€â”€ formatting/
â”‚   â”‚   â”‚   â””â”€â”€ security/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ ui-components/                     # Shared React components
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ primitives/                # Basic UI elements
â”‚   â”‚   â”‚   â”œâ”€â”€ cards/                     # Card-related components
â”‚   â”‚   â”‚   â”œâ”€â”€ forms/                     # Form components
â”‚   â”‚   â”‚   â””â”€â”€ layouts/                   # Layout components
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ canvas-core/                       # 3D Canvas utilities
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ camera/
â”‚   â”‚   â”‚   â”œâ”€â”€ lighting/
â”‚   â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ orb-core/                          # Orb visualization
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â”œâ”€â”€ effects/
â”‚   â”‚   â”‚   â”œâ”€â”€ emotions/
â”‚   â”‚   â”‚   â””â”€â”€ states/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ shader-lib/                        # GLSL shader library
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ shaders/
â”‚       â”‚   â””â”€â”€ generated/
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ py-services/                           # PYTHON MICROSERVICES
â”‚   â””â”€â”€ dimension-reducer/                 # UMAP/t-SNE service (Port 5001)
â”‚       â”œâ”€â”€ app.py                         # FastAPI server
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â”œâ”€â”€ requirements.txt
â”‚       â””â”€â”€ pyproject.toml
â”œâ”€â”€ config/                                # CONFIGURATION FILES
â”‚   â”œâ”€â”€ card_eligibility_rules.json
â”‚   â”œâ”€â”€ card_templates.json
â”‚   â”œâ”€â”€ challenges.json
â”‚   â”œâ”€â”€ prompt_templates.yaml
â”‚   â”œâ”€â”€ tsconfig/
â”‚   â”‚   â””â”€â”€ base.json                      # Shared TypeScript config
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 3d-assets/                             # 3D ASSETS
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ textures/
â”‚   â”œâ”€â”€ materials/
â”‚   â””â”€â”€ environment-maps/
â”œâ”€â”€ __tests__/                             # TEST SUITES
â”‚   â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ loops/                             # System loop tests
â”‚   â”‚   â”œâ”€â”€ 1-conversation-loop/
â”‚   â”‚   â”œâ”€â”€ 2-fast-loop/
â”‚   â”‚   â”œâ”€â”€ 3-presentation-loop/
â”‚   â”‚   â””â”€â”€ 4-slow-loop/
â”‚   â””â”€â”€ setup.ts
â”œâ”€â”€ scripts/                               # AUTOMATION SCRIPTS
â”œâ”€â”€ docs/                                  # DOCUMENTATION
â”œâ”€â”€ DevLog/                                # DEVELOPMENT LOG
â”‚   â”œâ”€â”€ V11.0/                             # â† Current specification documents
â”‚   â””â”€â”€ ...
â”œâ”€â”€ infrastructure/                        # INFRASTRUCTURE AS CODE
â”œâ”€â”€ docker-compose.yml                     # V11.0: Only infrastructure services
â”œâ”€â”€ docker-compose.dev.yml                # Development overrides
â”œâ”€â”€ ecosystem.config.js                   # PM2 configuration
â”œâ”€â”€ package.json                          # Root package.json
â”œâ”€â”€ pnpm-workspace.yaml                   # Workspace configuration
â”œâ”€â”€ pnpm-lock.yaml                        # Lock file
â””â”€â”€ tsconfig.json                         # Root TypeScript config
```

## **2. V11.0 Deployment Architecture**

### **2.1 Running Processes (Production)**

```yaml
PROCESSES:
  api-gateway:              # Port 3001 (HTTP Server)
    type: "http-server"
    pm2: true
    replicas: 2
    memory: "512MB"
    
  web-app:                  # Port 3000 (Static/SSR)
    type: "frontend"
    pm2: true
    replicas: 1
    memory: "256MB"
    
  workers:                  # Background job processors
    conversation-timeout-worker:
      pm2: true
      instances: 1
      memory: "128MB"
    ingestion-worker:
      pm2: true
      instances: 2
      memory: "512MB"
    insight-worker:
      pm2: true
      instances: 1
      memory: "1GB"
    card-worker:
      pm2: true
      instances: 2
      memory: "256MB"
    graph-projection-worker:
      pm2: true
      instances: 1
      memory: "512MB"
    embedding-worker:
      pm2: true
      instances: 2
      memory: "256MB"
    graph-sync-worker:
      pm2: true
      instances: 1
      memory: "256MB"
    notification-worker:
      pm2: true
      instances: 1
      memory: "128MB"
    maintenance-worker:
      pm2: true
      instances: 1
      memory: "128MB"

INFRASTRUCTURE_SERVICES:
  postgresql:               # Port 5432
    docker: true
    volumes: ["./postgres_data:/var/lib/postgresql/data"]
    
  neo4j:                    # Ports 7474, 7687
    docker: true
    volumes: ["./neo4j_data:/data"]
    
  weaviate:                 # Port 8080
    docker: true
    volumes: ["./weaviate_data:/var/lib/weaviate"]
    
  redis:                    # Port 6379
    docker: true
    volumes: ["./redis_data:/data"]
    
  dimension-reducer:        # Port 5001 (Python FastAPI)
    docker: true
    type: "python-service"
```

### **2.2 V11.0 Docker Compose Configuration**

```yaml
# docker-compose.yml (V11.0 - Infrastructure Only)
version: '3.8'

services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: twodots1line
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dev_password
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5.11
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/dev_password
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
    volumes:
      - ./neo4j_data:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p dev_password 'MATCH (n) RETURN count(n) LIMIT 1'"]
      interval: 30s
      timeout: 10s
      retries: 5

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.24.1
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: 'text2vec-openai,text2vec-cohere,text2vec-huggingface,ref2vec-centroid,generative-openai,qna-openai'
      CLUSTER_HOSTNAME: 'node1'
    volumes:
      - ./weaviate_data:/var/lib/weaviate

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data
    command: redis-server --appendonly yes

  dimension-reducer:
    build: ./py-services/dimension-reducer
    ports:
      - "5001:5001"
    environment:
      - ENVIRONMENT=development
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  default:
    name: twodots1line_network
```

### **2.3 PM2 Ecosystem Configuration (V11.0)**

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    // Main HTTP Server
    {
      name: 'api-gateway',
      script: 'dist/server.js',
      cwd: './apps/api-gateway',
      instances: 2,
      exec_mode: 'cluster',
      max_memory_restart: '512M',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      }
    },
    
    // Frontend Application  
    {
      name: 'web-app',
      script: 'npm run start',
      cwd: './apps/web-app',
      instances: 1,
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    },
    
    // Background Workers
    {
      name: 'conversation-timeout-worker',
      script: 'dist/index.js',
      cwd: './workers/conversation-timeout-worker',
      instances: 1,
      max_memory_restart: '128M'
    },
    {
      name: 'ingestion-worker',
      script: 'dist/index.js',
      cwd: './workers/ingestion-worker',
      instances: 2,
      max_memory_restart: '512M'
    },
    {
      name: 'insight-worker',
      script: 'dist/index.js',
      cwd: './workers/insight-worker',
      instances: 1,
      max_memory_restart: '1G'
    },
    {
      name: 'card-worker',
      script: 'dist/index.js',
      cwd: './workers/card-worker',
      instances: 2,
      max_memory_restart: '256M'
    },
    {
      name: 'graph-projection-worker',
      script: 'dist/index.js',
      cwd: './workers/graph-projection-worker',
      instances: 1,
      max_memory_restart: '512M'
    },
    {
      name: 'embedding-worker',
      script: 'dist/index.js',
      cwd: './workers/embedding-worker',
      instances: 2,
      max_memory_restart: '256M'
    },
    {
      name: 'graph-sync-worker',
      script: 'dist/index.js',
      cwd: './workers/graph-sync-worker',
      instances: 1,
      max_memory_restart: '256M'
    },
    {
      name: 'notification-worker',
      script: 'dist/index.js',
      cwd: './workers/notification-worker',
      instances: 1,
      max_memory_restart: '128M'
    },
    {
      name: 'maintenance-worker',
      script: 'dist/index.js',
      cwd: './workers/maintenance-worker',
      instances: 1,
      max_memory_restart: '128M'
    }
  ]
};
```

## **3. V11.0 Development Workflow**

### **3.1 Build Process**

```bash
# Install all dependencies
pnpm install

# Build shared packages first
pnpm --filter @2d1l/shared-types build
pnpm --filter @2d1l/database build
pnpm --filter @2d1l/tool-registry build
pnpm --filter @2d1l/tools build
pnpm --filter @2d1l/ai-clients build
pnpm --filter @2d1l/core-utils build

# Build services as libraries
pnpm --filter @2d1l/dialogue-service build
pnpm --filter @2d1l/user-service build
pnpm --filter @2d1l/card-service build
pnpm --filter @2d1l/config-service build

# Build workers
pnpm --filter "*-worker" build

# Build API Gateway (imports service libraries)
pnpm --filter @2d1l/api-gateway build

# Build frontend
pnpm --filter @2d1l/web-app build
```

### **3.2 Development Server**

```bash
# Start infrastructure
docker-compose up -d

# Start API Gateway (with hot reload)
pnpm --filter @2d1l/api-gateway dev

# Start frontend (in separate terminal)
pnpm --filter @2d1l/web-app dev

# Start workers (in separate terminal)
pnpm --filter "*-worker" dev
```

## **4. V11.0 Key Architectural Changes**

### **4.1 Services as Libraries**
- **Before (V9.5):** Services ran as independent HTTP servers
- **After (V11.0):** Services are TypeScript libraries imported directly by API Gateway
- **Benefit:** Eliminates service-to-service HTTP overhead

### **4.2 Centralized API Layer**
- **Single HTTP Server:** Only `apps/api-gateway` handles HTTP requests
- **Direct Method Calls:** Controllers call service methods directly (e.g., `dialogueAgent.processTurn()`)
- **Simplified Error Handling:** No network-level failures between services

### **4.3 Worker-Only Background Processing**
- **Workers Remain Isolated:** Still run as separate PM2 processes for fault tolerance
- **Queue-Based Communication:** Workers communicate via BullMQ, not HTTP
- **Scalable Processing:** Each worker type can be scaled independently

### **4.4 Dependency Injection**
- **Composition Root:** API Gateway constructs all service dependencies
- **Clean Testing:** Services can be tested as pure libraries
- **Type Safety:** Full TypeScript type checking across service boundaries

## **5. Deployment Commands**

```bash
# Production deployment
pnpm build:all
pnpm db:migrate
pm2 start ecosystem.config.js
docker-compose up -d

# Development
docker-compose up -d
pnpm dev:all

# Testing
pnpm test:unit
pnpm test:integration
pnpm test:e2e
```

This V11.0 architecture maintains all the sophisticated capabilities of the previous system while providing significant performance, development, and operational improvements through the headless service pattern. 