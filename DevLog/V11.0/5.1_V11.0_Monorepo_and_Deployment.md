### **`5.1_V11.0_Monorepo_and_Deployment.md`**

---

# **V11.0 Monorepo Structure and Deployment Strategy**

**Document Version:** 11.0 (Headless Service Architecture)
**Purpose:** To define the complete monorepo structure and deployment architecture for the 2dots1line V11.0 platform, emphasizing the new headless service pattern.

## **1. Monorepo Directory Structure**

```
2D1L/                                      # Root directory
├── apps/                                  # Frontend applications & API Gateway
│   ├── api-gateway/                       # ⭐ MAIN HTTP SERVER (Port 3001)
│   │   ├── src/
│   │   │   ├── app.ts                     # Express app configuration
│   │   │   ├── server.ts                  # Server entry point
│   │   │   ├── controllers/               # REST API controllers
│   │   │   │   ├── conversation.controller.ts    # DIRECT calls to DialogueAgent
│   │   │   │   ├── card.controller.ts
│   │   │   │   ├── user.controller.ts
│   │   │   │   └── graph.controller.ts
│   │   │   ├── middleware/                # Auth, logging, validation
│   │   │   │   ├── auth.middleware.ts
│   │   │   │   ├── logging.middleware.ts
│   │   │   │   └── validation.middleware.ts
│   │   │   └── routes/                    # Route definitions
│   │   │       └── v1/
│   │   │           └── index.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   ├── web-app/                           # Next.js frontend (Port 3000)
│   │   ├── src/
│   │   │   ├── app/                       # App Router pages
│   │   │   ├── components/                # React components
│   │   │   │   ├── 2d-canvas/            # 2D Card Canvas
│   │   │   │   └── 3d-cosmos/            # 3D Knowledge Cosmos
│   │   │   ├── stores/                    # Zustand state management
│   │   │   └── services/                  # API client services
│   │   ├── package.json
│   │   └── next.config.js
│   └── storybook/                         # Component development
│       ├── demo.html
│       └── package.json
├── services/                              # 🚨 V11.0: HEADLESS BUSINESS LOGIC LIBRARIES
│   ├── dialogue-service/                  # DialogueAgent & PromptBuilder (LIBRARY)
│   │   ├── src/
│   │   │   ├── DialogueAgent.ts           # Main agent class
│   │   │   ├── PromptBuilder.ts           # Context compilation
│   │   │   └── index.ts                   # Export main classes
│   │   ├── package.json                   # NO server dependencies
│   │   └── tsconfig.json
│   ├── user-service/                      # User management logic (LIBRARY)
│   │   ├── src/
│   │   │   ├── UserService.ts             # User business logic
│   │   │   ├── AuthService.ts             # Authentication logic
│   │   │   └── index.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   ├── card-service/                      # Card creation logic (LIBRARY)
│   │   ├── src/
│   │   │   ├── CardService.ts
│   │   │   ├── CardFactory.ts
│   │   │   └── index.ts
│   │   └── package.json
│   └── config-service/                    # Configuration management (LIBRARY)
│       ├── src/
│       │   ├── ConfigService.ts
│       │   └── index.ts
│       └── package.json
├── workers/                               # 🔄 STANDALONE WORKER PROCESSES
│   ├── conversation-timeout-worker/       # Redis key expiry listener (PM2)
│   │   ├── src/
│   │   │   ├── ConversationTimeoutWorker.ts
│   │   │   └── index.ts                   # PM2 entry point
│   │   └── package.json
│   ├── ingestion-worker/                  # IngestionAnalyst processor (PM2)
│   │   ├── src/
│   │   │   ├── IngestionAnalyst.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── insight-worker/                    # InsightEngine processor (PM2)
│   │   ├── src/
│   │   │   ├── InsightEngine.ts
│   │   │   ├── InsightDataCompiler.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── card-worker/                       # Card generation processor (PM2)
│   │   ├── src/
│   │   │   ├── CardWorker.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── graph-projection-worker/           # 3D projection processor (PM2)
│   │   ├── src/
│   │   │   ├── GraphProjectionWorker.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── embedding-worker/                  # Vector embedding processor (PM2)
│   │   ├── src/
│   │   │   ├── EmbeddingWorker.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── graph-sync-worker/                 # Neo4j synchronization (PM2)
│   │   ├── src/
│   │   │   ├── GraphSyncWorker.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── notification-worker/               # WebSocket/SSE events (PM2)
│   │   ├── src/
│   │   │   ├── NotificationWorker.ts
│   │   │   └── index.ts
│   │   └── package.json
│   └── maintenance-worker/                # System maintenance (PM2)
│       ├── src/
│       │   ├── MaintenanceWorker.ts
│       │   └── index.ts
│       └── package.json
├── packages/                              # SHARED LIBRARIES & UTILITIES
│   ├── shared-types/                      # TypeScript type definitions
│   │   ├── src/
│   │   │   ├── entities/                  # Database entity types
│   │   │   ├── api/                       # API request/response types
│   │   │   ├── ai/                        # AI-related types
│   │   │   └── index.ts
│   │   └── package.json
│   ├── database/                          # Database layer (Prisma, Neo4j, Weaviate)
│   │   ├── src/
│   │   │   ├── repositories/              # Data access layer
│   │   │   │   ├── UserRepository.ts
│   │   │   │   ├── ConversationRepository.ts
│   │   │   │   ├── MemoryRepository.ts
│   │   │   │   ├── CardRepository.ts
│   │   │   │   ├── ConceptRepository.ts
│   │   │   │   ├── GraphProjectionRepository.ts
│   │   │   │   └── index.ts
│   │   │   ├── services/                  # Database service classes
│   │   │   │   ├── PostgresService.ts
│   │   │   │   ├── Neo4jService.ts
│   │   │   │   └── WeaviateService.ts
│   │   │   ├── prisma-client.ts           # Prisma singleton
│   │   │   ├── DatabaseService.ts         # Main database orchestrator
│   │   │   └── index.ts
│   │   ├── prisma/                        # Prisma schema & migrations
│   │   │   ├── schema.prisma
│   │   │   └── migrations/
│   │   ├── schemas/                       # Non-relational schemas
│   │   │   ├── neo4j.cypher
│   │   │   └── weaviate.json
│   │   └── package.json
│   ├── tool-registry/                     # AI Tool architecture
│   │   ├── src/
│   │   │   ├── ToolRegistry.ts            # Central tool factory
│   │   │   ├── types.ts                   # Tool type definitions
│   │   │   └── index.ts
│   │   └── package.json
│   ├── tools/                             # Individual AI tools
│   │   ├── src/
│   │   │   ├── atomic/                    # Basic tools
│   │   │   │   ├── LLMChatTool.ts
│   │   │   │   └── HybridRetrievalTool.ts
│   │   │   ├── specialized/               # Domain-specific tools
│   │   │   ├── composite/                 # Complex composite tools
│   │   │   │   ├── HolisticAnalysisTool.ts
│   │   │   │   └── StrategicSynthesisTool.ts
│   │   │   └── index.ts
│   │   └── package.json
│   ├── ai-clients/                        # AI service integrations
│   │   ├── src/
│   │   │   ├── google/                    # Gemini client
│   │   │   ├── deepseek/                  # DeepSeek client
│   │   │   └── interfaces/                # Common AI interfaces
│   │   └── package.json
│   ├── core-utils/                        # Shared utilities
│   │   ├── src/
│   │   │   ├── constants.ts
│   │   │   ├── validation/
│   │   │   ├── formatting/
│   │   │   └── security/
│   │   └── package.json
│   ├── ui-components/                     # Shared React components
│   │   ├── src/
│   │   │   ├── primitives/                # Basic UI elements
│   │   │   ├── cards/                     # Card-related components
│   │   │   ├── forms/                     # Form components
│   │   │   └── layouts/                   # Layout components
│   │   └── package.json
│   ├── canvas-core/                       # 3D Canvas utilities
│   │   ├── src/
│   │   │   ├── camera/
│   │   │   ├── lighting/
│   │   │   └── utils/
│   │   └── package.json
│   ├── orb-core/                          # Orb visualization
│   │   ├── src/
│   │   │   ├── base/
│   │   │   ├── effects/
│   │   │   ├── emotions/
│   │   │   └── states/
│   │   └── package.json
│   └── shader-lib/                        # GLSL shader library
│       ├── src/
│       │   ├── shaders/
│       │   └── generated/
│       └── package.json
├── py-services/                           # PYTHON MICROSERVICES
│   └── dimension-reducer/                 # UMAP/t-SNE service (Port 5001)
│       ├── app.py                         # FastAPI server
│       ├── Dockerfile
│       ├── requirements.txt
│       └── pyproject.toml
├── config/                                # CONFIGURATION FILES
│   ├── card_eligibility_rules.json
│   ├── card_templates.json
│   ├── challenges.json
│   ├── prompt_templates.yaml
│   ├── tsconfig/
│   │   └── base.json                      # Shared TypeScript config
│   └── ...
├── 3d-assets/                             # 3D ASSETS
│   ├── models/
│   ├── textures/
│   ├── materials/
│   └── environment-maps/
├── __tests__/                             # TEST SUITES
│   ├── integration/
│   ├── loops/                             # System loop tests
│   │   ├── 1-conversation-loop/
│   │   ├── 2-fast-loop/
│   │   ├── 3-presentation-loop/
│   │   └── 4-slow-loop/
│   └── setup.ts
├── scripts/                               # AUTOMATION SCRIPTS
├── docs/                                  # DOCUMENTATION
├── DevLog/                                # DEVELOPMENT LOG
│   ├── V11.0/                             # ← Current specification documents
│   └── ...
├── infrastructure/                        # INFRASTRUCTURE AS CODE
├── docker-compose.yml                     # V11.0: Only infrastructure services
├── docker-compose.dev.yml                # Development overrides
├── ecosystem.config.js                   # PM2 configuration
├── package.json                          # Root package.json
├── pnpm-workspace.yaml                   # Workspace configuration
├── pnpm-lock.yaml                        # Lock file
└── tsconfig.json                         # Root TypeScript config
```

## **2. V11.0 Deployment Architecture**

### **2.1 Running Processes (Production)**

```yaml
PROCESSES:
  api-gateway:              # Port 3001 (HTTP Server)
    type: "http-server"
    pm2: true
    replicas: 2
    memory: "512MB"
    
  web-app:                  # Port 3000 (Static/SSR)
    type: "frontend"
    pm2: true
    replicas: 1
    memory: "256MB"
    
  workers:                  # Background job processors
    conversation-timeout-worker:
      pm2: true
      instances: 1
      memory: "128MB"
    ingestion-worker:
      pm2: true
      instances: 2
      memory: "512MB"
    insight-worker:
      pm2: true
      instances: 1
      memory: "1GB"
    card-worker:
      pm2: true
      instances: 2
      memory: "256MB"
    graph-projection-worker:
      pm2: true
      instances: 1
      memory: "512MB"
    embedding-worker:
      pm2: true
      instances: 2
      memory: "256MB"
    graph-sync-worker:
      pm2: true
      instances: 1
      memory: "256MB"
    notification-worker:
      pm2: true
      instances: 1
      memory: "128MB"
    maintenance-worker:
      pm2: true
      instances: 1
      memory: "128MB"

INFRASTRUCTURE_SERVICES:
  postgresql:               # Port 5432
    docker: true
    volumes: ["./postgres_data:/var/lib/postgresql/data"]
    
  neo4j:                    # Ports 7474, 7687
    docker: true
    volumes: ["./neo4j_data:/data"]
    
  weaviate:                 # Port 8080
    docker: true
    volumes: ["./weaviate_data:/var/lib/weaviate"]
    
  redis:                    # Port 6379
    docker: true
    volumes: ["./redis_data:/data"]
    
  dimension-reducer:        # Port 5001 (Python FastAPI)
    docker: true
    type: "python-service"
```

### **2.2 V11.0 Docker Compose Configuration**

```yaml
# docker-compose.yml (V11.0 - Infrastructure Only)
version: '3.8'

services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: twodots1line
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dev_password
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5.11
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/dev_password
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
    volumes:
      - ./neo4j_data:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p dev_password 'MATCH (n) RETURN count(n) LIMIT 1'"]
      interval: 30s
      timeout: 10s
      retries: 5

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.24.1
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: 'text2vec-openai,text2vec-cohere,text2vec-huggingface,ref2vec-centroid,generative-openai,qna-openai'
      CLUSTER_HOSTNAME: 'node1'
    volumes:
      - ./weaviate_data:/var/lib/weaviate

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data
    command: redis-server --appendonly yes

  dimension-reducer:
    build: ./py-services/dimension-reducer
    ports:
      - "5001:5001"
    environment:
      - ENVIRONMENT=development
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  default:
    name: twodots1line_network
```

### **2.3 PM2 Ecosystem Configuration (V11.0)**

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    // Main HTTP Server
    {
      name: 'api-gateway',
      script: 'dist/server.js',
      cwd: './apps/api-gateway',
      instances: 2,
      exec_mode: 'cluster',
      max_memory_restart: '512M',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      }
    },
    
    // Frontend Application  
    {
      name: 'web-app',
      script: 'npm run start',
      cwd: './apps/web-app',
      instances: 1,
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    },
    
    // Background Workers
    {
      name: 'conversation-timeout-worker',
      script: 'dist/index.js',
      cwd: './workers/conversation-timeout-worker',
      instances: 1,
      max_memory_restart: '128M'
    },
    {
      name: 'ingestion-worker',
      script: 'dist/index.js',
      cwd: './workers/ingestion-worker',
      instances: 2,
      max_memory_restart: '512M'
    },
    {
      name: 'insight-worker',
      script: 'dist/index.js',
      cwd: './workers/insight-worker',
      instances: 1,
      max_memory_restart: '1G'
    },
    {
      name: 'card-worker',
      script: 'dist/index.js',
      cwd: './workers/card-worker',
      instances: 2,
      max_memory_restart: '256M'
    },
    {
      name: 'graph-projection-worker',
      script: 'dist/index.js',
      cwd: './workers/graph-projection-worker',
      instances: 1,
      max_memory_restart: '512M'
    },
    {
      name: 'embedding-worker',
      script: 'dist/index.js',
      cwd: './workers/embedding-worker',
      instances: 2,
      max_memory_restart: '256M'
    },
    {
      name: 'graph-sync-worker',
      script: 'dist/index.js',
      cwd: './workers/graph-sync-worker',
      instances: 1,
      max_memory_restart: '256M'
    },
    {
      name: 'notification-worker',
      script: 'dist/index.js',
      cwd: './workers/notification-worker',
      instances: 1,
      max_memory_restart: '128M'
    },
    {
      name: 'maintenance-worker',
      script: 'dist/index.js',
      cwd: './workers/maintenance-worker',
      instances: 1,
      max_memory_restart: '128M'
    }
  ]
};
```

## **3. V11.0 Development Workflow**

### **3.1 Build Process**

```bash
# Install all dependencies
pnpm install

# Build shared packages first
pnpm --filter @2d1l/shared-types build
pnpm --filter @2d1l/database build
pnpm --filter @2d1l/tool-registry build
pnpm --filter @2d1l/tools build
pnpm --filter @2d1l/ai-clients build
pnpm --filter @2d1l/core-utils build

# Build services as libraries
pnpm --filter @2d1l/dialogue-service build
pnpm --filter @2d1l/user-service build
pnpm --filter @2d1l/card-service build
pnpm --filter @2d1l/config-service build

# Build workers
pnpm --filter "*-worker" build

# Build API Gateway (imports service libraries)
pnpm --filter @2d1l/api-gateway build

# Build frontend
pnpm --filter @2d1l/web-app build
```

### **3.2 Development Server**

```bash
# Start infrastructure
docker-compose up -d

# Start API Gateway (with hot reload)
pnpm --filter @2d1l/api-gateway dev

# Start frontend (in separate terminal)
pnpm --filter @2d1l/web-app dev

# Start workers (in separate terminal)
pnpm --filter "*-worker" dev
```

## **4. V11.0 Key Architectural Changes**

### **4.1 Services as Libraries**
- **Before (V9.5):** Services ran as independent HTTP servers
- **After (V11.0):** Services are TypeScript libraries imported directly by API Gateway
- **Benefit:** Eliminates service-to-service HTTP overhead

### **4.2 Centralized API Layer**
- **Single HTTP Server:** Only `apps/api-gateway` handles HTTP requests
- **Direct Method Calls:** Controllers call service methods directly (e.g., `dialogueAgent.processTurn()`)
- **Simplified Error Handling:** No network-level failures between services

### **4.3 Worker-Only Background Processing**
- **Workers Remain Isolated:** Still run as separate PM2 processes for fault tolerance
- **Queue-Based Communication:** Workers communicate via BullMQ, not HTTP
- **Scalable Processing:** Each worker type can be scaled independently

### **4.4 Dependency Injection**
- **Composition Root:** API Gateway constructs all service dependencies
- **Clean Testing:** Services can be tested as pure libraries
- **Type Safety:** Full TypeScript type checking across service boundaries

## **5. Deployment Commands**

```bash
# Production deployment
pnpm build:all
pnpm db:migrate
pm2 start ecosystem.config.js
docker-compose up -d

# Development
docker-compose up -d
pnpm dev:all

# Testing
pnpm test:unit
pnpm test:integration
pnpm test:e2e
```

This V11.0 architecture maintains all the sophisticated capabilities of the previous system while providing significant performance, development, and operational improvements through the headless service pattern. 