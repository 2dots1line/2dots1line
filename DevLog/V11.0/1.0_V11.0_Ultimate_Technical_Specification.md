### **`1.0_V11.0_Ultimate_Technical_Specification.md`**

---

# **2dots1line V11.0 Ultimate Technical Specification**

**Document Version:** 11.0 (Headless Service Architecture)
**Date:** January 2025
**Authors:** AI Collaboration with Human Direction

## **1. Executive Summary**

The 2dots1line System is a production-grade knowledge graph platform designed to help users define their identity, find their voice, and build profound connections with their inner self and the world. It transforms a continuous stream of user inputs into a rich, interconnected personal knowledge model, presented through a dual-interface system: an intuitive, serendipitous **2D Card Canvas** and an immersive, explorable **3D Knowledge Cosmos**.

This V11.0 specification represents the definitive architecture for the platform, built on the **Headless Service** model. It establishes a robust, scalable system built on key pillars:
1.  A **single API Gateway** (`apps/api-gateway`) that handles all HTTP requests and orchestrates business logic through direct method calls to headless services.
2.  **Headless Services** (`services/*`) that are pure business logic libraries imported directly by the API Gateway, eliminating inter-service HTTP communication.
3.  A **three-agent cognitive model** (`DialogueAgent`, `IngestionAnalyst`, `InsightEngine`) operating on distinct timescales for real-time interaction, post-conversation synthesis, and long-term strategic insight.
4.  **Asynchronous Workers** (`workers/*`) managed by PM2 that consume jobs from queues for background processing.
5.  **Centralized Dependency Injection** in the API Gateway's composition root for clean separation of concerns.

This architecture supports a product that not only facilitates deep reflection but also provides a powerful, multi-faceted exploratory interface into the user's personal knowledge graph while maintaining optimal performance and scalability through the headless service pattern.

### **Core V11.0 Capabilities:**

*   **Unified HTTP Interface:** Single API Gateway handles all external requests, eliminating service-to-service HTTP overhead.
*   **Dual UI Paradigm:**
    *   **2D Card Canvas:** An "infinite" grid of cards designed for serendipitous discovery and focused interaction.
    *   **3D Knowledge Cosmos:** An immersive, explorable 3D space where knowledge nodes are visually positioned based on their semantic similarity (vector projection), allowing for holistic pattern recognition.
*   **Three-Agent Cyclical Pipeline:** A dual-loop system where a "fast loop" (`IngestionAnalyst`) processes individual conversations tactically, and a "slow loop" (`InsightEngine`) performs strategic, global analysis of the user's knowledge graph over a configurable "cycle."
*   **Decoupled Presentation Layer:** Dedicated workers (`CardWorker`, `GraphProjectionWorker`) are solely responsible for preparing and creating the data for the 2D and 3D user interfaces, decoupling presentation from core knowledge generation.
*   **Interactive Card System:** The `Card` is a first-class, persistent entity that acts as a stable anchor for the UI and a canvas for initiating new, context-specific conversations.
*   **Configuration-Driven Logic:** Key business logic, including card eligibility rules and the `CoreIdentity` of the AI, is managed in external configuration files for rapid iteration.
*   **Context-Aware AI Interrogation:** The `DialogueAgent` can field user queries within the 3D Cosmos, retrieving relevant information and generating UI commands to visually highlight corresponding nodes in the graph.

## **2. V11.0 Foundational Principles**

1.  **Single Gateway, Headless Services:** All external HTTP traffic flows through one API Gateway which orchestrates headless service libraries through direct method calls.
2.  **Dual Interface, Unified Knowledge:** The user can explore their single knowledge graph through two distinct but complementary interfaces: the serendipitous 2D Card Canvas and the structural 3D Knowledge Cosmos.
3.  **The Card is the UI Anchor:** In the 2D view, the persistent `Card` entity is the stable unit of interaction.
4.  **The Projection is the Map:** In the 3D view, a pre-computed, versioned JSON projection of the graph is the data source, ensuring high performance.
5.  **Separation of Concerns:** Knowledge generation (`IngestionAnalyst`, `InsightEngine`) is fully decoupled from presentation generation (`CardWorker`, `GraphProjectionWorker`).
6.  **Cyclical & Asynchronous Processing:** The system operates on distinct, asynchronous loops for real-time interaction, post-conversation analysis, cyclical insight, and graph projection, ensuring scalability and responsiveness.
7.  **Configuration over Schema:** Business rules are defined in external files for maximum flexibility.
8.  **Secure, Tool-Driven AI:** The `DialogueAgent` uses a robust `HybridRetrievalTool` and structured UI action outputs to interact with the knowledge graph, avoiding the direct generation of database queries by the LLM.

## **3. System Architecture Overview (V11.0)**

The V11.0 architecture demonstrates the **Headless Service** pattern where all HTTP handling is centralized in the API Gateway, which directly orchestrates pure business logic libraries.

```
┌─────────────────────────────────────────────────────────────────┐
│                 apps/api-gateway (Single HTTP Server)          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ConversationCtrl│  │ AuthController │  │ CardController │ ...etc │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
└─────────┼─────────────────┼─────────────────┼─────────────────┘
          │ (Direct Method Calls / Dependency Injection)        
┌─────────▼─────────┐ ┌─────────▼─────────┐ ┌─────────▼─────────┐
│ dialogue-service  │ │   user-service    │ │   card-service    │
│ (Headless Library)│ │(Headless Library) │ │(Headless Library) │
└───────────────────┘ └───────────────────┘ └───────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                       USER INTERFACE LAYER (Web/Mobile)                       │
│ ┌──────────────────────────────────┐  ┌─────────────────────────────────────┐ │
│ │     2D Card Canvas               │  │    3D Knowledge Cosmos              │ │
│ │ (Fetches from API Gateway)       │  │ (Fetches Graph Projection from API)   │ │
│ └─────────────────┬────────────────┘  └───────────────────┬─────────────────┘ │
└───────────────────┼─────────────────────────────────────┼─────────────────────┘
                    │ (API: /api/v1/cards, /api/v1/conversations) │ (API: /api/v1/graph-projection)
                    └─────────────────┬─────────────────────────────┘
                                     ▼
            ┌─────────────────────────────────────────────────────────┐
            │             API GATEWAY ORCHESTRATION                   │
            │     (Direct calls to headless service libraries)       │
            └─────────────────────┬───────────────────────────────────┘
                                 │ Publishes events to queues
                                 ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                     ASYNCHRONOUS WORKER PROCESSES                             │
│ ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐         │
│ │ Ingestion Analyst│  │ Insight Engine   │  │ Graph Projection     │         │
│ │ (Worker)         │  │ (Worker)         │  │        Worker        │         │
│ │(Fast Loop: Post-Convo)│ (Slow Loop: Post-Cycle)│ (Runs UMAP/t-SNE)    │         │
│ └────────┬─────────┘  └────────┬─────────┘  └──────────────────────┘         │
│          │                     │                                             │
│ ┌────────▼─────────────────────▼─────────┐  ┌──────────────────────┐         │
│ │         Card & Graph Queue            │  │    Card Worker       │         │
│ │           (Redis/BullMQ)              │  │                      │         │
│ └───────────────────────────────────────┘  └──────────────────────┘         │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                   │
┌──────────────────────────────────▼──────────────────────────────────────────┐
│                             PERSISTENCE LAYER                               │
│ ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐         │
│ │ PostgreSQL │   │   Neo4j    │   │  Weaviate  │   │   Redis    │         │
│ └────────────┘   └────────────┘   └────────────┘   └────────────┘         │
└───────────────────────────────────────────────────────────────────────────┘
```

## **4. Modular Specification Structure**

This document serves as the high-level overview. The complete V11.0 architecture is detailed across the following 12 modular, canonical specification documents:

| Document ID                                             | Document Title                                              | Purpose                                                                                                                                                                                                                                                                                              |
| :------------------------------------------------------ | :---------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`1.0_V11.0_Ultimate_Technical_Specification.md`**      | Ultimate Technical Specification                            | **(This Document)** The high-level entry point, system overview, and table of contents for the entire V11.0 architecture.                                                                                                                                                                               |
| **`1.1_V11.0_System_Flows_and_Data_Propagation.md`**     | System Flows and Data Propagation                           | Provides detailed flowcharts and step-by-step descriptions of the **four** primary system loops (Real-Time Conversation, Fast Loop Ingestion, Presentation Loop, and Slow Loop Insight), showing how data and context move between components in the headless service architecture.                                                              |
| **`2.1_V11.0_DialogueService_and_Dependencies.md`**       | `DialogueService` & Dependencies                           | A deep dive into the headless `dialogue-service` library, including `DialogueAgent` and `PromptBuilder`, their dependency injection patterns, and integration with the API Gateway.                                                                                                   |
| **`2.2_V11.0_IngestionAnalyst_and_Tools.md`**            | `IngestionAnalyst` & Tools                                  | A detailed specification for the asynchronous `IngestionAnalyst` worker, its "Single Synthesis Call," and how it publishes events for downstream workers.                                                                                                                                                  |
| **`2.3_V11.0_InsightEngine_and_Tools.md`**               | `InsightEngine` & Tools                                     | A deep dive into the strategic `InsightEngine` worker, its cyclical analysis, and its outputs. This document now references its key dependencies like `InsightDataCompiler`.                                                                                                                        |
| **`2.3.1_V11.0_InsightDataCompiler.md`**                 | `InsightDataCompiler`                                       | A dedicated guide for the `InsightDataCompiler` module, defining its responsibility to build the three distinct input packages (`IngestionActivitySummary`, `GraphAnalysisPackage`, `StrategicInsightPackage`) for the `InsightEngine`.                                                              |
| **`2.4_V11.0_CardWorker_and_CardFactory.md`**            | `CardWorker` & `CardFactory`                                | A dedicated guide for the `CardWorker`, detailing how it consumes events, uses the `CardFactory` service, and creates `Card` records.                                                                                                                                                               |
| **`2.5_V11.0_3D_Cosmos_and_Data_Pipeline.md`**           | 3D Cosmos & Data Pipeline                                   | A dedicated guide for the 3D Knowledge Cosmos, detailing the `GraphProjectionWorker`'s data pipeline, the API for serving projection data, and the frontend's responsibilities.                                                                                                                   |
| **`3.1_V11.0_Database_Schema_Unified.md`**               | Database Schema (Unified)                                   | The single source of truth for all database schemas, including the `user_graph_projections` table and the unified `InteractionLog`.                                                                                                                                                                |
| **`3.2_V11.0_Context_Packages_and_State.md`**            | Context Packages & State                                    | A detailed manifest of every `Context Package` (e.g., `UserMemoryProfile`), defining its structure, persistence location, and read/write access by agents.                                                                                                                                            |
| **`3.3_V11.0_Event_Queue_Contracts.md`**                 | Event Queue Contracts                                       | The canonical specification for all event types, payload schemas, and worker consumption patterns used in the `card-and-graph-queue`.                                                                                                                                                         |
| **`4.1_V11.0_Tooling_Architecture_and_Registry.md`**     | Tooling Architecture & `ToolRegistry`                       | Defines the V11.0 "Configurable Composite Tool" architecture, the role of the `ToolRegistry`, and a catalog of all tools in the system.                                                                                                                                                                |
| **`5.1_V11.0_Monorepo_and_Deployment.md`**                 | Monorepo & Deployment                                       | The definitive V11.0 file-level monorepo structure, updated to reflect the headless service architecture pattern.                                                                                                                                                  |

## **5. V11.0 Key Architectural Changes**

### **5.1 Headless Service Pattern**
- **Single HTTP Entry Point:** Only `apps/api-gateway` runs an HTTP server
- **Direct Library Imports:** Services are imported as TypeScript libraries, not called via HTTP
- **Centralized Dependency Injection:** All service dependencies are resolved in the API Gateway's composition root
- **Eliminated Service-to-Service HTTP:** No more inter-service HTTP communication overhead

### **5.2 Simplified Deployment Model**
- **API Gateway:** Single HTTP server process
- **Workers:** Standalone PM2-managed processes for background jobs
- **No Service Servers:** `dialogue-service`, `user-service`, etc. are libraries, not processes

### **5.3 Enhanced Performance**
- **Reduced Latency:** Direct method calls instead of HTTP requests
- **Simplified Error Handling:** No network-level failures between services
- **Streamlined Testing:** Easier to mock and test individual service components
- **Lower Resource Usage:** Fewer running processes and network connections

This V11.0 architecture maintains all the cognitive and knowledge graph capabilities of V9.5 while providing a more efficient, maintainable, and scalable foundation for the 2dots1line platform. 