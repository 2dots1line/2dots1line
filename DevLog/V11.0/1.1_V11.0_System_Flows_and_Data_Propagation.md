### **`1.1_V11.0_System_Flows_and_Data_Propagation.md`**

---

# **V11.0 System Flows and Data Propagation**

**Document Version:** 11.0 (Headless Service Architecture)
**Purpose:** To provide a detailed, step-by-step visual and textual description of the primary data flows and agent interactions within the 2dots1line V11.0 architecture. This document answers the question: "What happens when...?" in the context of the new headless service model.

## **1. Introduction**

The V11.0 architecture operates on four distinct but interconnected process flows, now optimized with the **Headless Service** pattern. These flows ensure a responsive user experience while allowing for deep, asynchronous analysis and presentation layer generation.

1.  **The Real-Time Conversation Loop:** The immediate, turn-by-turn interaction between the user and the `DialogueAgent` (now executed as direct method calls within the API Gateway).
2.  **The Fast Loop (Post-Conversation Ingestion):** The asynchronous processing of a completed conversation by the `IngestionAnalyst` to create structured knowledge.
3.  **The Presentation Loop (Card & Graph Generation):** The asynchronous creation of UI-ready data by the `CardWorker` and `GraphProjectionWorker`, triggered by events from the Fast and Slow Loops.
4.  **The Slow Loop (Cyclical Insight):** The periodic, deep analysis of the user's entire knowledge graph by the `InsightEngine`.

---

## **2. Flow 1: The Real-Time Conversation Loop (V11.0 Headless)**

**Objective:** To provide a single, coherent, context-aware response to a user's message in real-time.
**Primary Actor:** API Gateway Controller directly calling `DialogueAgent` library methods

```
                                               ┌───────────────────────────────┐
                                               │      USER INTERFACE LAYER     │
                                               └───────────────┬───────────────┘
                                                               │ 1. User sends message
                                                               │    (POST /api/v1/conversations/messages)
                                                               │    Payload: { message_content, source_card_id?, ui_context? }
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │ API Gateway - ConversationCtrl│
                                               │ - Finds/creates Conversation  │
                                               │ - Logs user's message to DB   │
                                               │ - Sets Redis timeout key:     │
                                               │   `conversation:timeout:{id}` │
                                               │ - DIRECT CALL to DialogueAgent│
                                               └───────────────┬───────────────┘
                                                               │ 2. dialogueAgent.processTurn()
                                                               │    (Same-process method call)
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │   DialogueAgent (Library)     │
                                               │ - Uses injected PromptBuilder │
                                               │ - Uses injected HRT, LLM tools│
                                               └───────────────┬───────────────┘
                                                               │ 3. Calls promptBuilder.buildPrompt()
                                                               │    (fetches UserProfile, KGS, History, etc.)
                                                               │
                                                               │ 4. Makes "Single Synthesis" LLM call
                                                               │    (LLM decides `query_memory` or `respond_directly`)
                                                               │
                  ┌────────────────────────────────────────────┴────────────────────────────────────────────┐
                  │                                                                                         │
       IF `decision === 'query_memory'`                                                          IF `decision === 'respond_directly'`
                  │                                                                                         │
                  │ 5a. Extracts `key_phrases` from LLM output.                                             │
                  │                                                                                         │
                  │ 5b. Calls hybridRetrievalTool.execute({ key_phrases })                                  │
                  │     ┌─────────────────────┐                                                             │
                  │     │ HybridRetrievalTool │                                                             │
                  │     │ (Weaviate->Neo4j->PG)│                                                             │
                  │     └─────────┬───────────┘                                                             │
                  │               │ 5c. Returns `AugmentedMemoryContext`                                    │
                  │               ▼                                                                         │
                  │ 5d. Makes 2nd LLM call with `AugmentedMemoryContext`                                    │
                  │     to generate final response text and UI actions.                                     │
                  │                                                                                         │
                  └────────────────────────────────────────────┬────────────────────────────────────────────┘
                                                               │ 6. Returns structured response object
                                                               │    { response_text, ui_actions }
                                                               │
                                                               │ 7. Controller saves turn context to Redis
                                                               │    and logs assistant message to DB
                                                               │
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │ API Gateway - ConversationCtrl│
                                               │ - Logs assistant's message    │
                                               │ - Returns response to client  │
                                               │ - Publishes events if needed  │
                                               └───────────────┬───────────────┘
                                                               │ 8. Final JSON response sent to UI
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │      USER INTERFACE LAYER     │
                                               │ (Displays text & executes UI actions) │
                                               └───────────────────────────────┘
```

**Key V11.0 Changes:**
- **No Service-to-Service HTTP:** Controller directly calls `dialogueAgent.processTurn()` as a library method
- **Centralized Error Handling:** All errors handled within the API Gateway process
- **Direct Database Access:** Controller manages conversation logging and Redis operations
- **Same-Process Efficiency:** No network overhead between conversation controller and DialogueAgent

---

## **3. Flow 2: The Fast Loop (Post-Conversation Ingestion)**

**Objective:** To analyze a completed conversation and transform it into structured knowledge entities.
**Primary Actor:** `IngestionAnalyst` (Worker)

```
                                       ┌────────────────────────────────────┐
                                       │   conversation-timeout-worker      │
                                       │ (Listens for Redis Key Expiry)     │
                                       └───────────────────┬──────────────────┘
                                                           │ 1. `conversation:timeout:{convoId}` key expires.
                                                           │
                                                           │ 2. Worker updates Conversation status to 'ended' in PG.
                                                           │
                                                           │ 3. Worker adds a job to the `ingestion-queue`.
                                                           │    Job Payload: { conversationId, userId }
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │      `ingestion-queue` (BullMQ)    │
                                       └───────────────────┬──────────────────┘
                                                           │ 4. `ingestion-worker` picks up job.
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │    IngestionAnalyst Worker         │
                                       │ (Standalone PM2 Process)           │
                                       └───────────────────┬──────────────────┘
                                                           │ 5. Gathers all data for its "Single Synthesis Call":
                                                           │    - Fetches FullConversationTranscript (PG)
                                                           │    - Fetches UserMemoryProfile & KnowledgeGraphSchema (PG)
                                                           │
                                                           │ 6. Calls holisticAnalysisTool.execute()
                                                           │
                                                           │ 7. Receives structured JSON with `persistence_payload`
                                                           │    and `forward_looking_context`.
                                                           │
                 ┌─────────────────────────────────────────┴─────────────────────────────────────────┐
                 │                                                                                   │
      8a. PERSISTS `persistence_payload`                                     8b. PERSISTS `forward_looking_context`
                 │                                                                                   │
                 ▼                                                                                   ▼
   ┌───────────────────────────────┐                                                     ┌──────────────────────────┐
   │         POSTGRESQL            │                                                     │        POSTGRESQL        │
   │ - Updates Conversation summary│                                                     │ - Updates User.next_     │
   │ - Creates new MemoryUnits     │                                                     │   conversation_context_  │
   │ - Creates new Concepts        │                                                     │   package               │
   │ - Creates new GrowthEvents    │                                                     └──────────────────────────┘
   └──────────────┬────────────────┘
                  │
   ┌──────────────▼────────────────┐
   │            NEO4J              │
   │ - Creates new :MemoryUnit nodes│
   │ - Creates new :Concept nodes   │
   │ - Creates new :RELATED_TO, etc.│
   │   relationships                │
   └──────────────┬────────────────┘
                  │
   ┌──────────────▼────────────────┐
   │            WEAVIATE           │
   │ - Creates vector embeddings for│
   │   new content (UserKnowledgeItems)│
   └──────────────┬────────────────┘
                  │
                  │ 9. Gathers all newly created, persistent entities
                  │    (MemoryUnits, Concepts).
                  │
                  │ 10. PUBLISHES EVENT(S)
                  ▼
   ┌────────────────────────────────────┐
   │       `card-and-graph-queue`       │
   │ Event: { type: "new_entities_created", userId, entities: [...] } │
   └────────────────────────────────────┘
```

---

## **4. Flow 3: The Presentation Loop (Card & Graph Generation)**

**Objective:** To create the UI-ready data for the 2D Card Canvas and the 3D Knowledge Cosmos, based on events from the Fast and Slow loops.
**Primary Actors:** `CardWorker`, `GraphProjectionWorker`

```
                            ┌────────────────────────────────────┐
                            │       `card-and-graph-queue`       │
                            │ Event: { type: "...", userId, data: ... } │
                            └───────────────────┬──────────────────┘
                                                │ 1. Event published by IngestionAnalyst or InsightEngine
                                                │
                 ┌──────────────────────────────┴──────────────────────────────┐
                 │                                                             │
      2a. `card-worker` subscribes                                2b. `graph-projection-worker` subscribes
                 │     (if event type is relevant)                             │     (if event type requires projection update)
                 │                                                             │
                 ▼                                                             ▼
   ┌───────────────────────────┐                                 ┌───────────────────────────┐
   │       CardWorker          │                                 │  GraphProjectionWorker    │
   │ (Standalone PM2 Process)  │                                 │ (Standalone PM2 Process)  │
   └───────────┬───────────────┘                                 └───────────┬───────────────┘
               │ 3a. For each entity in event payload...                     │ 3b. Fetches latest graph structure (Neo4j)
               │                                                             │     and vectors (Weaviate).
               │ 4a. Uses injected CardFactory.createCard()                  │
               │     which checks `card_eligibility_rules.json`              │ 4b. Calls Python dimension reducer service
               │                                                             │     (UMAP/t-SNE) to get 3D coordinates.
               │ 5a. If eligible, creates new `Card` record.                 │
               │                                                             │ 5b. Saves the complete projection data.
               ▼                                                             ▼
   ┌───────────────────────────┐                                 ┌───────────────────────────┐
   │         POSTGRESQL        │                                 │         POSTGRESQL        │
   │  - New record in `cards`  │                                 │  - Updates `user_graph_   │
   │    table with display_data│                                 │    projections` table     │
   └───────────────────────────┘                                 └───────────────────────────┘
               │                                                             │
               │ 6a. PUBLISHES NEW EVENT                                      │ 6b. PUBLISHES NEW EVENT
               ▼                                                             ▼
   ┌───────────────────────────┐                                 ┌───────────────────────────┐
   │    WebSocket/SSE Event    │                                 │    WebSocket/SSE Event    │
   │ "new_card_available"      │                                 │ "graph_projection_updated"│
   │ → Frontend updates 2D view│                                 │ → Frontend updates 3D view│
   └───────────────────────────┘                                 └───────────────────────────┘
```

---

## **5. Flow 4: The Slow Loop (Cyclical Insight)**

**Objective:** To perform deep, strategic analysis of the user's complete knowledge graph and update the user's memory profile.
**Primary Actor:** `InsightEngine` (Worker)

```
                                       ┌────────────────────────────────────┐
                                       │     Insight Cycle Trigger          │
                                       │ (Scheduled job or threshold-based) │
                                       └───────────────────┬──────────────────┘
                                                           │ 1. Cycle timer or activity threshold reached
                                                           │
                                                           │ 2. Adds job to the `insight-queue`.
                                                           │    Job Payload: { userId, cycleType }
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │        `insight-queue` (BullMQ)    │
                                       └───────────────────┬──────────────────┘
                                                           │ 3. `insight-worker` picks up job.
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │     InsightEngine Worker           │
                                       │ (Standalone PM2 Process)           │
                                       └───────────────────┬──────────────────┘
                                                           │ 4. Calls InsightDataCompiler to gather:
                                                           │    - IngestionActivitySummary
                                                           │    - GraphAnalysisPackage  
                                                           │    - StrategicInsightPackage
                                                           │
                                                           │ 5. Calls strategicSynthesisTool.execute()
                                                           │
                                                           │ 6. Receives comprehensive insight output
                                                           │
                 ┌─────────────────────────────────────────┴─────────────────────────────────────────┐
                 │                                                                                   │
      7a. UPDATES USER MEMORY PROFILE                                     7b. UPDATES KNOWLEDGE GRAPH SCHEMA
                 │                                                                                   │
                 ▼                                                                                   ▼
   ┌───────────────────────────────┐                                                     ┌──────────────────────────┐
   │         POSTGRESQL            │                                                     │        POSTGRESQL        │
   │ - Updates User.memory_profile │                                                     │ - Updates User.knowledge_│
   │   with strategic insights     │                                                     │   graph_schema          │
   │ - Updates growth trajectories │                                                     │ - Updates query patterns│
   └───────────────────────────────┘                                                     └──────────────────────────┘
                                                                                                   │
                                                                                                   │ 8. PUBLISHES EVENT
                                                                                                   ▼
                                                                           ┌──────────────────────────┐
                                                                           │  `card-and-graph-queue` │
                                                                           │ Event: "cycle_artifacts_ │
                                                                           │ created" → triggers new  │
                                                                           │ card generation          │
                                                                           └──────────────────────────┘
```

## **6. V11.0 Architectural Benefits**

### **6.1 Performance Improvements**
- **Reduced Latency:** Flow 1 now uses direct method calls instead of HTTP requests
- **Lower Resource Usage:** Fewer running processes (only API Gateway + Workers)
- **Simplified Error Handling:** No network-level failures between services

### **6.2 Development Benefits**
- **Easier Testing:** Services can be tested as libraries with direct mocking
- **Simplified Debugging:** Single process for real-time conversation handling
- **Cleaner Dependencies:** Centralized dependency injection in API Gateway

### **6.3 Operational Benefits**
- **Simplified Deployment:** Only API Gateway and workers need to be deployed as processes
- **Better Resource Control:** Fine-grained control over process allocation
- **Improved Monitoring:** Centralized logging and metrics in API Gateway

This V11.0 flow architecture maintains all the sophisticated cognitive capabilities of V9.5 while providing significant performance and operational improvements through the headless service pattern. 