# 2D1L: Simple & Reliable China Model Toggle Approach

## Objective
Enable the 2D1L monorepo to use China-compatible AI models (e.g., DeepSeek, Qwen) **without breaking the current pipeline**, while maintaining the ability to quickly and manually switch between China and non-China (e.g., Google Gemini) model ecosystems.

---

## 1. Core Principle
- **Manual configuration is the source of truth.**
- No auto-detection or network probing in the initial phase.
- All model selection logic is driven by a single environment variable.

---

## 2. Implementation Steps

### **Step 1: Add a Region Variable to `.env`**
```env
MODEL_REGION=global   # or 'china'
```
- `global` = Use Google Gemini and other non-China models
- `china`  = Use DeepSeek, Qwen, and other China-accessible models

### **Step 2: Centralize Model Selection Logic**
- In `services/config-service/src/ModelConfigService.ts` (or equivalent):
  - Read `MODEL_REGION` from environment
  - Load the appropriate model config file (e.g., `config/gemini_models.json` for global, `config/china_models.json` for China)
  - Expose a single API for all services/workers to get the correct model for each use case

### **Step 3: Update All AI Client Instantiations**
- Refactor all places where models are selected/used to go through the centralized config service
- **No hardcoded model names or API keys in business logic**

### **Step 4: Prepare China-Compatible Model Config**
- Create `config/china_models.json` mirroring the structure of `gemini_models.json`, but with DeepSeek/Qwen/etc. model names and API keys

### **Step 5: Document the Switch Process**
- To switch regions, update `.env` and restart the relevant services:
  - `MODEL_REGION=china pnpm start` (or via deployment config)

---

## 3. Example: ModelConfigService Pseudocode
```typescript
const region = process.env.MODEL_REGION || 'global';
const modelConfig = require(region === 'china' ? '../../config/china_models.json' : '../../config/gemini_models.json');

export function getModel(type: 'llm' | 'embedding' | 'vision' | 'audio') {
  return modelConfig[type];
}
```

---

## 4. Benefits
- **No breakage:** Existing pipeline remains stable
- **Fast switching:** Change one variable, restart, done
- **Transparent:** Easy to debug and operate
- **Extensible:** Can add auto-detection or more regions later

---

## 5. Next Steps
- [ ] Implement the above steps in the codebase
- [ ] Prepare and test `china_models.json`
- [ ] Document any model-specific caveats (embedding dimensions, JSON formatting, etc.) in the config files

---

## 6. Notes
- Always allow manual override for region selection
- Document all model differences and compatibility issues as you encounter them 

---

## 7. Detailed Inventory: AI Client Instantiations & Migration Plan

This section lists all places in the codebase where AI clients are instantiated or used, with details on:
- **File & Line**
- **Purpose**
- **Current Model/API Key**
- **What to Replace**
- **China-Compatible Equivalent Needed**

### **A. LLMChatTool (LLM/Chat)**

| File & Line | Purpose | Current Model/API Key | What to Replace | China-Compatible Equivalent Needed |
|-------------|---------|----------------------|----------------|------------------------------------|
| `packages/tools/src/ai/LLMChatTool.ts:247` | Singleton export of LLMChatTool | Google Gemini (model from config, API key: `GOOGLE_API_KEY`) | Use model name & API key from region-aware config service | DeepSeek (e.g., deepseek-chat), Qwen (e.g., qwen-turbo) |
| `services/dialogue-service/src/DialogueAgent.ts:11,35,48,59,209` | Injected into DialogueAgent for chat | Google Gemini | Use region-aware LLMChatTool | DeepSeek/Qwen |
| `apps/api-gateway/src/app.ts:15,65` | Injected into DialogueAgent | Google Gemini | Use region-aware LLMChatTool | DeepSeek/Qwen |
| `packages/tools/src/composite/HolisticAnalysisTool.ts:9,113` | Used in HolisticAnalysisTool (IngestionAnalyst) | Google Gemini | Use region-aware LLMChatTool | DeepSeek/Qwen |
| `packages/tools/src/composite/StrategicSynthesisTool.ts:15,172` | Used in StrategicSynthesisTool (InsightEngine) | Google Gemini | Use region-aware LLMChatTool | DeepSeek/Qwen |

### **B. TextEmbeddingTool (Text Embedding)**

| File & Line | Purpose | Current Model/API Key | What to Replace | China-Compatible Equivalent Needed |
|-------------|---------|----------------------|----------------|------------------------------------|
| `packages/tools/src/ai/TextEmbeddingTool.ts:147` | Singleton export of TextEmbeddingTool | Google Gemini embedding (model from config, API key: `GOOGLE_API_KEY`) | Use model name & API key from region-aware config service | DeepSeek embedding, Qwen embedding |
| `workers/embedding-worker/src/EmbeddingWorker.ts:14,39,60,61,116,117,198` | Used for generating and testing embeddings | Google Gemini embedding | Use region-aware TextEmbeddingTool | DeepSeek/Qwen embedding |

### **C. VisionCaptionTool (Vision/Image Captioning)**

| File & Line | Purpose | Current Model/API Key | What to Replace | China-Compatible Equivalent Needed |
|-------------|---------|----------------------|----------------|------------------------------------|
| `packages/tools/src/ai/VisionCaptionTool.ts:391` | Singleton export of VisionCaptionTool | Google Gemini Vision (model from config, API key: `GOOGLE_API_KEY`) | Use model name & API key from region-aware config service | DeepSeek vision, Qwen multimodal |
| `services/dialogue-service/src/DialogueAgent.ts:12,36,49,60` | Injected into DialogueAgent for vision tasks | Google Gemini Vision | Use region-aware VisionCaptionTool | DeepSeek/Qwen vision |
| `apps/api-gateway/src/app.ts:16,66` | Injected into DialogueAgent | Google Gemini Vision | Use region-aware VisionCaptionTool | DeepSeek/Qwen vision |

### **D. AudioTranscribeTool (Audio/Speech-to-Text)**

| File & Line | Purpose | Current Model/API Key | What to Replace | China-Compatible Equivalent Needed |
|-------------|---------|----------------------|----------------|------------------------------------|
| `packages/tools/src/data/AudioTranscribeTool.ts:241` | Singleton export of AudioTranscribeTool | Google Speech-to-Text (API key: `GOOGLE_API_KEY`) | Use model name & API key from region-aware config service | DeepSeek audio, Qwen audio, or other China STT API |
| `services/dialogue-service/src/DialogueAgent.ts:13,37,50,61` | Injected into DialogueAgent for audio tasks | Google Speech-to-Text | Use region-aware AudioTranscribeTool | DeepSeek/Qwen/other STT |
| `apps/api-gateway/src/app.ts:17,67` | Injected into DialogueAgent | Google Speech-to-Text | Use region-aware AudioTranscribeTool | DeepSeek/Qwen/other STT |

### **E. DocumentExtractTool (Document Parsing)**

| File & Line | Purpose | Current Model/API Key | What to Replace | China-Compatible Equivalent Needed |
|-------------|---------|----------------------|----------------|------------------------------------|
| `packages/tools/src/data/DocumentExtractTool.ts:264` | Singleton export of DocumentExtractTool | Local libraries (pdf-parse, mammoth, etc.) | N/A (already local) | N/A (already China-compatible) |
| `services/dialogue-service/src/DialogueAgent.ts:14,38,51,62` | Injected into DialogueAgent for doc parsing | Local libraries | N/A | N/A |
| `apps/api-gateway/src/app.ts:18,68` | Injected into DialogueAgent | Local libraries | N/A | N/A |

---

### **How to Use This Table**
- For each tool, update the instantiation to use the region-aware config service for model name and API key.
- For each use case, identify and acquire the China-compatible model (DeepSeek, Qwen, or other) and obtain the necessary API key.
- Document the selected China model and API key in `config/china_models.json`.
- For document extraction, no change is needed as it uses local libraries.

---

**Action for Model Acquisition:**
- For each row marked "China-Compatible Equivalent Needed", research and acquire the appropriate DeepSeek/Qwen model and API key for:
  - LLM/chat
  - Text embedding
  - Vision (image captioning)
  - Audio (speech-to-text) 