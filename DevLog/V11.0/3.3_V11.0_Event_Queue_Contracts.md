# **V11.0 Definitive Guide: Event Queue Contracts**

**Document Version:** 11.0 (Headless Service Architecture)
**Purpose:** To provide the single, canonical source of truth for all event types and their payload schemas used in the V11.0 event-driven communication system, optimized for the headless architecture.

## **1. Core Principles**

*   **Queue Technology:** BullMQ (backed by Redis).
*   **Primary Queue:** `card-and-graph-queue` for presentation layer events.
*   **Additional Queues:** `ingestion-queue`, `insight-queue`, `embedding-queue` for specialized workflows.
*   **Error Handling:** All workers subscribing to these queues implement a dead-letter queue (DLQ) strategy. Failed jobs move to `{queue-name}-dlq` for manual inspection.
*   **Idempotency:** Workers are designed to handle the same event multiple times without causing duplicate data, supporting at-least-once delivery.
*   **Processing Model:** Multiple workers can consume the same event type independently and idempotently.
*   **V11.0 Enhancement:** Event payloads are optimized for headless service integration with enhanced type safety and performance tracking.

## **2. Event Payload Schemas**

### **Event Type 1: `new_entities_created`**

*   **Published By:** `IngestionAnalyst` worker.
*   **Consumed By:** `CardWorker`, `GraphProjectionWorker`.
*   **Purpose:** To notify downstream presentation workers that new knowledge entities have been successfully persisted and are ready to be considered for UI representation.
*   **V11.0 Enhancements:** Enhanced metadata for better processing efficiency and debugging.

*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface NewEntitiesCreatedEvent {
      type: "new_entities_created";
      userId: string;
      source: "IngestionAnalyst";
      timestamp: string; // ISO8601
      entities: Array<{
        id: string; // The UUID of the newly created entity (e.g., MemoryUnit.muid or Concept.concept_id)
        type: "MemoryUnit" | "Concept";
        importance_score?: number; // V11.0: Enhanced importance tracking
        metadata?: {
          salience?: number;
          creation_context?: string;
          parent_conversation_id?: string;
        };
      }>;
      conversationId?: string; // Optional: source conversation if applicable
      processingMetrics?: { // V11.0: Enhanced performance tracking
        ingestion_duration_ms: number;
        entities_processed: number;
        llm_calls_made: number;
      };
    }
    ```

### **Event Type 2: `cycle_artifacts_created`**

*   **Published By:** `InsightEngine` worker.
*   **Consumed By:** `CardWorker`, `GraphProjectionWorker`.
*   **Purpose:** To notify downstream presentation workers that strategic artifacts from a completed cycle are ready to be presented.
*   **V11.0 Enhancements:** Enhanced cycle tracking and artifact classification.

*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface CycleArtifactsCreatedEvent {
      type: "cycle_artifacts_created";
      userId: string;
      source: "InsightEngine";
      timestamp: string; // ISO8601
      entities: Array<{
        id: string; // The UUID of the new artifact (e.g., DerivedArtifact.artifact_id or ProactivePrompt.prompt_id)
        type: "DerivedArtifact" | "ProactivePrompt";
        priority?: "high" | "medium" | "low"; // V11.0: Enhanced priority classification
        metadata?: {
          artifact_type?: string;
          strategic_importance?: number;
          user_readiness_score?: number;
        };
      }>;
      cycleId: string; // The cycle that generated these artifacts
      cycleMetrics?: { // V11.0: Enhanced cycle analytics
        cycle_duration_hours: number;
        insights_generated: number;
        ontology_updates_applied: number;
        knowledge_graph_growth_percentage: number;
      };
    }
    ```

### **Event Type 3: `graph_ontology_updated`**

*   **Published By:** `InsightEngine` worker.
*   **Consumed By:** `GraphProjectionWorker`.
*   **Purpose:** To explicitly trigger a regeneration of the 3D Cosmos projection after significant structural changes to the graph ontology.
*   **V11.0 Enhancements:** Enhanced ontology change tracking and performance optimization hints.

*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface GraphOntologyUpdatedEvent {
      type: "graph_ontology_updated";
      userId: string;
      source: "InsightEngine";
      timestamp: string; // ISO8601
      summary: {
        concepts_merged: number;
        concepts_archived: number;
        new_communities: number;
        strategic_relationships_added: number;
        relationships_refined: number; // V11.0: Enhanced relationship evolution tracking
      };
      affectedNodeIds: string[]; // Specific nodes that need position recalculation
      updateScope: "incremental" | "full" | "community_specific"; // V11.0: Enhanced update optimization
      priorityLevel: "urgent" | "normal" | "low"; // V11.0: Enhanced processing priority
      projectionHints?: { // V11.0: Enhanced projection optimization
        community_restructuring_needed: boolean;
        dimensional_reduction_required: boolean;
        semantic_clustering_updated: boolean;
      };
    }
    ```

### **Event Type 4: `embedding_job_created`** (V11.0 New)

*   **Published By:** `IngestionAnalyst` worker.
*   **Consumed By:** `EmbeddingWorker`.
*   **Purpose:** To trigger vector embedding generation for newly created knowledge entities.
*   **V11.0 Enhancement:** Dedicated embedding pipeline for improved performance and separation of concerns.

*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface EmbeddingJobCreatedEvent {
      type: "embedding_job_created";
      userId: string;
      source: "IngestionAnalyst";
      timestamp: string; // ISO8601
      entityId: string;
      entityType: "MemoryUnit" | "Concept" | "DerivedArtifact";
      textContent: string; // The content to be embedded
      priority: "high" | "normal" | "low";
      embeddingOptions?: {
        model_preference?: string;
        context_window_size?: number;
        semantic_enhancement?: boolean;
      };
      parentJobId?: string; // For batch processing coordination
    }
    ```

### **Event Type 5: `user_session_activity`** (V11.0 New)

*   **Published By:** API Gateway middleware.
*   **Consumed By:** Analytics workers, recommendation engines.
*   **Purpose:** To track user interaction patterns for improved personalization and system optimization.
*   **V11.0 Enhancement:** Real-time user behavior analytics for enhanced AI personalization.

*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface UserSessionActivityEvent {
      type: "user_session_activity";
      userId: string;
      source: "APIGateway";
      timestamp: string; // ISO8601
      sessionId: string;
      activityType: "conversation_started" | "conversation_ended" | "card_interacted" | "cosmos_explored" | "quest_accepted";
      activityData: {
        endpoint?: string;
        duration_seconds?: number;
        interaction_depth?: "shallow" | "medium" | "deep";
        ui_component?: string;
        performance_metrics?: {
          response_time_ms: number;
          error_occurred: boolean;
          cache_hit: boolean;
        };
      };
      contextualFlags?: string[]; // For behavioral pattern analysis
    }
    ```

## **3. V11.0 Worker Consumption Patterns**

### **`CardWorker` Consumption**
*   **Subscribes To:** `new_entities_created`, `cycle_artifacts_created`
*   **Processing Logic:** For each entity in the event payload, calls headless `CardFactory.createCardForEntity()` to evaluate eligibility and create cards.
*   **Idempotency:** Safe to process the same event multiple times - `CardFactory` checks if card already exists.
*   **V11.0 Enhancement:** Improved batch processing and priority-based scheduling.

### **`GraphProjectionWorker` Consumption**
*   **Subscribes To:** `new_entities_created`, `cycle_artifacts_created`, `graph_ontology_updated`
*   **Processing Logic:** Triggers optimized recalculation of 3D positions based on update scope and priority.
*   **Debouncing:** Implements intelligent debounce window - consolidates multiple events for same user based on priority and scope.
*   **Idempotency:** Safe to recalculate positions multiple times - always produces consistent results for same input data.
*   **V11.0 Enhancement:** Smart batching and incremental updates for improved performance.

### **`EmbeddingWorker` Consumption** (V11.0 New)
*   **Subscribes To:** `embedding_job_created`
*   **Processing Logic:** Generates vector embeddings using configured embedding models and stores in Weaviate.
*   **Batching:** Processes multiple embedding jobs in batches for improved efficiency.
*   **Priority Handling:** Processes high-priority embeddings first to ensure real-time conversation performance.

## **4. Error Handling & Retry Strategy**

### **BullMQ Job Configuration**
```typescript
// V11.0 Enhanced job configuration
const jobOptions = {
  attempts: 3,
  backoff: {
    type: 'exponential',
    delay: 2000,
  },
  removeOnComplete: 20, // V11.0: Increased for better debugging
  removeOnFail: 100,    // V11.0: Increased for better analysis
  priority: jobPriority, // V11.0: Dynamic priority based on event type
  delay: delayMs,       // V11.0: Smart delay for batching optimization
  jobId: `${eventType}-${userId}-${timestamp}`, // V11.0: Improved job deduplication
};
```

### **Dead Letter Queue Processing**
*   **DLQ Names:** `{queue-name}-dlq` (e.g., `card-and-graph-queue-dlq`)
*   **Manual Review:** Failed events require manual inspection to determine retry or discard action.
*   **V11.0 Enhanced Analysis:** Automated failure pattern detection and categorization.
*   **Common Failure Scenarios:**
    *   Database connectivity issues (auto-retry after infrastructure verification)
    *   Malformed event payloads (auto-discard with detailed logging)
    *   Python dimension reducer service unavailable (smart retry with exponential backoff)
    *   Weaviate embedding service timeout (priority re-queue with batch optimization)

## **5. Event Publishing Examples**

### **From IngestionAnalyst:**
```typescript
// V11.0: Enhanced event publishing with metadata
await this.eventQueue.add('new_entities_created', {
  type: 'new_entities_created',
  userId: conversation.user_id,
  source: 'IngestionAnalyst',
  timestamp: new Date().toISOString(),
  entities: [
    { 
      id: newMemoryUnit.muid, 
      type: 'MemoryUnit',
      importance_score: newMemoryUnit.importance_score,
      metadata: {
        creation_context: 'conversation_extraction',
        parent_conversation_id: conversation.id
      }
    },
    { 
      id: newConcept.concept_id, 
      type: 'Concept',
      metadata: {
        salience: newConcept.salience,
        creation_context: 'conversation_analysis'
      }
    }
  ],
  conversationId: conversation.id,
  processingMetrics: {
    ingestion_duration_ms: processingTime,
    entities_processed: 2,
    llm_calls_made: 1
  }
}, {
  priority: conversation.importance_score > 7 ? 10 : 5, // V11.0: Dynamic priority
  delay: 0 // V11.0: Immediate processing for important conversations
});
```

### **From InsightEngine:**
```typescript
// V11.0: Enhanced cycle artifact publishing
await this.eventQueue.add('cycle_artifacts_created', {
  type: 'cycle_artifacts_created',
  userId: user.user_id,
  source: 'InsightEngine',
  timestamp: new Date().toISOString(),
  entities: [
    { 
      id: cycleReport.artifact_id, 
      type: 'DerivedArtifact',
      priority: 'high',
      metadata: {
        artifact_type: 'cycle_report',
        strategic_importance: 9,
        user_readiness_score: 8.5
      }
    },
    { 
      id: newQuest.prompt_id, 
      type: 'ProactivePrompt',
      priority: 'medium',
      metadata: {
        strategic_importance: 7,
        user_readiness_score: 9.0
      }
    }
  ],
  cycleId: `cycle-${Date.now()}`,
  cycleMetrics: {
    cycle_duration_hours: cycleDurationHours,
    insights_generated: insightsCount,
    ontology_updates_applied: ontologyUpdates,
    knowledge_graph_growth_percentage: growthPercentage
  }
});

// V11.0: Conditional ontology update event
if (significantOntologyChanges) {
  await this.eventQueue.add('graph_ontology_updated', {
    type: 'graph_ontology_updated',
    userId: user.user_id,
    source: 'InsightEngine',
    timestamp: new Date().toISOString(),
    summary: {
      concepts_merged: 2,
      concepts_archived: 1,
      new_communities: 0,
      strategic_relationships_added: 5,
      relationships_refined: 12
    },
    affectedNodeIds: ['concept-abc', 'concept-def', 'muid-xyz'],
    updateScope: 'incremental',
    priorityLevel: 'normal',
    projectionHints: {
      community_restructuring_needed: false,
      dimensional_reduction_required: true,
      semantic_clustering_updated: true
    }
  }, {
    priority: 7, // V11.0: Medium priority for ontology updates
    delay: 300000 // V11.0: 5-minute delay to allow for batching
  });
}
```

## **6. V11.0 Performance Optimizations**

### **Smart Event Batching**
*   **Temporal Grouping:** Events for the same user within time windows are automatically batched
*   **Priority-Based Processing:** High-priority events bypass batching for immediate processing
*   **Load Balancing:** Dynamic worker allocation based on queue depth and event priority

### **Enhanced Monitoring**
*   **Event Lifecycle Tracking:** Full traceability from publication to completion
*   **Performance Metrics:** Detailed timing and resource usage tracking
*   **Failure Pattern Analysis:** Automated detection of systematic issues

### **Headless Integration Benefits**
*   **Reduced Serialization Overhead:** Events processed more efficiently within worker processes
*   **Enhanced Type Safety:** Compile-time validation of event payloads
*   **Improved Error Handling:** Direct exception propagation for better debugging

This V11.0 specification provides a comprehensive, performant contract for event-driven communication between all system components, ensuring loose coupling while maintaining data consistency and optimal performance within the headless service architecture. 