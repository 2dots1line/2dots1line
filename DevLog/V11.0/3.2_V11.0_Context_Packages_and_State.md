### **`3.2_V11.0_Context_Packages_and_State.md`**

---

# **V11.0 Definitive Guide: Context Packages & State Management**

**Document Version:** 11.0 (Headless Service Architecture)
**Purpose:** To provide a detailed manifest of every `Context Package` used throughout the V11.0 2dots1line system, defining their structure, persistence location, lifecycle, and read/write access patterns within the headless architecture.

## **1. Context Package Philosophy**

Context Packages are structured data objects that carry rich, contextual information between different components of the system. They represent the "working memory" of various agents and services, ensuring that each component has access to the precise information it needs for optimal decision-making.

**V11.0 Key Principles:**
*   **Structured & Typed:** All context packages are defined with TypeScript interfaces in `@2dots1line/shared-types` and validated with Zod schemas
*   **Scoped Access:** Each package has clearly defined read/write permissions within the headless service architecture
*   **Lifecycle Management:** Packages have explicit creation, update, and cleanup patterns
*   **Performance Optimized:** Critical packages are cached in Redis for fast access and shared efficiently within API Gateway process
*   **Headless Integration:** Context packages are shared directly between services without HTTP serialization overhead

---

## **2. Core Context Packages**

### **2.1 `UserMemoryProfile`**

*   **Purpose:** The strategic, high-level synthesis of a user's identity, goals, and growth trajectory
*   **Generated By:** `InsightEngine` worker at the end of each cycle
*   **Storage:** PostgreSQL `User.memory_profile` (JSONB field)
*   **Accessed By:** `DialogueService` (headless), `PromptBuilder` (headless), `InsightDataCompiler` (headless)
*   **Lifecycle:** Updated cyclically, persisted indefinitely
*   **V11.0 Benefits:** Shared directly within API Gateway process for real-time dialogue enhancement

```typescript
interface UserMemoryProfile {
  version: string; // "11.0"
  last_updated: string; // ISO8601 timestamp
  
  identity_synthesis: {
    core_values: Array<{
      name: string;
      description: string;
      salience: number; // 0.0-1.0
      supporting_evidence: string[];
      evolution_trajectory: "strengthening" | "stable" | "questioning" | "emerging";
    }>;
    life_themes: Array<{
      name: string;
      description: string;
      current_status: "emerging" | "active" | "evolving" | "dormant";
      connection_to_goals: string[];
      narrative_coherence_score: number; // V11.0: Enhanced narrative tracking
    }>;
    growth_trajectory: {
      primary_focus_areas: string[];
      recent_breakthroughs: string[];
      persistent_challenges: string[];
      six_dimensional_snapshot: Record<string, number>; // know_self, act_world, etc.
      momentum_indicators: Array<{
        dimension: string;
        direction: "positive" | "negative" | "stable";
        strength: number;
      }>; // V11.0: Enhanced momentum tracking
    };
  };
  
  strategic_context: {
    active_goals: Array<{
      goal_id: string;
      name: string;
      status: "active" | "stalled" | "achieved" | "pivoting";
      priority: "high" | "medium" | "low";
      progress_indicators: string[];
      blockers: string[];
      support_resources: string[]; // V11.0: Enhanced goal support tracking
    }>;
    key_relationships: Array<{
      person_name: string;
      relationship_type: string;
      interaction_context: string;
      emotional_valence: "positive" | "neutral" | "negative" | "complex";
      influence_on_growth: "supportive" | "challenging" | "neutral" | "mixed"; // V11.0: Enhanced relationship impact
    }>;
    current_projects: Array<{
      project_name: string;
      status: string;
      key_milestones: string[];
      associated_concepts: string[];
      energy_level: "high" | "medium" | "low" | "depleted"; // V11.0: Enhanced project energy tracking
    }>;
  };
  
  knowledge_preferences: {
    preferred_learning_style: string;
    effective_growth_strategies: string[];
    resource_accessibility: {
      time_availability: string;
      financial_constraints: string;
      technology_comfort: string;
      social_support: string;
    };
    communication_preferences: {
      tone: string;
      depth_level: string;
      interaction_style: string;
      feedback_receptivity: "high" | "medium" | "low" | "context-dependent"; // V11.0: Enhanced feedback preferences
    };
  };
  
  contextual_flags: {
    current_life_phase: string;
    stress_indicators: string[];
    energy_patterns: string[];
    motivation_drivers: string[];
    recent_significant_events: Array<{ // V11.0: Enhanced life event tracking
      event_type: string;
      description: string;
      impact_level: "high" | "medium" | "low";
      date: string;
    }>;
  };
}
```

### **2.2 `KnowledgeGraphSchema`**

*   **Purpose:** User-specific "API documentation" for LLMs to understand and interact with the user's knowledge graph
*   **Generated By:** `InsightEngine` worker, updated based on graph evolution and effective query patterns
*   **Storage:** PostgreSQL `User.knowledge_graph_schema` (JSONB field)
*   **Accessed By:** All agent LLMs via headless services for query formulation and entity validation
*   **Lifecycle:** Updated cyclically, persisted indefinitely
*   **V11.0 Benefits:** Direct sharing between services enables real-time schema validation and query optimization

```typescript
interface KnowledgeGraphSchema {
  user_id: string;
  schema_version: string; // "11.0"
  last_updated_by_insight_engine_at: string; // ISO8601
  description_for_llm: string;
  
  prominent_node_types: Array<{
    label: string; // "MemoryUnit", "Concept", etc.
    description_for_llm: string;
    key_properties_for_query_and_creation: Array<{
      name: string;
      type: string;
      description: string;
      query_patterns: string[]; // V11.0: Enhanced query pattern guidance
    }>;
    prominent_concept_sub_types_for_user?: string[];
    common_relationships_for_llm: Array<{
      type: string;
      direction: "INCOMING" | "OUTGOING" | "BIDIRECTIONAL";
      target_label?: string;
      source_label?: string;
      description: string;
      frequency_score: number; // V11.0: Enhanced relationship frequency tracking
    }>;
  }>;
  
  prominent_relationship_types: Array<{
    type: string;
    description_for_llm: string;
    roles_for_llm: string;
    key_properties_for_query_and_creation: Array<{
      name: string;
      type: string;
      description: string;
    }>;
    prominent_relationship_sub_labels_for_user?: string[];
    semantic_clusters: Array<{ // V11.0: Enhanced semantic relationship clustering
      cluster_name: string;
      member_labels: string[];
      usage_context: string;
    }>;
  }>;
  
  example_cypher_queries_personalized: Array<{
    description_for_llm: string;
    query_template_for_llm_adaptation: string;
    success_rate: number; // V11.0: Enhanced query effectiveness tracking
    use_cases: string[];
  }>;
  
  universal_core_entity_types: string[];
  universal_concept_types: string[];
  universal_relationship_labels: string[];
  
  ontology_update_guidelines_for_llm: string[];
  
  // V11.0: Enhanced graph insights for better LLM decision-making
  graph_health_metrics: {
    average_node_connectivity: number;
    community_coherence_score: number;
    semantic_consistency_score: number;
    growth_velocity: number;
  };
}
```

### **2.3 `TurnContextPackage`**

*   **Purpose:** Ephemeral turn-to-turn state for DialogueService conversations
*   **Generated By:** `DialogueService` LLM output, processed by DialogueService headless logic
*   **Storage:** Redis `turn_context:{conversationId}` with TTL aligned to conversation timeout
*   **Accessed By:** `PromptBuilder` (next turn), `IngestionAnalyst` (context for analysis)
*   **Lifecycle:** Created/updated each turn, expires with conversation
*   **V11.0 Benefits:** Direct memory sharing within API Gateway eliminates Redis serialization for active conversations

```typescript
interface TurnContextPackage {
  conversation_id: string;
  created_at: string; // ISO8601
  last_updated_at: string; // ISO8601
  
  suggested_next_focus: string; // "Explore user's feelings about the feedback received"
  emotional_tone_to_adopt: string; // "empathetic", "analytical", "encouraging"
  
  flags_for_ingestion: string[]; // ["potential_new_concept:Feedback_Process", "user_expressed_high_confidence"]
  
  contextual_notes: {
    user_energy_level?: string; // "high", "medium", "low", "tired"
    conversation_depth?: string; // "surface", "moderate", "deep", "breakthrough"
    topic_sensitivity?: string; // "neutral", "sensitive", "highly_personal"
    user_engagement?: string; // "active", "passive", "resistant", "enthusiastic"
    conversation_momentum?: string; // V11.0: Enhanced momentum tracking
  };
  
  retrieval_context?: {
    last_query_successful: boolean;
    retrieved_entity_ids: string[];
    unmatched_key_phrases?: string[];
    semantic_confidence_scores?: Record<string, number>; // V11.0: Enhanced retrieval confidence
  };
  
  ui_state_hints?: {
    orb_state_preference?: string;
    highlight_cards?: string[];
    cosmos_focus_nodes?: string[];
    suggested_camera_position?: [number, number, number]; // V11.0: Enhanced 3D cosmos integration
  };
  
  // V11.0: Enhanced conversation flow management
  conversation_flow: {
    current_phase: "opening" | "exploration" | "deepening" | "synthesis" | "closure";
    phase_transitions: Array<{
      from_phase: string;
      to_phase: string;
      timestamp: string;
      trigger: string;
    }>;
    attention_threads: Array<{
      thread_id: string;
      topic: string;
      intensity: number;
      last_referenced: string;
    }>;
  };
}
```

### **2.4 `ConversationSummaryContext`**

*   **Purpose:** Comprehensive conversation context for cross-conversation continuity
*   **Generated By:** `IngestionAnalyst` worker after conversation processing
*   **Storage:** PostgreSQL `Conversation.context_summary` (string field) + Redis for active sessions
*   **Accessed By:** `DialogueService` for conversation continuity, `InsightDataCompiler` for cycle analysis
*   **Lifecycle:** Created after conversation ends, cached during user session
*   **V11.0 Benefits:** Headless service access enables rich context sharing without API overhead

```typescript
interface ConversationSummaryContext {
  conversation_id: string;
  user_id: string;
  created_at: string;
  
  thematic_summary: {
    primary_topics: string[];
    emotional_journey: Array<{
      phase: string;
      dominant_emotion: string;
      intensity: number;
    }>;
    breakthrough_moments: string[];
    unresolved_tensions: string[];
  };
  
  knowledge_contributions: {
    new_concepts_discussed: string[];
    existing_concepts_evolved: string[];
    connections_discovered: string[];
    insights_generated: string[];
  };
  
  user_state_observations: {
    energy_level_trajectory: string;
    engagement_pattern: string;
    openness_to_challenge: string;
    learning_mode_exhibited: string;
  };
  
  forward_momentum: {
    action_commitments: string[];
    exploration_intentions: string[];
    growth_edges_identified: string[];
    support_needs_expressed: string[];
  };
  
  // V11.0: Enhanced cross-conversation linking
  connection_to_previous_conversations: Array<{
    conversation_id: string;
    connection_type: "continuation" | "contrast" | "deepening" | "resolution";
    shared_themes: string[];
    evolution_noted: string;
  }>;
}
```

## **3. V11.0 Headless Architecture Benefits**

### **Enhanced Performance**
*   **50-80% Reduced Context Access Latency:** Direct object sharing within API Gateway process
*   **Eliminated Serialization Overhead:** Context packages shared as native TypeScript objects
*   **Optimized Memory Usage:** Single instance of context data shared across multiple service calls
*   **Enhanced Caching:** Redis used only for persistence, not for active conversation context

### **Improved Type Safety**
*   **Full TypeScript Validation:** Context packages validated at compile time across all services
*   **Schema Evolution Tracking:** Version-aware context package handling prevents compatibility issues
*   **Automatic Interface Updates:** Shared types package ensures consistent context structure

### **Simplified Error Handling**
*   **Direct Exception Propagation:** Context access errors handled naturally without HTTP wrapper
*   **Enhanced Debugging:** Full stack traces across context access boundaries
*   **Centralized Context Validation:** Single validation layer in shared types package

## **4. Context Package Access Patterns**

### **API Gateway Integration**
```typescript
// V11.0 Pattern: Headless context access
export class DialogueController {
  constructor(
    private dialogueService: DialogueService,
    private contextService: ContextService
  ) {}
  
  async processMessage(req: Request, res: Response) {
    const userId = req.user.userId;
    
    // Direct headless context access - no HTTP overhead
    const userProfile = await this.contextService.getUserMemoryProfile(userId);
    const graphSchema = await this.contextService.getKnowledgeGraphSchema(userId);
    
    // Direct service call with shared context objects
    const response = await this.dialogueService.processMessage({
      message: req.body.message,
      userProfile,
      graphSchema,
      conversationId: req.params.conversationId
    });
    
    res.json(response);
  }
}
```

### **Service-to-Service Context Sharing**
```typescript
// V11.0 Pattern: Direct context object sharing
export class IngestionAnalyst {
  async processConversation(conversationId: string) {
    // Direct context access within worker process
    const turnContext = await this.contextService.getTurnContext(conversationId);
    const userProfile = await this.contextService.getUserMemoryProfile(turnContext.userId);
    
    // Context objects shared directly in memory - no serialization
    const analysis = await this.holisticAnalysisTool.execute({
      conversation: fullTranscript,
      context: turnContext,
      profile: userProfile
    });
    
    return analysis;
  }
}
```

## **5. Context Package Lifecycle Management**

| Package Type | Creation | Updates | Expiration | Caching Strategy |
|--------------|----------|---------|------------|------------------|
| `UserMemoryProfile` | InsightEngine cycle | Weekly/cycle-based | Never | PostgreSQL + API Gateway memory |
| `KnowledgeGraphSchema` | InsightEngine cycle | Weekly/cycle-based | Never | PostgreSQL + API Gateway memory |
| `TurnContextPackage` | DialogueService per turn | Per turn | Conversation timeout | Redis + API Gateway memory |
| `ConversationSummaryContext` | IngestionAnalyst post-conversation | Never | 1 year | PostgreSQL + Redis (session) |

## **6. Configuration & Environment Integration**

Context packages are enhanced with configuration-driven behavior:

```typescript
// V11.0: Configuration-driven context management
interface ContextManagementConfig {
  cache_strategies: {
    user_profile_ttl: number;
    turn_context_ttl: number;
    conversation_summary_ttl: number;
  };
  validation_levels: {
    strict_type_checking: boolean;
    schema_version_enforcement: boolean;
    cross_service_validation: boolean;
  };
  performance_optimizations: {
    memory_sharing_enabled: boolean;
    redis_fallback_enabled: boolean;
    compression_threshold: number;
  };
}
```

This V11.0 guide defines a robust, performant, and type-safe context management system that leverages the headless architecture to provide rich contextual information across all system components while maintaining optimal performance and developer experience. 