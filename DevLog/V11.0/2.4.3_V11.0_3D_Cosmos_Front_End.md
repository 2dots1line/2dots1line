
# Cosmos 3D Frontend Refactor & Implementation Guide (V11.0 Definitive Edition)

---

## 1. **Prototype Audit: DevLog/3DFrontUI/Starfield/**

- **starview.js**
  - **Keep with modification (logic port only)**
    - Port the following:
      - Starfield background logic → `StarfieldBackground.tsx` (new, in `packages/ui-components/src/components/cosmos/`)
      - Node mesh (sphere, glow, label, click/hover) → `NodeMesh.tsx` (new, in `packages/ui-components/src/components/cosmos/`)
      - Camera/controls (WASD, orbit, auto-flight) → `CameraController.tsx` (new, in `packages/ui-components/src/components/cosmos/`)
      - Info panel, error/loading overlays → `CosmosInfoPanel.tsx`, `CosmosError.tsx`, `CosmosLoading.tsx` (new, in `apps/web-app/src/components/modal/`)
    - **Do NOT port:**
      - Neo4j direct fetch logic (all data comes from backend API)
      - Paper-specific logic (generalize for graph nodes)
      - CSS-based layout (all 3D is R3F/Three.js)
  - **Delete** after porting logic.

- **starview.css**
  - **Delete**
    - All relevant styles should be implemented as Tailwind classes or in component-level CSS-in-JS if absolutely necessary. No global or legacy CSS.

---

## 2. **Old Cosmos Modal: apps/web-app/src/components/modal/CosmosModal.tsx**

- **CosmosModal.tsx**
  - **Delete (after audit)**
    - The placeholder 3D canvas and all modal logic are obsolete.
    - Any reusable logic for node/connection generation should be ported to utility functions in `packages/ui-components/src/components/cosmos/` or `packages/canvas-core/src/cosmos/` if still relevant.
    - All UI/UX should move to the new `/cosmos` route and modular components.
    - **Delete** after extracting any useful logic.

---

## 3. **New Cosmos App Route: apps/web-app/src/app/cosmos/**

- **page.tsx**
  - **New**
    - Entry point for Cosmos 3D view. Renders `CosmosScene.tsx`.

- **CosmosScene.tsx**
  - **New**
    - Main orchestrator for 3D scene, state, and overlays. Imports and composes all Cosmos 3D components.
    - Fetches data via `cosmosService.ts`, manages state via `CosmosStore.ts`, composes 3D and overlay components.

---

## 4. **Data Fetching / API Logic: apps/web-app/src/services/**

- **cosmosService.ts**
  - **New**
    - Centralized service for all Cosmos-related API calls (e.g., `fetchUserGraphProjection`, future mutations).
    - Follows the same pattern as `cardService.ts` and `chatService.ts`.
    - Used by any component/page needing Cosmos data (not just `/cosmos` route).

---

## 5. **State Management: apps/web-app/src/stores/**

- **CosmosStore.ts**
  - **New**
    - Zustand store for Cosmos UI state (selection, filters, camera, etc.).
    - Follows the same pattern as `CardStore.ts` and `HUDStore.ts`.
    - Used by all Cosmos-related components for state sharing.

---

## 6. **UI Components & Panels**

### **A. Modal/Panel Components: apps/web-app/src/components/modal/**

- **CosmosInfoPanel.tsx**
- **CosmosError.tsx**
- **CosmosLoading.tsx**
- **CosmosNodeModal.tsx**
  - **New**
    - All Cosmos overlays, panels, and modals should live here for consistency with `CardModal`, `ChatModal`, etc.
    - These are app-specific UI overlays, not generic/reusable enough for `ui-components`.

### **B. Reusable 3D Components: packages/ui-components/src/components/cosmos/**

- **Graph3D.tsx**
- **NodeMesh.tsx**
- **EdgeMesh.tsx**
- **NodeLabel.tsx**
- **StarfieldBackground.tsx**
- **CameraController.tsx**
  - **New**
    - All reusable, presentation-only 3D components for Cosmos.
    - No app logic, no direct API calls, no Zustand store usage—pure props in, render out.

---

## 7. **Canvas Core: packages/canvas-core/src/cosmos/**

- **KnowledgeGraph3D.ts, StarfieldEngine.ts**
  - **Keep with modification**
    - Ensure these files contain only reusable, backend-agnostic 3D logic (layout, spatial queries, starfield math). Refactor as needed to support new Cosmos features.

- **index.ts**
  - **Keep**
    - Export all relevant utilities for Cosmos.

---

## 8. **Shader Library: packages/shader-lib/src/shaders/**

- **myFirstShader.glsl**
  - **ignore or keep only if used**
    - Only keep if a custom shader (e.g., for node glow) is actually used in Cosmos. Otherwise, delete.

---

## 9. **3D Assets: 3d-assets/**

- **environment-maps, textures/hdri, textures/noise, textures/fx**
  - **ignore or Keep only if used**
    - Only import assets (e.g., `kiara_1_dawn_2k.hdr`, `blue_noise_256.png`, `sun_flare.png`) if they are referenced in the Cosmos 3D scene. Otherwise, ignore.

- **models, materials, clouds, lut, particles**
  - **Ignore if not used**
    - Do not reference unless a specific Cosmos feature requires them.

---

## 10. **Other UI Components: packages/ui-components/src/components/cards/**

- **InfiniteCardCanvas.tsx, CardTile.tsx**
  - **Keep (unrelated to Cosmos)**
    - No action needed unless a card visualization is required in Cosmos.

---

## 11. **Data Flow: Backend to Frontend**

- **Backend:**
  - `user_graph_projections` table in PG is populated with a complete, spec-compliant JSON for each user.
  - API Gateway exposes **`GET /api/v1/graph-projection/latest`** (authenticated) for fetching the latest projection for a user. This endpoint returns the most recent graph projection for the authenticated user. You must include a valid `Authorization: Bearer <token>` header.

- **Frontend:**
  - `cosmosService.ts` fetches the projection JSON from `/api/v1/graph-projection/latest`.
  - `CosmosStore.ts` manages UI state (selection, filters, etc.).
  - `CosmosScene.tsx` orchestrates data fetching, state, and rendering.
  - 3D components in `ui-components` render the graph, nodes, edges, and starfield.
  - Overlays and modals in `/components/modal/` handle info, errors, loading, and node details.

---

## 12. **Implementation Checklist**

- [ ] Port starfield, node mesh, camera, and overlays from prototype to new modular components.
- [ ] Delete all obsolete modal and CSS files after porting logic.
- [ ] Create new `/cosmos` route and orchestrator in `apps/web-app`.
- [ ] Refactor canvas-core and shader-lib only as needed for Cosmos.
- [ ] Only use assets that are actually referenced in the new Cosmos scene.
- [ ] Write unit/integration tests and documentation for all new components.
- [ ] Ensure all overlays, panels, and modals are in `/src/components/modal/` if app-specific.
- [ ] Ensure all reusable 3D components are in `ui-components`.
- [ ] Ensure all data fetching is via `cosmosService.ts` and all state via `CosmosStore.ts`.
- [ ] **Ensure `cosmosService.ts` uses `/api/v1/graph-projection/latest` as the API endpoint for fetching the latest user graph projection.**

---

**This document is now a definitive, implementation-ready guide for the Cosmos 3D frontend. All decisions are explicit, and every step is actionable.**