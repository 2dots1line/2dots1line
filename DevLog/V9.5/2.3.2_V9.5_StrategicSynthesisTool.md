### **`2.3.2_V9.5_StrategicSynthesisTool.md` (Revised)**

---

# **V9.5 Canonical Guide: `StrategicSynthesisTool` (Composite Tool)**

**Document Version:** 9.5 (Revised for 3-Package Input)
**Purpose:** To provide a definitive, deep-dive specification for the `StrategicSynthesisTool`. This composite tool is the cognitive core of the `InsightEngine` worker, responsible for synthesizing a comprehensive, multi-faceted analysis of a user's cycle activity into an actionable strategic plan.

## **1. Core Job Responsibility & Philosophy**

The `StrategicSynthesisTool` is a **composite tool** used exclusively by the `InsightEngine` worker. Its primary responsibility is to perform a comprehensive, LLM-driven strategic analysis by taking the three pre-compiled input packages (`IngestionActivitySummary`, `GraphAnalysisPackage`, `StrategicInsightPackage`) and synthesizing them into actionable outputs for ontology refinement, user profile updates, and proactive growth guidance.

**Philosophy:** It embodies the "Single Synthesis Call" principle for the `InsightEngine`. The worker prepares all necessary data into logical packages, and this tool makes one highly structured call to its configured atomic `LLMChatTool` to generate all strategic outputs simultaneously. This ensures coherence between the ontology changes, the new user profile, and the next cycle's guidance.

**Location:** `packages/tools/composite/StrategicSynthesisTool.ts`

**Instantiated By:** The `ToolRegistry` at the initialization of the `InsightEngine` worker, based on configuration in `config/tool_composition.json`.

## **2. Input & Output Contracts**

### **Input to `StrategicSynthesisTool.execute()`:**

The `execute` method now accepts the three distinct data packages, along with other necessary context.

```typescript
// The definitive input interface for this tool's execute method
interface StrategicSynthesisInput {
  userId: string;
  coreIdentityStrategistSubset: any; // Relevant sections from CoreIdentity.yaml
  
  // State from the beginning of the cycle
  previousUserMemoryProfile: UserMemoryProfileData | null;
  currentKnowledgeGraphSchema: KnowledgeGraphSchemaData;

  // The three deterministically compiled data packages
  ingestionSummary: IngestionActivitySummary;
  graphAnalysis: GraphAnalysisPackage;
  strategicInsights: StrategicInsightPackage;

  // Additional context for refinement
  recentQuestHistory: Array<{ prompt_text: string; created_at: string }>;
  effectiveQueryPatterns: EffectiveQueryPatternsData;
}
```

### **Output of `StrategicSynthesisTool.execute()`:**

The output structure remains the same, as it already captures all necessary strategic actions. It is a single JSON object matching the `StrategicSynthesisOutput` interface.

```typescript
interface StrategicSynthesisOutput {
  persistence_payload: {
    ontology_update_cypher_statements: string[]; // Array of executable, parameterized Cypher queries
    cycle_report_content: string; // Narrative text for the DerivedArtifact
    quest_prompts_to_create: Array<{
      prompt_text: string;
      rationale: string;
      metadata?: Record<string, any>;
    }>;
  };
  forward_looking_context: {
    updated_user_memory_profile: UserMemoryProfileData;
    updated_knowledge_graph_schema: KnowledgeGraphSchemaData;
  };
}
```

## **3. Internal Components (Injected by `ToolRegistry`)**

Based on `config/tool_composition.json` for `"insightEngine"`, this tool is constructed with:

1.  **`synthesisLlmTool: LLMChatTool`**: An instance of a powerful atomic `LLMChatTool` (e.g., configured to use `deepseek_v2_pro_strategic`). This is its cognitive engine.

## **4. Detailed Workflow of `StrategicSynthesisTool.execute()`**

The internal workflow is updated to reflect the new three-package input structure.

```
                                   ┌────────────────────────────────────┐
                                   │ `InsightEngine` worker calls       │
                                   │ `StrategicSynthesisTool.execute()` │
                                   │ (with the 3 data packages & context) │
                                   └───────────────────┬────────────────┘
                                                       │ 1. Input received
                                                       ▼
                                   ┌────────────────────────────────────┐
                                   │ Internal `buildStrategicPrompt()`  │
                                   │ - Formats all inputs into a single │
                                   │   master prompt, now using distinct│
                                   │   XML tags for each of the 3 packages.│
                                   └───────────────────┬────────────────┘
                                                       │ 2. Master prompt generated
                                                       ▼
                                   ┌────────────────────────────────────┐
                                   │ Calls injected `this.synthesisLlmTool.execute()`│
                                   └───────────────────┬────────────────┘
                                                       │ 3. LLM returns a single JSON string
                                                       ▼
                                   ┌────────────────────────────────────┐
                                   │ Internal `validateAndParseOutput()`│
                                   │ - Parses and validates against the │
                                   │   `StrategicSynthesisOutput` schema.│
                                   └───────────────────┬────────────────┘
                                                       │ 4. Validated JSON object
                                                       ▼
                                   ┌────────────────────────────────────┐
                                   │ Returns `StrategicSynthesisOutput` │
                                   │ to the `InsightEngine` worker.     │
                                   └────────────────────────────────────┘
```

## **5. Prompt Engineering Snippet for `synthesisLlmTool`**

The internal prompt construction is now cleaner and more organized, using the three-package structure.

**Location:** Private method `buildStrategicPrompt` within `StrategicSynthesisTool.ts`.

```xml
<system_identity>
  You are an exceptionally insightful Strategic Analyst and Growth Coach...
  You MUST adhere strictly to the JSON output format.
  All generated Cypher statements MUST be parameterized and conform to the <current_knowledge_graph_schema>.
</system_identity>

<previous_user_memory_profile>
  <!-- JSON content of User.memory_profile from the START of the cycle -->
</previous_user_memory_profile>

<current_knowledge_graph_schema>
  <!-- JSON content of User.knowledge_graph_schema from the START of the cycle -->
</current_knowledge_graph_schema>

<recent_quest_history>
  <!-- JSON array of recently suggested quests to avoid duplication -->
</recent_quest_history>

<effective_query_patterns_for_user>
  <!-- JSON content of EffectiveQueryPatternsData -->
</effective_query_patterns_for_user>

<!-- V9.5 REFINED INPUT STRUCTURE -->

<ingestion_activity_summary>
  <!-- Component 1: "What Happened?" The factual log of new knowledge this cycle. -->
  <!-- JSON content of the IngestionActivitySummary object -->
</ingestion_activity_summary>

<graph_analysis_package>
  <!-- Component 2: "What Does It Mean for the Graph Structure?" Actionable suggestions for ontology refinement. -->
  <!-- JSON content of the GraphAnalysisPackage object -->
</graph_analysis_package>

<strategic_insight_package>
  <!-- Component 3: "What Does It Mean for the User?" High-level thematic insights. -->
  <!-- JSON content of the StrategicInsightPackage object -->
</strategic_insight_package>

<instructions>
Based on the three packages of information provided (<ingestion_activity_summary>, <graph_analysis_package>, <strategic_insight_package>), and considering the user's past state and query patterns, perform a strategic review.

Your tasks are to:
1.  **Vocabulary Management:** Review the list of emergent relationship labels provided in `<strategic_insight_package.emergent_relationship_vocabulary>`. Identify labels that are synonyms or overly specific (e.g., 'is annoyed with' and 'is frustrated by' could be consolidated to 'feels negatively about'). Generate Cypher statements to update the `relationship_label` property on all relevant `RELATED_TO` relationships to the new canonical label. For example: `MATCH ()-[r:RELATED_TO {relationship_label: 'is annoyed with'}]->() WHERE r.userId = $userId SET r.relationship_label = 'feels negatively about'`.
2.  **Ontology Evolution (`persistence_payload.ontology_update_cypher_statements`):**
    *   Review the suggestions in `<graph_analysis_package>`. For each suggestion (merges, new links, communities), generate the precise, parameterized Cypher statements needed to execute these changes. You are the final arbiter; if a suggestion seems weak, you can ignore it.
    *   Holistically review all three packages to identify any other necessary ontology refinements (e.g., creating a new theme Concept). Generate Cypher.

3.  **User-Facing Artifacts (`persistence_payload.cycle_report_content`, `persistence_payload.quest_prompts_to_create`):**
    *   Synthesize findings from `<strategic_insight_package>` and highlights from `<ingestion_activity_summary>` to write a warm, narrative `cycle_report_content`.
    *   Based primarily on `<strategic_insight_package>` (e.g., `knowledge_coverage_gaps`, `stalled_goals`), generate 2-3 novel `quest_prompts_to_create`.

4.  **Forward-Looking Context (`forward_looking_context`):**
    *   Generate the `updated_user_memory_profile` by synthesizing insights from all three packages and comparing with `<previous_user_memory_profile>`.
    *   Generate the `updated_knowledge_graph_schema` by refining the `<current_knowledge_graph_schema>` based on `<effective_query_patterns_for_user>` and the ontology changes you have decided to enact.

Return your entire output as a single, valid JSON object adhering to the `StrategicSynthesisOutput` schema.
</instructions>
```

This updated guide for the `StrategicSynthesisTool` is now fully aligned with the refined three-package input model from the `InsightDataCompiler`. The prompt is cleaner, more organized, and provides the LLM with a clearer logical flow for its complex synthesis task, leading to more reliable and coherent strategic outputs.