### **`1.0_V9.6_Ultimate_Technical_Specification.md` (Revised)**

---

# **2dots1line V9.6 Ultimate Technical Specification**

**Document Version:** 9.6 (Revised w/ 3D Cosmos & Event Queue Contracts)
**Date:** June 16, 2025
**Authors:** AI Collaboration with Human Direction

## **1. Executive Summary**

The 2dots1line System is a production-grade knowledge graph platform designed to help users define their identity, find their voice, and build profound connections with their inner self and the world. It transforms a continuous stream of user inputs into a rich, interconnected personal knowledge model, presented through a dual-interface system: an intuitive, serendipitous **2D Card Canvas** and an immersive, explorable **3D Knowledge Cosmos**.

This V9.6 specification represents the definitive architecture for the platform. It establishes a robust, scalable system built on key pillars:
1.  A **three-agent cognitive model** (`DialogueAgent`, `IngestionAnalyst`, `InsightEngine`) operating on distinct timescales for real-time interaction, post-conversation synthesis, and long-term strategic insight.
2.  A **persistent, card-centric user interface**, where the `Card` is the stable, primary unit of interaction, ensuring a predictable and engaging experience on the 2D canvas.
3.  An **asynchronous data pipeline** that generates a vector-based projection of the knowledge graph for visualization in the immersive 3D Knowledge Cosmos.
4.  A strict **separation of concerns**, isolating knowledge generation (by agents) from UI presentation (by the `CardWorker` and `GraphProjectionWorker`).

This architecture supports a product that not only facilitates deep reflection but also provides a powerful, multi-faceted exploratory interface into the user's personal knowledge graph.

### **Core V9.6 Capabilities:**

*   **Dual UI Paradigm:**
    *   **2D Card Canvas:** An "infinite" grid of cards designed for serendipitous discovery and focused interaction.
    *   **3D Knowledge Cosmos:** An immersive, explorable 3D space where knowledge nodes are visually positioned based on their semantic similarity (vector projection), allowing for holistic pattern recognition.
*   **Three-Agent Cyclical Pipeline:** A dual-loop system where a "fast loop" (`IngestionAnalyst`) processes individual conversations tactically, and a "slow loop" (`InsightEngine`) performs strategic, global analysis of the user's knowledge graph over a configurable "cycle."
*   **Decoupled Presentation Layer:** Dedicated workers (`CardWorker`, `GraphProjectionWorker`) are solely responsible for preparing and creating the data for the 2D and 3D user interfaces, decoupling presentation from core knowledge generation.
*   **Interactive Card System:** The `Card` is a first-class, persistent entity that acts as a stable anchor for the UI and a canvas for initiating new, context-specific conversations.
*   **Configuration-Driven Logic:** Key business logic, including card eligibility rules and the `CoreIdentity` of the AI, is managed in external configuration files for rapid iteration.
*   **Context-Aware AI Interrogation:** The `DialogueAgent` can field user queries within the 3D Cosmos, retrieving relevant information and generating UI commands to visually highlight corresponding nodes in the graph.

## **2. V9.6 Foundational Principles**

1.  **Dual Interface, Unified Knowledge:** The user can explore their single knowledge graph through two distinct but complementary interfaces: the serendipitous 2D Card Canvas and the structural 3D Knowledge Cosmos.
2.  **The Card is the UI Anchor:** In the 2D view, the persistent `Card` entity is the stable unit of interaction.
3.  **The Projection is the Map:** In the 3D view, a pre-computed, versioned JSON projection of the graph is the data source, ensuring high performance.
4.  **Separation of Concerns:** Knowledge generation (`IngestionAnalyst`, `InsightEngine`) is fully decoupled from presentation generation (`CardWorker`, `GraphProjectionWorker`).
5.  **Cyclical & Asynchronous Processing:** The system operates on distinct, asynchronous loops for real-time interaction, post-conversation analysis, cyclical insight, and graph projection, ensuring scalability and responsiveness.
6.  **Configuration over Schema:** Business rules are defined in external files for maximum flexibility.
7.  **Secure, Tool-Driven AI:** The `DialogueAgent` uses a robust `HybridRetrievalTool` and structured UI action outputs to interact with the knowledge graph, avoiding the direct generation of database queries by the LLM.

## **3. System Architecture Overview (V9.6)**

The V9.6 architecture shows the two parallel presentation pipelines (for the 2D Card Canvas and the 3D Cosmos) being fed by the core backend agents and services.

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                       USER INTERFACE LAYER (Web/Mobile)                       │
│ ┌──────────────────────────────────┐  ┌─────────────────────────────────────┐ │
│ │     2D Card Canvas               │  │    3D Knowledge Cosmos              │ │
│ │ (Fetches from CardService)       │  │ (Fetches Graph Projection from API)   │ │
│ └─────────────────┬────────────────┘  └───────────────────┬─────────────────┘ │
└───────────────────┼─────────────────────────────────────┼─────────────────────┘
                    │ (API: /cards, /conversations)         │ (API: /graph-projection)
      ┌─────────────▼─────────────┐           ┌─────────────▼─────────────┐
      │       CARD SERVICE        │           │     GRAPH DATA SERVICE    │
      │ (READS & Enriches Cards)  │           │   (Serves Projection JSON)  │
      └───────────────────────────┘           └─────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                           BACKEND SERVICES & WORKERS                          │
│ ┌──────────────────┐  ┌──────────────────┐                                    │
│ │ Dialogue Service │  │ Insight Engine   │ (Slow Loop: Post-Cycle)           │
│ │ (Real-Time Convo)│  │ (Worker)         │                                   │
│ └────────┬─────────┘  └────────┬─────────┘                                   │
│          │                     ├─────────────┐                               │
│ ┌────────▼─────────┐  ┌────────▼─────────┐  │ ┌──────────────────────┐      │
│ │ Ingestion Analyst│  │ [Card & Graph    ]  │ │ Graph Projection     │      │
│ │ (Worker)         │──>│      Queue       ]──┼>│        Worker        │      │
│ │(Fast Loop: Post-Convo)│ [  (Redis/BullMQ)  ]  │ │ (Runs UMAP/t-SNE)    │      │
│ └──────────────────┘  └────────┬─────────┘  └──────────────────────┘      │
│                                │                                           │
│                      ┌─────────▼─────────┐                                  │
│                      │   Card Worker    │                                  │
│                      └──────────────────┘                                  │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                   │
┌──────────────────────────────────▼──────────────────────────────────────────┐
│                             PERSISTENCE LAYER                               │
│ ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐         │
│ │ PostgreSQL │   │   Neo4j    │   │  Weaviate  │   │   Redis    │         │
│ └────────────┘   └────────────┘   └────────────┘   └────────────┘         │
└───────────────────────────────────────────────────────────────────────────┘
```

## **4. Modular Specification Structure**

This document serves as the high-level overview. The complete V9.6 architecture is detailed across the following 12 modular, canonical specification documents:

| Document ID                                             | Document Title                                              | Purpose                                                                                                                                                                                                                                                                                              |
| :------------------------------------------------------ | :---------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`1.0_V9.6_Ultimate_Technical_Specification.md`**      | Ultimate Technical Specification                            | **(This Document)** The high-level entry point, system overview, and table of contents for the entire V9.6 architecture.                                                                                                                                                                               |
| **`1.1_V9.6_System_Flows_and_Data_Propagation.md`**     | System Flows and Data Propagation                           | Provides detailed flowcharts and step-by-step descriptions of the **four** primary system loops (Real-Time Conversation, Fast Loop Ingestion, Presentation Loop, and Slow Loop Insight), showing how data and context move between components.                                                               |
| **`2.1_V9.6_DialogueAgent_and_PromptBuilder.md`**       | `DialogueAgent` & `PromptBuilder`                           | A deep dive into the real-time `DialogueAgent`, its stateful turn-by-turn logic, its exclusive use of the `PromptBuilder` service, and how its output can include `ui_actions` for the 3D Cosmos.                                                                                                                   |
| **`2.2_V9.6_IngestionAnalyst_and_Tools.md`**            | `IngestionAnalyst` & Tools                                  | A detailed specification for the asynchronous `IngestionAnalyst` worker, its "Single Synthesis Call," and how it publishes events for downstream workers.                                                                                                                                                  |
| **`2.3_V9.6_InsightEngine_and_Tools.md`**               | `InsightEngine` & Tools                                     | A deep dive into the strategic `InsightEngine` worker, its cyclical analysis, and its outputs. This document now references its key dependencies like `InsightDataCompiler`.                                                                                                                        |
| **`2.3.1_V9.6_InsightDataCompiler.md`**                 | `InsightDataCompiler`                                       | A dedicated guide for the `InsightDataCompiler` module, defining its responsibility to build the three distinct input packages (`IngestionActivitySummary`, `GraphAnalysisPackage`, `StrategicInsightPackage`) for the `InsightEngine`.                                                              |
| **`2.4_V9.6_CardWorker_and_CardFactory.md`**            | `CardWorker` & `CardFactory`                                | A dedicated guide for the `CardWorker`, detailing how it consumes events, uses the `CardFactory` service, and creates `Card` records.                                                                                                                                                               |
| **`2.5_V9.6_3D_Cosmos_and_Data_Pipeline.md`**           | 3D Cosmos & Data Pipeline                                   | A dedicated guide for the 3D Knowledge Cosmos, detailing the `GraphProjectionWorker`'s data pipeline, the API for serving projection data, and the frontend's responsibilities.                                                                                                                   |
| **`3.1_V9.6_Database_Schema_Unified.md`**               | Database Schema (Unified)                                   | The single source of truth for all database schemas, including the new `user_graph_projections` table and the unified `InteractionLog`.                                                                                                                                                                |
| **`3.2_V9.6_Context_Packages_and_State.md`**            | Context Packages & State                                    | A detailed manifest of every `Context Package` (e.g., `UserMemoryProfile`), defining its structure, persistence location, and read/write access by agents.                                                                                                                                            |
| **`3.3_V9.6_Event_Queue_Contracts.md`**                 | Event Queue Contracts                                       | **NEW:** The canonical specification for all event types, payload schemas, and worker consumption patterns used in the `card-and-graph-queue`.                                                                                                                                                         |
| **`4.1_V9.6_Tooling_Architecture_and_Registry.md`**     | Tooling Architecture & `ToolRegistry`                       | Defines the V9.x "Configurable Composite Tool" architecture, the role of the `ToolRegistry`, and a catalog of all tools in the system.                                                                                                                                                                |
| **`5.1_V9.6_Monorepo_and_Deployment.md`**                 | Monorepo & Deployment                                       | The definitive V9.x file-level monorepo structure, updated to include all new workers and services (e.g., `graph-projection-worker`, `py-services/dimension-reducer/`).                                                                                                                                  |