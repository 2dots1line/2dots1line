### **`3.2_V9.5_Context_Packages_and_State.md`**

---

# **V9.5 Definitive Manifest: Context Packages & State Propagation**

**Document Version:** 9.5
**Purpose:** To provide a single, canonical reference for all the structured data packages and state mechanisms that enable communication and context propagation between the agents and services of the 2dots1line system. This document answers the questions: "What information is passed?", "Where is it stored?", and "Who reads/writes it?"

## **1. Core Philosophy: The "Inter-Agent Message Board"**

The 2dots1line system's intelligence emerges from a multi-layered communication system where specialized agents leave persistent and ephemeral **Context Packages** for each other and for their future selves. This solves the "forgetful LLM" problem by creating an evolving **Shared State**, persisted across PostgreSQL and Redis, which informs every interaction across three distinct timescales:

*   **Tactical (Intra-Conversation):** State passed from one turn to the next.
*   **Inter-Conversational:** State passed from the end of one conversation to the start of the next.
*   **Strategic (Cyclical):** State passed from one strategic cycle to the next.

## **2. The Context Packages: A Detailed Manifest**

This is the exhaustive list of all structured context packages in the V9.5 architecture.

---

### **2.1 `CoreIdentity`**

*   **Description:** The global, static definition of the AI's persona, operational mandate, rules, and core methodologies (e.g., the 6D Growth Matrix). It is the "Operating System" of Dot.
*   **Source:** `config/CoreIdentity.yaml` file.
*   **Storage Location:** Loaded at application startup and **cached permanently in Redis** under a well-known key (e.g., `config:core_identity`).
*   **Written By:** `OntologySteward` (or a startup service) loads it into Redis.
*   **Read By:**
    *   `PromptBuilder`: For the `DialogueAgent`.
    *   `HolisticAnalysisTool`: For the `IngestionAnalyst`.
    *   `StrategicSynthesisTool`: For the `InsightEngine`.
*   **Purpose:** Ensures consistent persona and rule-adherence for all LLM interactions across the entire system.

---

### **2.2 `UserMemoryProfile`**

*   **Description:** A comprehensive, synthesized JSON summary of the user's core identity, stated goals, active struggles, emergent themes, and key relationships as understood by the system.
*   **Storage Location:** PostgreSQL, `users.memory_profile` (JSONB field).
*   **Written By:** The **`InsightEngine`** at the end of each slow cycle. It overwrites the previous profile with a new, updated version.
*   **Read By:**
    *   `PromptBuilder`: To provide strategic, long-term context to the `DialogueAgent`.
    *   `HolisticAnalysisTool`: To provide context to the `IngestionAnalyst` for more accurate entity extraction and importance scoring.
*   **Purpose:** The primary source of **long-term strategic context**. It allows agents to interact with the user without needing to re-read their entire history every time.

---

### **2.3 `KnowledgeGraphSchema` (The "Personalized API Docs")**

*   **Description:** A user-specific, dynamically generated JSON object detailing the most prominent and relevant parts of *that user's* knowledge graph structure. It includes prominent node/relationship types, key properties, and guidelines for generating queries and new entities.
*   **Storage Location:** PostgreSQL, `users.knowledge_graph_schema` (JSONB field).
*   **Written By:** The **`InsightEngine`** at the end of each slow cycle. It refines the schema based on the user's activity during the cycle.
*   **Read By:**
    *   `PromptBuilder`: For the `DialogueAgent`'s LLM to understand the "API" it can query.
    *   `HolisticAnalysisTool`: For the `IngestionAnalyst`'s LLM to ensure new entities conform to valid types and labels.
    *   `InsightEngine`: Reads the *previous* cycle's schema as an input for generating the *updated* schema.
*   **Purpose:** To equip the LLMs with a "map" of the user's graph, enabling them to generate valid queries and structured data.

---

### **2.4 `NextConversationContextPackage`**

*   **Description:** The "debrief memo" or "handoff notes" generated at the end of a conversation, designed to perfectly tee up the *next* conversation. It contains a proactive greeting, unresolved topics, and a suggested initial focus.
*   **Storage Location:** PostgreSQL, `users.next_conversation_context_package` (JSONB field).
*   **Written By:** The **`IngestionAnalyst`** (via the `HolisticAnalysisTool`) at the end of its processing for a completed conversation. It overwrites the previous package.
*   **Read By:** The **`PromptBuilder`**, but **only for the first turn** of a new conversation.
*   **Purpose:** To provide seamless **inter-conversational context**, making the AI feel like it remembers where the last conversation left off.

---

### **2.5 `TurnContextPackage` (The "Ephemeral Sticky Note")**

*   **Description:** A lean, tactical JSON object containing state that needs to be passed from one conversational turn to the very next one. It holds the `DialogueAgent`'s immediate intentions.
*   **Storage Location:** **Redis**, under a key with a TTL (e.g., `turn_context:{conversationId}`). The TTL is aligned with the conversation timeout (e.g., 5-10 minutes).
*   **Written By:** The **`DialogueAgent`'s LLM** generates this package as part of its output on every turn. The `DialogueAgent` code is responsible for writing it to Redis.
*   **Read By:** The **`PromptBuilder`** on every turn *except the first* to inform the next LLM call.
*   **Purpose:** To provide tactical, **intra-conversational context** and state management (e.g., maintaining focus, adopting a specific tone) without cluttering the main database. Its ephemeral nature is key.

---

### **2.6 `AugmentedMemoryContext`**

*   **Description:** A structured JSON object containing the detailed, hydrated content (from PostgreSQL) of all knowledge entities retrieved by the `HybridRetrievalTool`. It is NOT a persistent context package.
*   **Storage Location:** **In-memory only.** It is generated on-demand and exists only for the duration of a single `DialogueAgent` turn.
*   **Generated By:** The **`HybridRetrievalTool`**.
*   **Consumed By:** The **`DialogueAgent`**, which passes it to the `PromptBuilder` for inclusion in the second-stage LLM call during a retrieval turn.
*   **Purpose:** To provide the LLM with the specific, rich information it requested when it made a `query_memory` decision.

---

### **2.7 `CompiledCycleData`**

*   **Description:** A comprehensive, structured JSON object that aggregates all relevant user activity and graph analysis from a completed cycle. It is the "raw ingredient" package for the `InsightEngine`.
*   **Storage Location:** **In-memory only.** It is assembled by the `InsightEngine` worker at the beginning of a cycle job and exists only for the duration of that job.
*   **Generated By:** The **`InsightEngine` worker**, by executing all queries in the `InsightQueryLibrary`.
*   **Consumed By:** The **`InsightEngine`'s LLM** (via the `StrategicSynthesisTool`).
*   **Purpose:** To provide the strategic LLM call with a complete, deterministic, and structured snapshot of all necessary information for its synthesis task.

## **3. Data Propagation Flow Summary**

This table summarizes the lifecycle of each context package.

| Package Name                       | Written By           | Where It's Stored                               | Read By              | Read Frequency    | Lifespan/Volatility          |
| :--------------------------------- | :------------------- | :----------------------------------------------- | :------------------- | :---------------- | :--------------------------- |
| `CoreIdentity`                     | `OntologySteward`    | Redis `config:core_identity`                     | All Agents           | Every LLM Call    | Static (App Lifetime)        |
| `UserMemoryProfile`                | `InsightEngine`      | PG `User.memory_profile`                         | `DialogueAgent`, `IngestionAnalyst` | Per Turn / Per Convo | Low (Updates Cyclically)     |
| `KnowledgeGraphSchema`             | `InsightEngine`      | PG `User.knowledge_graph_schema`                 | All Agents           | Every LLM Call    | Low (Updates Cyclically)     |
| `NextConversationContextPackage`   | `IngestionAnalyst`   | PG `User.next_conversation_context_package`      | `DialogueAgent`      | Once per Convo    | Medium (Updates per Convo)   |
| **`TurnContextPackage`**           | **`DialogueAgent`**  | **Redis `turn_context:{convoId}`**               | **`DialogueAgent`**  | **Once per Turn** | **High (Ephemeral, TTL)**    |
| `AugmentedMemoryContext`           | `HybridRetrievalTool`| In-Memory                                        | `DialogueAgent`      | On-Demand         | Ephemeral (Single Turn)      |
| `CompiledCycleData`                | `InsightEngine`      | In-Memory                                        | `InsightEngine`      | Once per Cycle    | Ephemeral (Single Job)       |

This detailed manifest provides a clear and unambiguous map of the state propagation system that forms the cognitive backbone of the V9.5 architecture.