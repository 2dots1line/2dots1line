### **`3.2_V9.6_Context_Packages_and_State.md`**

---

# **V9.6 Definitive Guide: Context Packages & State Management**

**Document Version:** 9.6
**Purpose:** To provide a detailed manifest of every `Context Package` used throughout the 2dots1line system, defining their structure, persistence location, lifecycle, and read/write access patterns.

## **1. Context Package Philosophy**

Context Packages are structured data objects that carry rich, contextual information between different components of the system. They represent the "working memory" of various agents and services, ensuring that each component has access to the precise information it needs for optimal decision-making.

**Key Principles:**
*   **Structured & Typed:** All context packages are defined with TypeScript interfaces and validated with Zod schemas
*   **Scoped Access:** Each package has clearly defined read/write permissions
*   **Lifecycle Management:** Packages have explicit creation, update, and cleanup patterns
*   **Performance Optimized:** Critical packages are cached in Redis for fast access

---

## **2. Core Context Packages**

### **2.1 `UserMemoryProfile`**

*   **Purpose:** The strategic, high-level synthesis of a user's identity, goals, and growth trajectory
*   **Generated By:** `InsightEngine` worker at the end of each cycle
*   **Storage:** PostgreSQL `User.memory_profile` (JSONB field)
*   **Accessed By:** `PromptBuilder` (for all agents), `InsightDataCompiler`
*   **Lifecycle:** Updated cyclically, persisted indefinitely

```typescript
interface UserMemoryProfile {
  version: string; // "9.6"
  last_updated: string; // ISO8601 timestamp
  
  identity_synthesis: {
    core_values: Array<{
      name: string;
      description: string;
      salience: number; // 0.0-1.0
      supporting_evidence: string[];
    }>;
    life_themes: Array<{
      name: string;
      description: string;
      current_status: "emerging" | "active" | "evolving" | "dormant";
      connection_to_goals: string[];
    }>;
    growth_trajectory: {
      primary_focus_areas: string[];
      recent_breakthroughs: string[];
      persistent_challenges: string[];
      six_dimensional_snapshot: Record<string, number>; // know_self, act_world, etc.
    };
  };
  
  strategic_context: {
    active_goals: Array<{
      goal_id: string;
      name: string;
      status: "active" | "stalled" | "achieved";
      priority: "high" | "medium" | "low";
      progress_indicators: string[];
      blockers: string[];
    }>;
    key_relationships: Array<{
      person_name: string;
      relationship_type: string;
      interaction_context: string;
      emotional_valence: "positive" | "neutral" | "negative" | "complex";
    }>;
    current_projects: Array<{
      project_name: string;
      status: string;
      key_milestones: string[];
      associated_concepts: string[];
    }>;
  };
  
  knowledge_preferences: {
    preferred_learning_style: string;
    effective_growth_strategies: string[];
    resource_accessibility: {
      time_availability: string;
      financial_constraints: string;
      technology_comfort: string;
      social_support: string;
    };
    communication_preferences: {
      tone: string;
      depth_level: string;
      interaction_style: string;
    };
  };
  
  contextual_flags: {
    current_life_phase: string;
    stress_indicators: string[];
    energy_patterns: string[];
    motivation_drivers: string[];
  };
}
```

### **2.2 `KnowledgeGraphSchema`**

*   **Purpose:** User-specific "API documentation" for LLMs to understand and interact with the user's knowledge graph
*   **Generated By:** `InsightEngine` worker, updated based on graph evolution and effective query patterns
*   **Storage:** PostgreSQL `User.knowledge_graph_schema` (JSONB field)
*   **Accessed By:** All agent LLMs for query formulation and entity validation
*   **Lifecycle:** Updated cyclically, persisted indefinitely

```typescript
interface KnowledgeGraphSchema {
  user_id: string;
  schema_version: string; // "9.6"
  last_updated_by_insight_engine_at: string; // ISO8601
  description_for_llm: string;
  
  prominent_node_types: Array<{
    label: string; // "MemoryUnit", "Concept", etc.
    description_for_llm: string;
    key_properties_for_query_and_creation: Array<{
      name: string;
      type: string;
      description: string;
    }>;
    prominent_concept_sub_types_for_user?: string[]; // For Concept nodes
    common_relationships_for_llm: Array<{
      type: string;
      direction: "INCOMING" | "OUTGOING" | "BIDIRECTIONAL";
      target_label?: string;
      source_label?: string;
      description: string;
    }>;
  }>;
  
  prominent_relationship_types: Array<{
    type: string;
    description_for_llm: string;
    roles_for_llm: string;
    key_properties_for_query_and_creation: Array<{
      name: string;
      type: string;
      description: string;
    }>;
    prominent_relationship_sub_labels_for_user?: string[];
  }>;
  
  example_cypher_queries_personalized: Array<{
    description_for_llm: string;
    query_template_for_llm_adaptation: string;
  }>;
  
  universal_core_entity_types: string[];
  universal_concept_types: string[];
  universal_relationship_labels: string[];
  
  ontology_update_guidelines_for_llm: string[];
}
```

### **2.3 `TurnContextPackage`**

*   **Purpose:** Ephemeral turn-to-turn state for DialogueAgent conversations
*   **Generated By:** `DialogueAgent` LLM output, processed by DialogueAgent service
*   **Storage:** Redis `turn_context:{conversationId}` with TTL aligned to conversation timeout
*   **Accessed By:** `PromptBuilder` (next turn), `IngestionAnalyst` (context for analysis)
*   **Lifecycle:** Created/updated each turn, expires with conversation

```typescript
interface TurnContextPackage {
  conversation_id: string;
  created_at: string; // ISO8601
  last_updated_at: string; // ISO8601
  
  suggested_next_focus: string; // "Explore user's feelings about the feedback received"
  emotional_tone_to_adopt: string; // "empathetic", "analytical", "encouraging"
  
  flags_for_ingestion: string[]; // ["potential_new_concept:Feedback_Process", "user_expressed_high_confidence"]
  
  contextual_notes: {
    user_energy_level?: string; // "high", "medium", "low", "tired"
    conversation_depth?: string; // "surface", "moderate", "deep", "breakthrough"
    topic_sensitivity?: string; // "neutral", "sensitive", "highly_personal"
    user_engagement?: string; // "active", "passive", "resistant", "enthusiastic"
  };
  
  retrieval_context?: {
    last_query_successful: boolean;
    retrieved_entity_ids: string[];
    unmatched_key_phrases?: string[];
  };
  
  ui_state_hints?: {
    orb_state_preference?: string;
    highlight_cards?: string[];
    cosmos_focus_nodes?: string[];
  };
}
```

### **2.4 `NextConversationContextPackage`**

*   **Purpose:** Forward-looking context prepared by IngestionAnalyst for the next conversation
*   **Generated By:** `IngestionAnalyst` worker's `HolisticAnalysisTool`
*   **Storage:** PostgreSQL `User.next_conversation_context_package` (JSONB field)
*   **Accessed By:** `PromptBuilder` (start of new conversations)
*   **Lifecycle:** Updated after each conversation analysis, consumed at conversation start

```typescript
interface NextConversationContextPackage {
  generated_at: string; // ISO8601
  source_conversation_id: string;
  
  proactive_greeting: string;
  
  unresolved_topics_for_next_convo: Array<{
    topic: string;
    summary_of_unresolution: string;
    suggested_question: string;
    priority: "high" | "medium" | "low";
  }>;
  
  suggested_initial_focus: string;
  
  conversation_insights: {
    key_breakthroughs?: string[];
    emotional_patterns?: string[];
    emerging_themes?: string[];
    growth_opportunities?: string[];
  };
  
  recommended_follow_ups: Array<{
    type: "question" | "reflection" | "action" | "exploration";
    content: string;
    rationale: string;
  }>;
}
```

### **2.5 `EffectiveQueryPatternsData`** *(New - V9.6)*

*   **Purpose:** Analysis of successful query patterns used by DialogueAgent for KGS optimization
*   **Generated By:** `InsightEngine` worker by analyzing historical DialogueAgent interactions
*   **Storage:** Computed during insight cycles, passed to StrategicSynthesisTool
*   **Accessed By:** `StrategicSynthesisTool` for KGS regeneration
*   **Lifecycle:** Generated per cycle, used for KGS updates

```typescript
interface EffectiveQueryPatternsData {
  analysis_period: {
    start_date: string; // ISO8601
    end_date: string; // ISO8601
    total_queries_analyzed: number;
  };
  
  successful_query_patterns: Array<{
    query_template: string; // Generalized version of successful queries
    usage_frequency: number;
    average_retrieval_success_rate: number;
    common_parameters: Record<string, any>;
    typical_scenarios: string[];
  }>;
  
  failed_query_patterns: Array<{
    attempted_pattern: string;
    failure_reasons: string[];
    frequency: number;
    suggested_improvements: string[];
  }>;
  
  retrieval_scenario_effectiveness: Record<string, {
    usage_count: number;
    success_rate: number;
    average_result_count: number;
    user_satisfaction_indicators: string[];
  }>;
  
  personalized_query_insights: {
    most_accessed_entity_types: string[];
    preferred_query_complexity: "simple" | "moderate" | "complex";
    temporal_query_preferences: string[];
    semantic_query_preferences: string[];
  };
  
  recommendations_for_kgs_update: Array<{
    recommendation_type: "add_query_template" | "modify_existing" | "deprecate_template";
    details: string;
    priority: "high" | "medium" | "low";
  }>;
}
```

---

## **3. Specialized Context Packages**

### **3.1 `AugmentedMemoryContext`**

*   **Purpose:** Rich retrieval results from HybridRetrievalTool for DialogueAgent's contextual responses
*   **Generated By:** `HybridRetrievalTool.execute()`
*   **Storage:** Ephemeral - passed directly between tool and agent
*   **Accessed By:** `DialogueAgent` LLM (second synthesis call)
*   **Lifecycle:** Generated per retrieval request, discarded after use

```typescript
interface AugmentedMemoryContext {
  retrieved_memory_units: Array<MemoryUnitRetrievalResult>;
  retrieved_concepts: Array<ConceptRetrievalResult>;
  retrieved_artifacts: Array<ArtifactRetrievalResult>;
  
  retrieval_summary: string; // Deterministic summary of retrieval process
  
  scoring_details?: {
    total_candidates_considered: number;
    seed_entities_identified_from_key_phrases: number;
    graph_traversal_depth_used: number;
    weights_used: {
      alpha_semantic_similarity: number;
      beta_recency: number;
      gamma_salience: number;
      delta_user_preference: number;
    };
  };
  
  unmatched_key_phrases: string[];
  
  errors?: Array<{ // V9.6: Added error handling
    stage: "Weaviate" | "Neo4j" | "PostgreSQL" | "Scoring";
    error: string;
    impact: "partial_results" | "degraded_quality" | "fallback_used";
  }>;
}

interface MemoryUnitRetrievalResult {
  muid: string;
  title: string;
  content_snippet: string;
  creation_ts: string;
  source_type: string;
  importance_score: number;
  final_retrieval_score: number;
  score_breakdown?: {
    semantic: number;
    recency: number;
    salience: number;
    preference: number;
  };
  connected_concept_ids_and_names: Array<{
    id: string;
    name: string;
  }>;
}

interface ConceptRetrievalResult {
  id: string;
  name: string;
  type: string;
  description_snippet: string;
  status: string;
  salience: number;
  final_retrieval_score: number;
  score_breakdown?: Record<string, number>;
  related_top_memory_unit_ids_and_titles: Array<{
    id: string;
    title: string;
  }>;
  key_properties_values?: Record<string, any>;
}

interface ArtifactRetrievalResult {
  id: string;
  artifact_type: string;
  title: string;
  content_snippet: string;
  created_at: string;
  final_retrieval_score: number;
  score_breakdown?: Record<string, number>;
}
```

---

## **4. Context Package Access Patterns**

### **4.1 Read/Write Matrix**

| Context Package | DialogueAgent | IngestionAnalyst | InsightEngine | CardWorker | Other |
|-----------------|---------------|------------------|---------------|------------|-------|
| UserMemoryProfile | Read | Read | Read/Write | Read | - |
| KnowledgeGraphSchema | Read | Read | Read/Write | - | - |
| TurnContextPackage | Read/Write | Read | - | - | - |
| NextConversationContextPackage | Read | Write | - | - | - |
| EffectiveQueryPatternsData | - | - | Read/Write | - | - |
| AugmentedMemoryContext | Read | - | - | - | - |

### **4.2 State Synchronization**

**Real-time vs. Async Coordination:**
*   **DialogueAgent** queries source of truth (PostgreSQL/Neo4j) for real-time consistency
*   **User-specific Redis lock** (`user_lock:{userId}`) prevents write conflicts during InsightEngine cycles
*   **IngestionAnalyst** defers updates if user lock is present
*   **Eventual consistency** model ensures all workers see updates after cycle completion

**Race Condition Prevention:**
*   InsightEngine acquires exclusive lock for cycle duration
*   PromptBuilder reads User.memory_profile on every turn for latest strategic context
*   TurnContextPackage uses Redis TTL aligned with conversation timeouts
*   WebSocket events notify frontend of new cards and updates

---

## **5. Validation and Type Safety**

### **5.1 Zod Schemas**

```typescript
// packages/shared-types/src/context/schemas.ts
export const UserMemoryProfileSchema = z.object({
  version: z.string(),
  last_updated: z.string(),
  identity_synthesis: z.object({
    core_values: z.array(z.object({
      name: z.string(),
      description: z.string(),
      salience: z.number().min(0).max(1),
      supporting_evidence: z.array(z.string())
    })),
    // ... rest of schema
  }),
  // ... complete schema definition
});

export const TurnContextPackageSchema = z.object({
  conversation_id: z.string(),
  created_at: z.string(),
  last_updated_at: z.string(),
  suggested_next_focus: z.string(),
  emotional_tone_to_adopt: z.string(),
  flags_for_ingestion: z.array(z.string()),
  contextual_notes: z.object({
    user_energy_level: z.string().optional(),
    conversation_depth: z.string().optional(),
    topic_sensitivity: z.string().optional(),
    user_engagement: z.string().optional()
  }).optional(),
  retrieval_context: z.object({
    last_query_successful: z.boolean(),
    retrieved_entity_ids: z.array(z.string()),
    unmatched_key_phrases: z.array(z.string()).optional()
  }).optional(),
  ui_state_hints: z.object({
    orb_state_preference: z.string().optional(),
    highlight_cards: z.array(z.string()).optional(),
    cosmos_focus_nodes: z.array(z.string()).optional()
  }).optional()
});

export const EffectiveQueryPatternsDataSchema = z.object({
  analysis_period: z.object({
    start_date: z.string(),
    end_date: z.string(),
    total_queries_analyzed: z.number()
  }),
  successful_query_patterns: z.array(z.object({
    query_template: z.string(),
    usage_frequency: z.number(),
    average_retrieval_success_rate: z.number(),
    common_parameters: z.record(z.any()),
    typical_scenarios: z.array(z.string())
  })),
  // ... complete schema
});
```

This comprehensive context package system provides a structured, type-safe foundation for all inter-component communication while maintaining clear boundaries and lifecycle management.