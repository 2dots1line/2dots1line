### **`4.1_V9.5_Tooling_Architecture_and_Registry.md`**

---

# **V9.5 Definitive Guide: Tooling Architecture & `ToolRegistry`**

**Document Version:** 9.5
**Purpose:** To define the system's tooling architecture, the role and implementation of the `ToolRegistry`, the distinction between different tool types, and to provide a comprehensive catalog of all tools available to the agents.

## **1. Core Philosophy: The "Configurable Composite Tool" Architecture**

The V9.5 tooling architecture provides a powerful blend of flexibility, efficiency, and maintainability. It is built on the following principles:

*   **Configuration, Not Dynamic Discovery:** Agents do not dynamically search for tools at runtime. Instead, their core capabilities are assembled at initialization time based on a central configuration file.
*   **Separation of Concerns:** The architecture distinguishes between:
    *   **Atomic Tools:** Simple, reusable, single-purpose components (e.g., call an LLM, caption an image).
    *   **Composite Tools:** Higher-level orchestrators that bundle atomic tools to perform a complex, agent-specific synthesis task (e.g., analyze a whole conversation).
    *   **Specialized Tools:** Complex, standalone utilities with a broad set of internal logic (`HybridRetrievalTool`).
*   **Centralized Factory & Repository:** A single `ToolRegistry` service acts as the central repository for all atomic tools and the factory for building composite tools.

This approach allows us to easily swap underlying implementations (e.g., changing from Google's LLM to DeepSeek's) by changing a single line in a configuration file, without ever touching the core agent logic.

## **2. The `ToolRegistry` (The Factory & Repository)**

**Location:** `packages/tool-registry/src/ToolRegistry.ts`

The `ToolRegistry` is a singleton service initialized at application startup.

### **Responsibilities:**

1.  **Catalog Atomic Tools:** On startup, it scans the `packages/tools/` directory (specifically subdirectories like `ai/` and `data/`) and registers every available atomic tool. Each tool must export a unique `name` (e.g., `ai:llm:chat:google_gemini_1.5_pro`) and its class definition.
2.  **Provide Atomic Tools:** It exposes a `getAtomicTool<T>(toolName: string): T` method to provide a specific, instantiated atomic tool to any service that needs it (like the `DialogueAgent`).
3.  **Build Composite Tools:** It exposes a `buildCompositeToolForAgent(agentName)` method. This is its factory function.

### **`buildCompositeToolForAgent` Workflow:**

1.  **Input:** Takes an agent name (e.g., `'ingestionAnalyst'` or `'insightEngine'`).
2.  **Read Config:** It reads the `config/tool_composition.json` file.
3.  **Find Agent Config:** It locates the configuration block for the specified `agentName`.
4.  **Instantiate Composite Tool:** It dynamically finds the composite tool class specified in `compositeToolClassName` (e.g., `HolisticAnalysisTool`).
5.  **Inject Atomic Tools:** It iterates through the `atomicTools` map in the config. For each entry (e.g., `"llmChatTool": "ai:llm:chat:google_gemini_1.5_pro"`), it calls its own `getAtomicTool()` method to get an instance of the specified atomic tool.
6.  **Return Assembled Tool:** It passes the instantiated atomic tools into the constructor of the composite tool and returns the fully configured instance to the agent worker.

## **3. The Configuration File: `config/tool_composition.json`**

This file is the "loadout" that defines which atomic tools are used to build the composite tools for the batch-processing agents.

**Location:** `config/tool_composition.json`

**V9.5 Structure:**
```json
{
  "ingestionAnalyst": {
    "compositeToolClassName": "HolisticAnalysisTool",
    "atomicTools": {
      "llmChatTool": "ai:llm:chat:google_gemini_1.5_pro"
    }
  },
  "insightEngine": {
    "compositeToolClassName": "StrategicSynthesisTool",
    "atomicTools": {
      "synthesisLlmTool": "ai:llm:chat:deepseek_v2_pro_strategic"
    }
  }
}
```
*Note: The `DialogueAgent` is **not** configured here. Its tools are directly injected at the service level due to its complex, real-time orchestration needs.*

## **4. Definitive Tool Catalog (V9.5)**

This is the exhaustive inventory of all tools in the system.

---

### **Part I: Atomic Tools**
*Registered in `ToolRegistry`. Live in `packages/tools/`.*

| Tool Class Name           | Location (`packages/tools/`) | Unique Name (Example)                       | Purpose                                                                                                          | Injected Into...                                                 |
| :------------------------ | :--------------------------- | :------------------------------------------ | :--------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------- |
| `LLMChatTool`             | `ai/LLMChatTool.ts`          | `ai:llm:chat:google_gemini_1.5_pro`         | Standardized interface for making API calls to a specific external LLM.                                          | `HolisticAnalysisTool`, `StrategicSynthesisTool`, `DialogueAgent`|
| `TextEmbeddingTool`       | `ai/TextEmbeddingTool.ts`    | `ai:embedding:text:google_gecko_v1`         | Takes text and returns its vector embedding.                                                                     | `IngestionAnalyst` (for Weaviate), `HybridRetrievalTool`          |
| `VisionCaptionTool`       | `ai/VisionCaptionTool.ts`    | `ai:vision:caption:default`                 | Takes an image URL and returns a descriptive text caption.                                                       | `DialogueAgent`                                                  |
| `AudioTranscribeTool`     | `data/AudioTranscribeTool.ts`| `data:audio:transcribe:default`             | Takes an audio URL and returns its transcript.                                                                   | `DialogueAgent`                                                  |
| `DocumentExtractTool`     | `data/DocumentExtractTool.ts`| `data:document:extract:default`             | Takes a document URL (PDF, DOCX) and returns its text content.                                                   | `DialogueAgent`                                                  |
| `CypherQueryExecutorTool` | `data/CypherQueryExecutorTool.ts` | `data:graph:cypher_executor:v1` | A safe executor for running parameterized Cypher queries against Neo4j.                                          | `InsightEngine` (the worker, after LLM generates queries) |

---

### **Part II: Composite Tools**
*Built by `ToolRegistry`. Live in `packages/tools/composite/`.*

| Tool Class Name              | Location (`packages/tools/`) | Core Task                                                                                                                  | Used By             |
| :--------------------------- | :--------------------------- | :------------------------------------------------------------------------------------------------------------------------- | :------------------ |
| `HolisticAnalysisTool`       | `composite/HolisticAnalysisTool.ts` | Encapsulates the "Single Synthesis Call" for analyzing a completed conversation. (Full spec: `3.2_V9.5_HolisticAnalysisTool.md`) | `IngestionAnalyst`  |
| `StrategicSynthesisTool`     | `composite/StrategicSynthesisTool.ts` | Encapsulates the "Single Synthesis Call" for performing cyclical strategic analysis. (Full spec: `4.2_V9.5_StrategicSynthesisTool.md`) | `InsightEngine`     |

---

### **Part III: Specialized Tools & Services**
*Instantiated directly via dependency injection. Not managed by `tool_composition.json`.*

| Tool/Service Name       | Location (`packages/` or `services/`)    | Core Task                                                                                                                          | Used By         |
| :---------------------- | :--------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------- | :-------------- |
| **`HybridRetrievalTool`** | **`tools/retrieval/HybridRetrievalTool.ts`** | The sophisticated, multi-stage retrieval engine that orchestrates Weaviate -> Neo4j -> PostgreSQL lookups based on key phrases. | `DialogueAgent` |
| `PromptBuilder`         | `services/dialogue-service/src/`         | The dedicated service that assembles the comprehensive, real-time system prompt for the `DialogueAgent`.                               | `DialogueAgent` |
| `CardFactory`           | `services/card-service/src/`             | The deterministic service that creates `Card` records based on eligibility rules.                                                  | `CardWorker`    |
| `InsightQueryLibrary`   | `database/src/neo4j/queries/`            | A library of deterministic Cypher queries used by the `InsightEngine` worker to build the `CompiledCycleData`.                   | `InsightEngine` |

## **5. Architectural Flow Example: `IngestionAnalyst` Tooling**

1.  **Startup:** The `ToolRegistry` is initialized. It finds and registers the `LLMChatTool` under the name `"ai:llm:chat:google_gemini_1.5_pro"`.
2.  **Worker Init:** The `ingestion-worker` starts. Its main `IngestionAnalyst` class is instantiated.
3.  **Build Composite Tool:** In its constructor, the `IngestionAnalyst` calls `this.toolRegistry.buildCompositeToolForAgent('ingestionAnalyst')`.
4.  **Factory Action:**
    *   The `ToolRegistry` reads `config/tool_composition.json`.
    *   It finds the `"ingestionAnalyst"` key.
    *   It sees it needs to create a `HolisticAnalysisTool`.
    *   It sees that the `llmChatTool` property of this composite tool should be the atomic tool named `"ai:llm:chat:google_gemini_1.5_pro"`.
    *   It calls its internal `getAtomicTool()` method to get the `LLMChatTool` instance.
    *   It creates a new `HolisticAnalysisTool`, passing the `LLMChatTool` instance into its constructor: `new HolisticAnalysisTool(llmToolFromRegistry)`.
5.  **Operation:** The `IngestionAnalyst` now has a fully configured `this.holisticAnalysisTool` instance. When it processes a job, it makes a single call: `this.holisticAnalysisTool.execute(...)`.

This architecture provides a robust, clear, and highly maintainable system for managing the diverse capabilities of the 2dots1line agents.