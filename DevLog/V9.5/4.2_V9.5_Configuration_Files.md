### **`4.2_V9.6_Configuration_Files.md`**

---

# **V9.6 Definitive Guide: Configuration Files**

**Document Version:** 9.6
**Purpose:** To provide the single, canonical source of truth for all configuration files used throughout the 2dots1line system, including their JSON schemas, validation requirements, and loading mechanisms.

## **1. Configuration Management Architecture**

All configuration files are stored in the `/config/` directory and managed by a centralized `ConfigService` that handles loading, validation, and caching.

### **`ConfigService` Architecture**
```typescript
// packages/core-utils/src/ConfigService.ts
export class ConfigService {
  private static instance: ConfigService;
  private configCache = new Map<string, any>();
  
  // Loads all configurations at startup and caches in Redis
  async loadAllConfigurations(): Promise<void>;
  
  // Validates configuration against Zod schema
  private validateConfig<T>(config: unknown, schema: ZodSchema<T>): T;
  
  // Retrieves configuration with type safety
  getConfig<T>(configName: string): T;
}
```

## **2. Core Identity Configuration**

### **File:** `config/CoreIdentity.yaml`
**Purpose:** Defines Dot's personality, operational mandate, and contextual protocols.

```yaml
# Version: 9.6
# Updated to explicitly reference UserMemoryProfile integration

persona:
  name: "Dot"
  archetype: "The Reflected Self as Contextualized Growth Catalyst"
  version: "9.6"

operational_mandate:
  contextualization_protocol:
    - "Resource Awareness Principle: Consult the <user_context> tag in prompts, which contains relevant excerpts from UserMemoryProfile including stated goals, available resources, and current life circumstances."
    - "Knowledge Level Calibration: Use conversation history and <user_context> to infer user's expertise level before recommending frameworks or resources."
    - "Life Context Integration: Reference family situation, work constraints, and personal values from <user_context> when making recommendations."

# ... rest of CoreIdentity remains as specified in 4.2.1_V9.5_CoreIdentity.md
```

## **3. HybridRetrievalTool Configurations**

### **3.1 Cypher Query Templates**
**File:** `config/cypher_templates.json`
**Purpose:** Pre-defined Cypher query templates for different retrieval scenarios.

```json
{
  "version": "9.6",
  "description": "Cypher query templates for HybridRetrievalTool semantic grounding and graph traversal",
  "templates": {
    "neighborhood": {
      "description": "Retrieves entities and their immediate connections",
      "template": "MATCH (seed {userId: $userId}) WHERE seed.id IN $seedEntityIds WITH seed MATCH (seed)-[:RELATED_TO|HIGHLIGHTS*1..$maxHops]-(related {userId: $userId}) RETURN COLLECT(DISTINCT {id: related.id, type: labels(related)[0], salience: related.salience}) AS allRelevantEntities ORDER BY related.salience DESC LIMIT $limit",
      "allowedParams": ["userId", "seedEntityIds", "maxHops", "limit"],
      "defaultParams": { "maxHops": 2, "limit": 20 }
    },
    "timeline": {
      "description": "Retrieves entities with temporal relationships",
      "template": "MATCH (mu:MemoryUnit {userId: $userId}) WHERE mu.creation_ts >= $startDate AND mu.creation_ts <= $endDate RETURN COLLECT(DISTINCT {id: mu.muid, type: 'MemoryUnit', creation_ts: mu.creation_ts}) AS allRelevantEntities ORDER BY mu.creation_ts DESC LIMIT $limit",
      "allowedParams": ["userId", "startDate", "endDate", "limit"],
      "defaultParams": { "limit": 15 }
    },
    "conceptsByTheme": {
      "description": "Discovers thematically related concepts",
      "template": "MATCH (c1:Concept {userId: $userId})-[:RELATED_TO*1..$hops]-(c2:Concept {userId: $userId}) WHERE c1.type = $conceptType RETURN COLLECT(DISTINCT {id: c2.concept_id, type: 'Concept', name: c2.name}) AS allRelevantEntities LIMIT $limit",
      "allowedParams": ["conceptType", "hops", "limit", "userId"],
      "defaultParams": { "hops": 2, "limit": 12 }
    },
    "episodesByConcept": {
      "description": "Finds MemoryUnits related to specific concepts",
      "template": "MATCH (c:Concept {concept_id: $conceptId, userId: $userId})<-[:HIGHLIGHTS]-(mu:MemoryUnit {userId: $userId}) RETURN COLLECT(DISTINCT {id: mu.muid, type: 'MemoryUnit', title: mu.title}) AS allRelevantEntities LIMIT $limit",
      "allowedParams": ["conceptId", "userId", "limit"],
      "defaultParams": { "limit": 10 }
    }
  }
}
```

### **3.2 Retrieval Scoring Weights**
**File:** `config/retrieval_weights.json`
**Purpose:** Configurable scoring weights for different retrieval scenarios.

```json
{
  "version": "9.6",
  "description": "Scoring weight configurations for multi-factor entity ranking in HybridRetrievalTool",
  "weight_profiles": {
    "default": {
      "alpha_semantic_similarity": 0.4,
      "beta_recency": 0.25,
      "gamma_salience": 0.25,
      "delta_user_preference": 0.1,
      "description": "Balanced scoring for general retrieval scenarios"
    },
    "recent_focus": {
      "alpha_semantic_similarity": 0.3,
      "beta_recency": 0.5,
      "gamma_salience": 0.15,
      "delta_user_preference": 0.05,
      "description": "Emphasizes recent memories and conversations"
    },
    "high_importance": {
      "alpha_semantic_similarity": 0.3,
      "beta_recency": 0.1,
      "gamma_salience": 0.5,
      "delta_user_preference": 0.1,
      "description": "Prioritizes highly salient concepts and memories"
    },
    "personalized": {
      "alpha_semantic_similarity": 0.25,
      "beta_recency": 0.2,
      "gamma_salience": 0.25,
      "delta_user_preference": 0.3,
      "description": "Heavily weights user preferences and interaction patterns"
    }
  },
  "weight_validation": {
    "sum_must_equal": 1.0,
    "min_value": 0.0,
    "max_value": 1.0
  }
}
```

### **3.3 HRT Operational Configuration**
**File:** `config/hrt_config.json`
**Purpose:** Operational parameters, limits, and timeouts for HybridRetrievalTool.

```json
{
  "version": "9.6",
  "description": "Operational configuration for HybridRetrievalTool execution parameters",
  "processing": {
    "MAX_KEY_PHRASES": 5,
    "MAX_PHRASE_LENGTH": 100,
    "PHRASE_SIMILARITY_THRESHOLD": 0.8,
    "PHRASE_CLEANUP_REGEX": "[^a-zA-Z0-9\\s\\-_]"
  },
  "weaviate": {
    "RESULTS_PER_PHRASE": 3,
    "SIMILARITY_THRESHOLD": 0.1,
    "TIMEOUT_MS": 5000,
    "MAX_RETRIES": 2,
    "BATCH_SIZE": 10
  },
  "neo4j": {
    "MAX_RESULT_LIMIT": 100,
    "MAX_GRAPH_HOPS": 3,
    "MAX_SEED_ENTITIES": 10,
    "QUERY_TIMEOUT_MS": 10000,
    "CONNECTION_POOL_SIZE": 10
  },
  "scoring": {
    "TOP_N_CANDIDATES_FOR_HYDRATION": 10,
    "RECENCY_DECAY_RATE": 0.1,
    "MAX_PREFERENCE_BOOST": 2.0,
    "DIVERSITY_THRESHOLD": 0.3,
    "MIN_SCORE_THRESHOLD": 0.05
  },
  "postgresql": {
    "BATCH_SIZE": 50,
    "HYDRATION_TIMEOUT_MS": 8000,
    "MAX_PARALLEL_QUERIES": 5
  },
  "caching": {
    "ENABLE_QUERY_CACHE": true,
    "CACHE_TTL_SECONDS": 300,
    "MAX_CACHE_SIZE_MB": 100
  }
}
```

## **4. Card System Configuration**

### **File:** `config/card_eligibility_rules.json`
**Purpose:** Rules determining when entities become cards and their presentation logic.

```json
{
  "version": "9.6",
  "description": "Rules for CardFactory to determine entity eligibility and card creation logic",
  "eligibility_rules": {
    "MemoryUnit": {
      "min_importance_score": 6.0,
      "exclude_source_types": ["system_generated", "auto_summary"],
      "require_user_interaction": false,
      "cooldown_hours": 24
    },
    "Concept": {
      "min_salience": 0.7,
      "min_connection_count": 2,
      "exclude_types": ["auto_generated"],
      "require_recent_activity": true,
      "activity_window_days": 7
    },
    "DerivedArtifact": {
      "auto_eligible_types": ["insight_summary", "cycle_report", "trophy"],
      "min_content_length": 100,
      "exclude_failed_generations": true
    },
    "ProactivePrompt": {
      "auto_eligible": true,
      "max_active_prompts_per_user": 3,
      "min_hours_between_prompts": 12
    }
  },
  "card_templates": {
    "MemoryUnit": {
      "title_max_length": 60,
      "preview_max_length": 200,
      "show_creation_date": true,
      "show_importance_score": false
    },
    "Concept": {
      "title_format": "{name} ({type})",
      "preview_format": "{description}",
      "show_connection_count": true,
      "show_salience": false
    }
  }
}
```

## **5. Tool Composition Configuration**

### **File:** `config/tool_composition.json`
**Purpose:** Defines how tools are composed and injected into agents and workers.

```json
{
  "version": "9.6",
  "description": "Tool composition configuration for ToolRegistry instantiation",
  "agent_tool_configs": {
    "dialogueAgent": {
      "llmChatTool": {
        "provider": "deepseek",
        "model": "deepseek-v2-pro",
        "max_tokens": 4000,
        "temperature": 0.7
      },
      "hybridRetrievalTool": {
        "default_retrieval_scenario": "neighborhood",
        "default_weight_profile": "default",
        "max_results": 8
      },
      "visionCaptionTool": {
        "provider": "google",
        "model": "gemini-1.5-pro-vision"
      },
      "audioTranscribeTool": {
        "provider": "openai",
        "model": "whisper-1"
      }
    },
    "ingestionAnalyst": {
      "holisticAnalysisTool": {
        "llmChatTool": {
          "provider": "deepseek",
          "model": "deepseek-v2-pro",
          "max_tokens": 6000,
          "temperature": 0.3
        }
      },
      "textEmbeddingTool": {
        "provider": "google",
        "model": "text-embedding-004",
        "batch_size": 100
      }
    },
    "insightEngine": {
      "strategicSynthesisTool": {
        "llmChatTool": {
          "provider": "deepseek",
          "model": "deepseek-v2-pro-strategic",
          "max_tokens": 8000,
          "temperature": 0.2
        }
      }
    }
  },
  "tool_registry_config": {
    "enable_tool_metrics": true,
    "enable_tool_caching": true,
    "tool_timeout_ms": 30000,
    "max_concurrent_tools": 10
  }
}
```

## **6. Knowledge Graph Meta Schema**

### **File:** `config/knowledge_graph_meta_schema.json`
**Purpose:** Global vocabulary and constraints for all knowledge graphs.

```json
{
  "version": "9.8",
  "description": "Master schema defining all valid node types, properties, and relationships",
  "node_labels": ["User", "MemoryUnit", "Concept", "DerivedArtifact", "Community", "ProactivePrompt", "Card"],
  "concept_types": [
    "person", "organization", "location", "project", "goal", "value",
    "skill", "interest", "emotion_positive", "emotion_negative", "theme",
    "event_theme", "role", "challenge_topic", "strength", "weakness", 
    "book", "artwork", "tool", "framework", "principle", "habit"
  ],
  "relationship_types": ["HIGHLIGHTS", "RELATED_TO", "BELONGS_TO_COMMUNITY", "INFLUENCES", "SUPPORTS"],
  "relationship_label_guidelines": {
    "description": "Guidelines for LLMs generating relationship_label strings for the RELATED_TO type.",
    "format": "Should be a concise, human-readable, verb-based phrase (e.g., 'is motivated by', 'is an obstacle to').",
    "style": "Use present tense. Be as specific as the context allows.",
    "examples": ["expresses emotion about", "is a core part of", "has skill in", "is a goal of"]
  },
  "required_properties": {
    "MemoryUnit": ["muid", "userId", "title", "content", "creation_ts"],
    "Concept": ["concept_id", "userId", "name", "type", "status"],
    "DerivedArtifact": ["artifact_id", "userId", "artifact_type", "created_at"]
  },
  "validation_rules": {
    "concept_name_max_length": 100,
    "relationship_label_max_length": 50,
    "description_max_length": 500
  }
}
```

## **7. Configuration Loading and Validation**

### **Zod Validation Schemas**
```typescript
// packages/core-utils/src/config/schemas.ts
export const CypherTemplatesSchema = z.object({
  version: z.string(),
  description: z.string(),
  templates: z.record(z.object({
    description: z.string(),
    template: z.string(),
    allowedParams: z.array(z.string()),
    defaultParams: z.record(z.any()).optional()
  }))
});

export const RetrievalWeightsSchema = z.object({
  version: z.string(),
  weight_profiles: z.record(z.object({
    alpha_semantic_similarity: z.number().min(0).max(1),
    beta_recency: z.number().min(0).max(1),
    gamma_salience: z.number().min(0).max(1),
    delta_user_preference: z.number().min(0).max(1),
    description: z.string()
  }).refine(data => 
    Math.abs((data.alpha_semantic_similarity + data.beta_recency + 
             data.gamma_salience + data.delta_user_preference) - 1.0) < 0.001,
    { message: "Weight values must sum to 1.0" }
  ))
});
```

This comprehensive configuration system provides type-safe, validated access to all system configurations while maintaining clear separation of concerns and enabling easy testing and deployment.