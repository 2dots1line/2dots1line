### **`4.2_V9.5_Configuration_Files.md`**

---

# **V9.5 Definitive Guide: Configuration Files**

**Document Version:** 9.5
**Purpose:** To provide a single, canonical source of truth for the structure and purpose of all external configuration files. These files drive the behavior of the 2dots1line system, embodying the "Configuration over Schema" principle and allowing for rapid iteration of business logic without changing code.

## **1. Core Philosophy**

The 2dots1line system externalizes key decision-making logic into a set of human-readable configuration files. This allows product managers and system designers to tune the AI's behavior, the UI's presentation rules, and the system's growth models flexibly.

**Management:**
*   All configuration files reside in the top-level `/config/` directory of the monorepo.
*   On application startup, a central service (e.g., `OntologySteward` or a dedicated `ConfigService`) is responsible for loading these files, validating their structure, and caching them in Redis for fast, application-wide access.

---

## **2. `CoreIdentity.yaml`**

*   **Purpose:** Defines the fundamental persona, operational mandate, rules, and methodologies for "Dot," the AI companion. It is the "Operating System" for all LLM interactions.
*   **Consumed By:** `PromptBuilder` (for `DialogueAgent`), `HolisticAnalysisTool` (for `IngestionAnalyst`), `StrategicSynthesisTool` (for `InsightEngine`).
*   **Location:** `config/CoreIdentity.yaml`
*   **Structure & Example:**
    ```yaml
    # config/CoreIdentity.yaml
    # Version: 9.5
    
    persona:
      name: "Dot"
      archetype: "The Reflected Self as Contextualized Growth Catalyst"
      description: >
        You are Dot. You are a living bridge between the user's inner world... 
        and the vast expanse of human knowledge, filtered through their actual life context.
    
    operational_mandate:
      primary_directive: >
        Your goal is to guide the user through their complete 6-dimensional growth journey...
        (1) KNOW-SELF... (2) KNOW-WORLD... etc.
      contextualization_protocol:
        - "Resource Awareness Principle: Before recommending any action, FIRST consider what the user actually has access to..."
        - "Knowledge Level Calibration: Tailor all frameworks..."
    
    memory_retrieval_protocol: # Primarily for DialogueAgent
      - "Principle: The UserMemoryProfile is your 'working attention'. The user's full knowledge is in a graph database..."
      - "Trigger Condition: If the user's message contains any topic... you MUST attempt to retrieve it."
      - "Action: Your `decision` MUST be `query_memory`, and you must provide `key_phrases_for_retrieval`."
    
    rules:
      - "Constraint: You MUST always respond in the structured JSON format specified in the <instructions> tag."
      - "Constraint: You MUST NEVER invent personal memories or facts."
      # ... other universal constraints
    ```
    *(Note: This is a snippet. The full content is detailed in `1.6_V9.5_CoreIdentity.md`.)*

---

## **3. `tool_composition.json`**

*   **Purpose:** Defines the "loadout" for the composite tools used by the asynchronous agents. It maps agent roles to specific composite tool classes and injects them with the correct, named atomic tools.
*   **Consumed By:** `ToolRegistry` (at initialization time).
*   **Location:** `config/tool_composition.json`
*   **Structure & Example:**
    ```json
    {
      "ingestionAnalyst": {
        "compositeToolClassName": "HolisticAnalysisTool",
        "atomicTools": {
          "llmChatTool": "ai:llm:chat:google_gemini_1.5_pro"
        }
      },
      "insightEngine": {
        "compositeToolClassName": "StrategicSynthesisTool",
        "atomicTools": {
          "synthesisLlmTool": "ai:llm:chat:deepseek_v2_pro_strategic"
        }
      }
    }
    ```
    *(Note: The `DialogueAgent` is intentionally omitted as its tools are injected directly at the service level.)*

---

## **4. `card_eligibility_rules.json`**

*   **Purpose:** Provides the deterministic rules for the `CardFactory` to decide if a newly created knowledge entity is important enough to be presented as a `Card` on the user's canvas.
*   **Consumed By:** `CardFactory` service.
*   **Location:** `config/card_eligibility_rules.json`
*   **Structure & Example:**
    ```json
    {
      "MemoryUnit": {
        "min_importance_score": 5.0,
        "required_source_types": ["conversation_extraction", "journal_entry"],
        "min_content_length": 50 
      },
      "Concept": {
        "min_salience": 0.6,
        "eligible_types": [
          "goal",
          "value",
          "project",
          "person",
          "theme"
        ],
        "requires_initial_growth_event": true
      },
      "DerivedArtifact": {
        "eligible_types": ["cycle_report", "insight_summary", "trophy"]
      },
      "ProactivePrompt": {
        "always_eligible": true
      }
    }
    ```

---

## **5. `card_templates.json`**

*   **Purpose:** Provides templates for the `CardFactory` to use when constructing a new `Card` record. It defines the `card_type` (for frontend rendering) and how to populate the initial `display_data` cache.
*   **Consumed By:** `CardFactory` service.
*   **Location:** `config/card_templates.json`
*   **Structure & Example:**
    ```json
    {
      "MemoryUnit_default": {
        "card_type": "memory_unit_card",
        "display_data": {
          "title_source_field": "title",
          "preview_source_field": "content",
          "preview_truncate_length": 150
        }
      },
      "Concept_goal": {
        "card_type": "goal_card",
        "display_data": {
          "title_source_field": "name",
          "preview_source_field": "description"
        }
      },
      "Concept_person": {
        "card_type": "person_card",
        "display_data": {
          "title_source_field": "name",
          "preview_source_field": "description"
        }
      },
      "DerivedArtifact_cycle_report": {
        "card_type": "cycle_report_card",
        "display_data": {
          "title_source_field": "title",
          "preview_source_field": "content_narrative",
          "preview_truncate_length": 200
        }
      },
      "ProactivePrompt_default": {
        "card_type": "quest_card",
        "display_data": {
          "title_source_field": "prompt_text",
          "preview_source_field": "rationale"
        }
      }
    }
    ```

---

## **6. `challenges.json`**

*   **Purpose:** Replaces the `ChallengeTemplate` database table. It defines all available challenges, their completion criteria, and the rewards they grant.
*   **Consumed By:** `ChallengeService` (or a similar service that manages user challenges).
*   **Location:** `config/challenges.json`
*   **Structure & Example:**
    ```json
    [
      {
        "challenge_template_id": "CHL-001",
        "name": "Journaling Initiate",
        "description": "Create three journal entries by capturing your thoughts.",
        "difficulty": "easy",
        "completion_criteria": {
          "type": "count_action",
          "action_type": "create_memory_unit",
          "source_type": "journal_entry",
          "target_count": 3
        },
        "rewards": {
          "growth_events": [
            { "dim_key": "know_self", "delta": 0.5 },
            { "dim_key": "show_self", "delta": 0.2 }
          ],
          "derived_artifact": {
            "artifact_type": "trophy",
            "title": "Trophy: Journaling Initiate",
            "content_narrative": "You've taken the first step on your reflective journey!"
          }
        }
      },
      {
        "challenge_template_id": "CHL-002",
        "name": "Concept Connector",
        "description": "Create a meaningful connection between two of your core concepts.",
        "difficulty": "medium",
        "completion_criteria": {
          "type": "count_action",
          "action_type": "create_relationship",
          "source_entity_type": "Concept",
          "target_entity_type": "Concept",
          "target_count": 1
        },
        "rewards": {
          "growth_events": [
            { "dim_key": "know_self", "delta": 0.8 }
          ]
        }
      }
    ]
    ```

---

## **7. `knowledge_graph_meta_schema.json` (New Addition)**

*   **Purpose:** Serves as the developer-defined, global master list of all *possible* node labels, properties, relationship types, and sub-labels. This is the **superset** from which the user-specific `KnowledgeGraphSchema` is generated and validated.
*   **Consumed By:** The `InsightEngine` worker when it generates/updates a user's `KnowledgeGraphSchema`. It ensures that the personalized schema conforms to the globally defined valid structures.
*   **Location:** `config/knowledge_graph_meta_schema.json`
*   **Structure & Example:**
    ```json
    {
      "version": "9.5",
      "node_labels": [
        "User", "MemoryUnit", "Concept", "DerivedArtifact", "Community"
      ],
      "universal_concept_types": [
        "person", "organization", "location", "project", "goal", "value",
        "skill", "interest", "emotion", "theme", "event_theme", "role"
      ],
      "universal_relationship_types": [
        "HIGHLIGHTS", "RELATED_TO", "DERIVED_FROM", "BELONGS_TO_COMMUNITY", "MERGED_INTO"
      ],
      "universal_relationship_labels": {
        "RELATED_TO": [
          "causes", "influences", "supports", "contradicts", "is_analogy_for",
          "is_part_of", "is_type_of", "leads_to", "resolves", "exemplifies"
        ]
      },
      "property_definitions": {
        "Concept": {
          "name": "string",
          "type": "string",
          "description": "string",
          "salience": "float",
          "status": "string"
        }
      }
    }
    ```

This set of configuration files provides a powerful, flexible, and centralized way to manage the core logic and behavior of the 2dots1line system, fulfilling the "Configuration over Schema" principle.