# **V9.6 Definitive Guide: Event Queue Contracts**

**Document Version:** 9.6
**Purpose:** To provide the single, canonical source of truth for all event types and their payload schemas used in the `card-and-graph-queue`.

## **1. Core Principles**

*   **Queue Technology:** BullMQ (backed by Redis).
*   **Queue Name:** `card-and-graph-queue`.
*   **Error Handling:** All workers subscribing to this queue must implement a dead-letter queue (DLQ) strategy. If a job fails after a set number of retries, it is moved to `card-and-graph-queue-dlq` for manual inspection.
*   **Idempotency:** Workers should be designed to handle the same event more than once without causing duplicate data, although the system aims for at-least-once delivery.
*   **Processing Model:** Multiple workers can consume the same event type. Each worker processes events independently and idempotently.

## **2. Event Payload Schemas**

### **Event Type 1: `new_entities_created`**

*   **Published By:** `IngestionAnalyst` worker.
*   **Consumed By:** `CardWorker`, `GraphProjectionWorker`.
*   **Purpose:** To notify downstream presentation workers that new knowledge entities have been successfully persisted and are ready to be considered for UI representation.
*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface NewEntitiesCreatedEvent {
      type: "new_entities_created";
      userId: string;
      source: "IngestionAnalyst";
      timestamp: string; // ISO8601
      entities: Array<{
        id: string; // The UUID of the newly created entity (e.g., MemoryUnit.muid or Concept.concept_id)
        type: "MemoryUnit" | "Concept";
      }>;
      conversationId?: string; // Optional: source conversation if applicable
    }
    ```

### **Event Type 2: `cycle_artifacts_created`**

*   **Published By:** `InsightEngine` worker.
*   **Consumed By:** `CardWorker`, `GraphProjectionWorker`.
*   **Purpose:** To notify downstream presentation workers that strategic artifacts from a completed cycle are ready to be presented.
*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface CycleArtifactsCreatedEvent {
      type: "cycle_artifacts_created";
      userId: string;
      source: "InsightEngine";
      timestamp: string; // ISO8601
      entities: Array<{
        id: string; // The UUID of the new artifact (e.g., DerivedArtifact.artifact_id or ProactivePrompt.prompt_id)
        type: "DerivedArtifact" | "ProactivePrompt";
      }>;
      cycleId: string; // The cycle that generated these artifacts
    }
    ```

### **Event Type 3: `graph_ontology_updated`**

*   **Published By:** `InsightEngine` worker.
*   **Consumed By:** `GraphProjectionWorker`.
*   **Purpose:** To explicitly trigger a regeneration of the 3D Cosmos projection after significant structural changes to the graph ontology (merges, archives, new communities).
*   **Payload Schema (TypeScript Interface):**
    ```typescript
    interface GraphOntologyUpdatedEvent {
      type: "graph_ontology_updated";
      userId: string;
      source: "InsightEngine";
      timestamp: string; // ISO8601
      summary: {
        concepts_merged: number;
        concepts_archived: number;
        new_communities: number;
        strategic_relationships_added: number;
      };
      affectedNodeIds: string[]; // Specific nodes that need position recalculation
    }
    ```

## **3. Worker Consumption Patterns**

### **`CardWorker` Consumption**
*   **Subscribes To:** `new_entities_created`, `cycle_artifacts_created`
*   **Processing Logic:** For each entity in the event payload, calls `CardFactory.createCardForEntity()` to evaluate eligibility and create cards.
*   **Idempotency:** Safe to process the same event multiple times - `CardFactory` checks if card already exists.

### **`GraphProjectionWorker` Consumption**
*   **Subscribes To:** `new_entities_created`, `cycle_artifacts_created`, `graph_ontology_updated`
*   **Processing Logic:** Triggers incremental recalculation of 3D positions for affected nodes only.
*   **Debouncing:** Implements 30-second debounce window - if multiple events arrive for same user, consolidates into single projection update.
*   **Idempotency:** Safe to recalculate positions multiple times - always produces same result for same input data.

## **4. Error Handling & Retry Strategy**

### **BullMQ Job Configuration**
```typescript
const jobOptions = {
  attempts: 3,
  backoff: {
    type: 'exponential',
    delay: 2000,
  },
  removeOnComplete: 10, // Keep last 10 completed jobs for debugging
  removeOnFail: 50,     // Keep last 50 failed jobs for analysis
};
```

### **Dead Letter Queue Processing**
*   **DLQ Name:** `card-and-graph-queue-dlq`
*   **Manual Review:** Failed events require manual inspection to determine if they should be retried or discarded.
*   **Common Failure Scenarios:**
    *   Database connectivity issues (retry after infrastructure fix)
    *   Malformed event payloads (discard and log for investigation)
    *   Python dimension reducer service unavailable (retry after service restoration)

## **5. Event Publishing Examples**

### **From IngestionAnalyst:**
```typescript
// After successfully persisting new entities
await this.eventQueue.add('new_entities_created', {
  type: 'new_entities_created',
  userId: conversation.user_id,
  source: 'IngestionAnalyst',
  timestamp: new Date().toISOString(),
  entities: [
    { id: newMemoryUnit.muid, type: 'MemoryUnit' },
    { id: newConcept.concept_id, type: 'Concept' }
  ],
  conversationId: conversation.id
});
```

### **From InsightEngine:**
```typescript
// After completing cycle and creating strategic artifacts
await this.eventQueue.add('cycle_artifacts_created', {
  type: 'cycle_artifacts_created',
  userId: user.user_id,
  source: 'InsightEngine',
  timestamp: new Date().toISOString(),
  entities: [
    { id: cycleReport.artifact_id, type: 'DerivedArtifact' },
    { id: newQuest.prompt_id, type: 'ProactivePrompt' }
  ],
  cycleId: `cycle-${Date.now()}`
});

// If significant ontology changes occurred
await this.eventQueue.add('graph_ontology_updated', {
  type: 'graph_ontology_updated',
  userId: user.user_id,
  source: 'InsightEngine',
  timestamp: new Date().toISOString(),
  summary: {
    concepts_merged: 2,
    concepts_archived: 1,
    new_communities: 0,
    strategic_relationships_added: 5
  },
  affectedNodeIds: ['concept-abc', 'concept-def', 'muid-xyz']
});
```

This specification provides a complete contract for event-driven communication between knowledge workers and presentation workers, ensuring loose coupling while maintaining data consistency. 