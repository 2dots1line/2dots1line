
### **`2.3_V9.5_InsightEngine_and_Tools.md` (Revised)**

---

# **V9.5 Canonical Guide: `InsightEngine` Worker & Tools**

**Document Version:** 9.5 (Revised with 3-Package Input)
**Purpose:** To provide a definitive, deep-dive specification for the `InsightEngine` background worker, its use of the `InsightDataCompiler` and `StrategicSynthesisTool`, and its central role in the strategic "Slow Loop" of the 2dots1line system.

## **1. Core Job Responsibility & Philosophy**

The `InsightEngine` is an **asynchronous background worker** responsible for the **strategic, cyclical processing of a user's entire knowledge graph**. Its purpose is to synthesize raw activity and structural analysis into high-level insights, perform holistic ontology refinement, update the user's strategic profiles, and generate proactive guidance for future growth.

**Philosophy:**
*   **Strategic & Periodic:** The `InsightEngine` operates on a long timescale (e.g., a configurable weekly cycle), gated by user activity. It performs the system's most computationally expensive analysis.
*   **Synthesizer of Deterministic Data:** The worker's first job is to deterministically compile three distinct "Input Packages" using the `InsightDataCompiler`. This separates data gathering from AI-driven synthesis.
*   **Planner & Executor:** The `InsightEngine` uses its LLM-powered composite tool (`StrategicSynthesisTool`) to *plan* a series of actions (ontology changes, new artifacts, profile updates). The worker then *executes* this plan deterministically against the databases.

**Location:** `workers/insight-worker/src/InsightEngine.ts`

## **2. Detailed Workflow: Processing a User Cycle**

This is the strictly defined, deterministic sequence of operations executed when a user is eligible for a cycle refresh.

**Trigger:** A scheduler (cron job) identifies eligible users and places a job with `{ userId }` onto the `insight-queue`. An `InsightEngine` worker instance picks up this job.

### **Phase I: Data Compilation via `InsightDataCompiler` (Deterministic Code)**

*   **Responsibility:** `InsightEngine` worker code orchestrates the `InsightDataCompiler`.
*   **Goal:** To assemble the three distinct "Input Packages" that will form the evidence for the LLM.

1.  **Instantiate Compiler:** The worker instantiates the `InsightDataCompiler`, providing it with access to all necessary database clients (PG, Neo4j, Weaviate).
    *   **Dependency:** `InsightDataCompiler` from `workers/insight-worker/src/InsightDataCompiler.ts`.
2.  **Compile Input Packages in Parallel:** The worker calls the three primary methods on the compiler:
    *   `const ingestionSummary = await compiler.compileIngestionActivity(userId, cycleDates);`
    *   `const graphAnalysis = await compiler.compileGraphAnalysis(userId);`
    *   `const strategicInsights = await compiler.compileStrategicInsights(userId, cycleDates);`
3.  **Fetch Supporting Context:** The worker also fetches the user's `PreviousUserMemoryProfile`, `KnowledgeGraphSchema`, `RecentQuestHistory`, and generates `EffectiveQueryPatterns`.

### **Phase II: The "Single Synthesis" LLM Call**

*   **Responsibility:** `InsightEngine` worker invokes its configured composite tool.
*   **Goal:** To perform the entire strategic analysis and generate all required outputs in one efficient, structured LLM call.

1.  **Invoke `StrategicSynthesisTool`:** The worker calls `this.strategicSynthesisTool.execute()`.
    *   **Tool:** The `StrategicSynthesisTool` is a **composite tool** built by the `ToolRegistry` at worker initialization.
    *   **Input to Tool:** A comprehensive object containing all the data gathered in Phase I, including the three distinct input packages: `{ userId, coreIdentitySubset, previousUserMemoryProfile, currentKnowledgeGraphSchema, ingestionSummary, graphAnalysis, strategicInsights, ...etc }`.
2.  **LLM Processing:** The `StrategicSynthesisTool` builds a comprehensive prompt, now cleanly structured around the three input packages, and uses its injected atomic `LLMChatTool` to get a single, structured JSON response from the LLM.
3.  **LLM Output:** The tool returns a validated `StrategicSynthesisOutput` object containing `persistence_payload` and `forward_looking_context`.

### **Phase III: Persistence, Graph Update & State Propagation (Deterministic Code)**

*   **Responsibility:** `InsightEngine` worker code.
*   **Goal:** To execute the strategic plan generated by the LLM.

1.  **Parse LLM Output:** The worker receives the validated JSON output.
2.  **Process `persistence_payload`:**
    *   **Execute Ontology Updates:** The worker opens a transaction with the Neo4j database. It iterates through the `ontology_update_cypher_statements` array and executes each parameterized Cypher query. This is where concept merges, archives, and new strategic relationships are created.
    *   **Execute Relationship Refinement:** The `InsightEngine`'s LLM, after analyzing the context of newly created nodes, can propose upgrades to the generic relationships created by the `IngestionAnalyst`. For example, it might generate a Cypher statement like: `MATCH (a)-[r:RELATED_TO {relationship_label: 'influences'}]->(b) WHERE r.source_agent = 'IngestionAnalyst' SET r.relationship_label = 'is_motivated_by'`. This two-pass process allows for rapid initial ingestion followed by deeper semantic refinement.
    *   **Create Artifacts & Prompts (PostgreSQL):** It creates the `DerivedArtifact` for the `cycle_report_content` and new `ProactivePrompt` records for the `quest_prompts_to_create`.
3.  **Process `forward_looking_context` (State Propagation):**
    *   The worker opens a transaction with the PostgreSQL database.
    *   It saves the `updated_user_memory_profile` to `User.memory_profile`.
    *   It saves the `updated_knowledge_graph_schema` to `User.knowledge_graph_schema`.
    *   It updates the user's `last_cycle_started_at` and resets `concepts_created_in_cycle` to `0`.

### **Phase IV: Event Publishing for Presentation Layer**

*   **Responsibility:** `InsightEngine` worker code.
*   **Goal:** To notify the `CardWorker` that new strategic artifacts are ready to be presented to the user.

1.  **Gather New Entities:** The worker compiles a list of the new `DerivedArtifact` (the cycle report) and `ProactivePrompt` (the quests) it just created.
2.  **Publish Event:** The worker adds a new job to the **`card-and-graph-queue`**.
    *   **Queue:** `card-and-graph-queue` (BullMQ).
    *   **Job Payload:**
        ```json
        {
          "type": "cycle_artifacts_created",
          "userId": "...",
          "entities": [
            { "id": "da-xyz", "type": "DerivedArtifact" },
            { "id": "prompt-123", "type": "ProactivePrompt" }
          ],
          "source": "InsightEngine"
        }
        ```

**Completion:** The `insight-queue` job is marked as complete.

## **3. Key Tools & Data Structures**

*   **`StrategicSynthesisTool` (Composite Tool):**
    *   **Canonical Guide:** Its full specification is detailed in **`4.2_V9.5_StrategicSynthesisTool.md`**.
    *   **Key Inputs:** The three input packages (`IngestionActivitySummary`, `GraphAnalysisPackage`, `StrategicInsightPackage`) and other supporting context.
    *   **Key Outputs:** A single JSON object containing the `persistence_payload` (including executable Cypher) and `forward_looking_context`.

*   **`InsightDataCompiler` (The "Chef de Partie"):**
    *   **Canonical Guide:** A new dedicated document or section detailing this module is required. It is responsible for preparing all the ingredients for the `InsightEngine`.
    *   **Key Role:** Contains the methods to build the three input packages by querying PostgreSQL, Neo4j, and Weaviate. It uses the `InsightQueryLibrary` for its thematic Neo4j queries.

*   **`InsightQueryLibrary`:**
    *   **Canonical Guide:** Its full specification is detailed in **`4.3_V9.5_InsightQueryLibrary.md`**.
    *   **Key Role:** A focused library of thematic, global Cypher queries, used by the `InsightDataCompiler` to help build the `StrategicInsightPackage`.

## **4. Data Storage & State Management**

The `InsightEngine` is a major writer to the system's strategic state.

| Data Component                     | Action           | Storage Location                                       | Written By `InsightEngine` via...                      |
| :--------------------------------- | :--------------- | :----------------------------------------------------- | :------------------------------------------------------|
| `UserMemoryProfile`                | **Update/Write** | PostgreSQL: `User.memory_profile`                      | `UserRepository`                                       |
| `KnowledgeGraphSchema`             | **Update/Write** | PostgreSQL: `User.knowledge_graph_schema`              | `UserRepository`                                       |
| `User` Cycle Timestamps/Counters | **Update/Write** | PostgreSQL: `User` table                                 | `UserRepository`                                       |
| Ontology (Graph Structure)         | **Modify**       | Neo4j                                                  | Neo4j Client (executing LLM-generated Cypher)        |
| `DerivedArtifact` (Cycle Report)   | **Create**       | PostgreSQL: `derived_artifacts` table                  | `DerivedArtifactRepository`                            |
| `ProactivePrompt` (Quests)         | **Create**       | PostgreSQL: `proactive_prompts` table                  | `ProactivePromptRepository`                            |

This V9.5 guide for the `InsightEngine` worker defines its role as the system's strategic synthesizer. It clarifies its refined workflow using a three-package input model, solidifying its place in the "Slow Loop" and its interaction with downstream presentation workers.