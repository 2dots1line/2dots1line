### **Definitive Canonical Guide: The V9.1 `KnowledgeGraphSchema` Component (Developer Edition)**

#### **1. Core Philosophy & Purpose**

The V9.1 `KnowledgeGraphSchema` (KGS) is a **user-specific, dynamically generated JSON object** that serves as rich, contextual "API documentation" for the LLMs interacting with that user's personal knowledge graph.

*   **Generated By:** The `InsightEngine` at the end of each cycle.
*   **Stored In:** `User.knowledge_graph_schema` (PostgreSQL JSONB field).
*   **Consumed By:**
    *   `DialogueAgent` LLM: To understand what information is available and how to formulate Cypher queries for on-demand retrieval.
    *   `IngestionAnalyst` LLM: To ensure extracted concepts and relationships conform to valid types and labels for that user, and to understand existing structures to avoid trivial duplication.
    *   `InsightEngine` LLM: To understand the current graph structure when proposing ontology updates and when regenerating this KGS itself for the next cycle.
*   **Principle (Developer Edition):** Provide comprehensive structural information and personalized examples to maximize the LLM's ability to generate correct and effective outputs (queries or data structures) during the initial development and stabilization phase. Optimization for token economy will follow.

#### **2. Structure of the `KnowledgeGraphSchema` (JSON Object)**

This structure aims to be detailed enough for the LLMs to perform their varied tasks.

```json
// Stored in User.knowledge_graph_schema
{
  "user_id": "uuid-of-user",
  "schema_version": "9.1-dev", // Version of this KGS structure
  "last_updated_by_insight_engine_at": "ISO8601_timestamp",
  "description_for_llm": "This is your personalized guide to this user's knowledge graph. It details the most relevant node types, their key properties, common relationship types, and provides example Cypher queries tailored to this user's graph patterns. Use this to formulate precise Cypher queries for information retrieval and to structure new knowledge consistently.",

  // Section 1: Prominent Node Types & Their Structure for this User
  // Generated by InsightEngine based on actual graph content and the global Meta-Schema.
  // Only includes types actively used or strategically important for THIS user.
  "prominent_node_types": [
    {
      "label": "MemoryUnit", // From global Meta-Schema node_labels
      "description_for_llm": "Represents user's memories, journal entries, or key takeaways from conversations. Focus on capturing the 'story' or 'event'.",
      "key_properties_for_query_and_creation": [ // Properties LLM should focus on
        { "name": "muid", "type": "string", "description": "Unique ID (system-generated)" },
        { "name": "title", "type": "string", "description": "Concise title (max 15 words)" },
        { "name": "content_snippet", "type": "string", "description": "A rich summary of the memory." }, // In prompt, we give snippet, but LLM knows full content exists
        { "name": "creation_ts", "type": "datetime", "description": "Timestamp of when the event occurred." },
        { "name": "importance_score", "type": "float", "description": "System or user-assigned importance." }
      ],
      "common_relationships_for_llm": [ // How this type usually connects
        { "type": "HIGHLIGHTS", "direction": "OUTGOING", "target_label": "Concept", "description": "Links to key Concepts discussed." }
      ]
    },
    {
      "label": "Concept",
      "description_for_llm": "Key entities, themes, goals, values, persons, projects, etc. These are the building blocks of meaning.",
      "key_properties_for_query_and_creation": [
        { "name": "id", "type": "string", "description": "Unique ID (system-generated)" },
        { "name": "name", "type": "string", "description": "The canonical name of the concept." },
        { "name": "type", "type": "string", "description": "Must be one of 'prominent_concept_sub_types_for_user' or 'universal_concept_types'." },
        { "name": "description_snippet", "type": "string", "description": "A brief defining summary." },
        { "name": "status", "type": "string", "description": "'active', 'merged', 'archived'." },
        { "name": "salience", "type": "float", "description": "Overall importance/relevance to user." }
      ],
      "prominent_concept_sub_types_for_user": ["goal", "project", "person", "value", "theme_work"], // Types this user uses MOST or are strategically important
      "common_relationships_for_llm": [
        { "type": "RELATED_TO", "direction": "BIDIRECTIONAL", "target_label": "Concept", "description": "Semantic or causal links to other Concepts." },
        { "type": "HIGHLIGHTS", "direction": "INCOMING", "source_label": "MemoryUnit", "description": "Highlighted in Memories." }
      ]
    }
    // ... Potentially entries for other prominent types like DerivedArtifact or Community if heavily used by THIS user
  ],

  // Section 2: Prominent Relationship Types & Their Structure for this User
  "prominent_relationship_types": [
    {
      "type": "HIGHLIGHTS", // From global Meta-Schema relationship_types
      "description_for_llm": "Indicates that a MemoryUnit discusses or features one or more Concepts.",
      "roles_for_llm": "MemoryUnit -[HIGHLIGHTS]-> Concept",
      "key_properties_for_query_and_creation": [
        { "name": "weight", "type": "float", "description": "Strength of the highlight (0.0-1.0)." }
      ]
    },
    {
      "type": "RELATED_TO",
      "description_for_llm": "A general semantic, causal, or associative link. Primarily between Concepts, but can also link MemoryUnits.",
      "roles_for_llm": "Concept <-[RELATED_TO]-> Concept  OR  MemoryUnit <-[RELATED_TO]-> MemoryUnit",
      "key_properties_for_query_and_creation": [
        { "name": "relationship_label", "type": "string", "description": "Specific type of relation, must be one of 'prominent_relationship_sub_labels_for_user' or 'universal_relationship_labels'."},
        { "name": "weight", "type": "float", "description": "Strength or confidence of the relationship." },
        { "name": "description", "type": "string", "description": "Optional brief explanation of the link." }
      ],
      "prominent_relationship_sub_labels_for_user": ["supports_goal", "causes_emotion", "linked_to_project"] // Sub-labels of RELATED_TO this user uses most
    }
    // ... Other prominent relationship types like BELONGS_TO_COMMUNITY
  ],

  // Section 3: Personalized Example Cypher Queries (for DialogueAgent)
  // Generated by InsightEngine based on EffectiveQueryPatterns and prominent entities.
  "example_cypher_queries_personalized": [
    {
      "description_for_llm": "How to find recent memories where the user discussed their active goal 'Learn Advanced TypeScript'.",
      "query_template_for_llm_adaptation": "MATCH (g:Concept {name: 'Learn Advanced TypeScript', userId: $userId, type: 'goal'})<-[:HIGHLIGHTS]-(m:MemoryUnit) WHERE m.creation_ts > $since_date AND m.userId = $userId RETURN m.title, m.content_snippet ORDER BY m.creation_ts DESC LIMIT 5"
    },
    {
      "description_for_llm": "How to find projects associated with 'Sarah Adams' and also linked to the theme 'Team Collaboration'.",
      "query_template_for_llm_adaptation": "MATCH (p:Concept {name: 'Sarah Adams', userId: $userId, type: 'person'})-[:RELATED_TO]-(project:Concept {type: 'project', userId: $userId})-[:RELATED_TO]-(theme:Concept {name: 'Team Collaboration', type: 'theme', userId: $userId}) RETURN project.name, project.description_snippet LIMIT 10"
    }
    // ... 2-3 more highly relevant, personalized examples
  ],

  // Section 4: Universal Vocabularies (Subset from Meta-Schema, for validation by Ingestion/Insight LLMs)
  "universal_core_entity_types": ["User", "MemoryUnit", "Concept", "DerivedArtifact", "Community", "ProactivePrompt", "Card"],
  "universal_concept_types": [ // The full list from Meta-Schema
      "person", "organization", "location", "project", "goal", "value",
      "skill", "interest", "emotion_positive", "emotion_negative", "theme",
      "event_theme", "role", "challenge_topic", "strength", "weakness", "book", "artwork"
      // ...
  ],
  "universal_relationship_labels": [ // For RELATED_TO, the full list from Meta-Schema
      "causes", "influences", "supports", "contradicts", "is_analogy_for",
      "is_part_of", "is_type_of", "leads_to", "resolves", "exemplifies"
      // ...
  ],

  // Section 5: Ontology Update Guidelines (for InsightEngine's LLM)
  "ontology_update_guidelines_for_llm": [
    "When proposing new Concepts via 'ontology_update_cypher_statements', ensure 'type' is one of the 'universal_concept_types'.",
    "When proposing new 'RELATED_TO' relationships, ensure 'relationship_label' is one of the 'universal_relationship_labels'.",
    "Prioritize merging concepts if their names are highly similar AND their types match, especially if they share many common neighbors (analyze CompiledCycleData for this).",
    "New communities should generally be formed around clusters of at least 3-5 highly interconnected, salient concepts. Generated Cypher should create a :Community node and :BELONGS_TO_COMMUNITY relationships."
  ]
}
```

#### **How this KGS Supports Each Agent (V9.1 - Developer Edition):**

*   **`DialogueAgent` LLM:**
    *   Uses `prominent_node_types` and `prominent_relationship_types` to understand the "shape" of the user's most common data.
    *   Heavily relies on `example_cypher_queries_personalized` as few-shot examples to construct its own `cypher_query` for the `query_memory` decision. The LLM is instructed to adapt these templates.
    *   The `description_for_llm` and `key_properties_for_query_and_creation` guide it on what's important.

*   **`IngestionAnalyst` LLM:**
    *   Uses `prominent_node_types` and especially `prominent_concept_sub_types_for_user` to bias its extraction towards concepts and types relevant to *this user*.
    *   Uses `universal_concept_types` and `universal_relationship_labels` as the **master controlled vocabulary** when it needs to assign a type/label for a *newly extracted* entity/relation that doesn't fit a prominent user-specific pattern.
    *   The `key_properties_for_query_and_creation` sections guide it on what attributes to try and populate for new entities.

*   **`InsightEngine` LLM:**
    *   **For Ontology Updates:** Uses the *entire* KGS (prominent types, properties, relationships) as a reference for the current state of the graph. It uses `ontology_update_guidelines_for_llm` and `universal_concept_types`/`universal_relationship_labels` to formulate its `ontology_update_cypher_statements`.
    *   **For KGS Regeneration:** This is the meta-step. The LLM receives the *current* KGS (as generated in the previous cycle) as input. It then analyzes `CompiledCycleData` and `EffectiveQueryPatterns`. Based on this, it generates the *new, updated* KGS object (which might add new prominent types, new example queries, or refine descriptions) that will be saved to `User.knowledge_graph_schema` for the *next* cycle.

#### **The Role of the Global `knowledge_graph_meta_schema.json`:**

*   It remains the **developer-defined master list** of all *possible* node labels, properties, relationship types, and labels.
*   The `InsightEngine` worker, when generating the user-specific KGS, will consult this Meta-Schema to:
    *   Populate the `universal_concept_types` and `universal_relationship_labels` sections of the user's KGS.
    *   Ensure that any "prominent" types/labels it elevates for a user are indeed valid according to the global rules.
*   The LLMs for `IngestionAnalyst` and `InsightEngine` (when proposing new ontology elements) are ultimately guided by the `universal_` lists within the user's KGS, which are sourced from this Meta-Schema.

This V9.1 Developer Edition `KnowledgeGraphSchema` is designed to be rich and informative, providing maximum context during development. The `InsightEngine`'s role in dynamically curating this personalized schema based on user activity and the global Meta-Schema is key to its power and adaptability. We can later experiment with making it more concise if token limits become a pressing concern, potentially by moving towards the V9.2 "Exemplar & Action Catalog" model once the system is stable.