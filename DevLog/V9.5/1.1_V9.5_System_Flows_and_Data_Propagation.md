
### **`1.1_V9.5_System_Flows_and_Data_Propagation.md`**

---

# **V9.5 System Flows and Data Propagation**

**Document Version:** 9.5
**Purpose:** To provide a detailed, step-by-step visual and textual description of the primary data flows and agent interactions within the 2dots1line V9.5 architecture. This document answers the question: "What happens when...?"

## **1. Introduction**

The V9.5 architecture operates on four distinct but interconnected process flows. These flows ensure a responsive user experience while allowing for deep, asynchronous analysis and presentation layer generation.

1.  **The Real-Time Conversation Loop:** The immediate, turn-by-turn interaction between the user and the `DialogueAgent`.
2.  **The Fast Loop (Post-Conversation Ingestion):** The asynchronous processing of a completed conversation by the `IngestionAnalyst` to create structured knowledge.
3.  **The Presentation Loop (Card & Graph Generation):** The asynchronous creation of UI-ready data by the `CardWorker` and `GraphProjectionWorker`, triggered by events from the Fast and Slow Loops.
4.  **The Slow Loop (Cyclical Insight):** The periodic, deep analysis of the user's entire knowledge graph by the `InsightEngine`.

---

## **2. Flow 1: The Real-Time Conversation Loop**

**Objective:** To provide a single, coherent, context-aware response to a user's message in real-time.
**Primary Actor:** `DialogueAgent`

```
                                               ┌───────────────────────────────┐
                                               │      USER INTERFACE LAYER     │
                                               └───────────────┬───────────────┘
                                                               │ 1. User sends message
                                                               │    (POST /api/v1/conversations/messages)
                                                               │    Payload: { message_content, source_card_id?, ui_context? }
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │ `conversation.controller.ts`  │
                                               │ - Finds/creates Conversation in PG │
                                               │ - Logs user's message         │
                                               │ - Sets/Resets Redis timeout key: │
                                               │   `conversation:timeout:{convoId}` │
                                               └───────────────┬───────────────┘
                                                               │ 2. Invokes DialogueAgent.processTurn()
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │   `DialogueAgent` Service     │
                                               └───────────────┬───────────────┘
                                                               │ 3. Calls `PromptBuilder` to assemble prompt
                                                               │    (fetches UserProfile, KGS, History, etc.)
                                                               │
                                                               │ 4. Makes "Single Synthesis" LLM call
                                                               │    (LLM decides `query_memory` or `respond_directly`)
                                                               │
                  ┌────────────────────────────────────────────┴────────────────────────────────────────────┐
                  │                                                                                         │
       IF `decision === 'query_memory'`                                                          IF `decision === 'respond_directly'`
                  │                                                                                         │
                  │ 5a. Extracts `key_phrases` from LLM output.                                             │
                  │                                                                                         │
                  │ 5b. Calls `HybridRetrievalTool.execute({ key_phrases })`                                │
                  │     ┌─────────────────────┐                                                             │
                  │     │ HybridRetrievalTool │                                                             │
                  │     │ (Weaviate -> Neo4j -> PG) │                                                             │
                  │     └─────────┬───────────┘                                                             │
                  │               │ 5c. Returns `AugmentedMemoryContext`                                    │
                  │               ▼                                                                         │
                  │ 5d. Makes 2nd LLM call with `AugmentedMemoryContext`                                    │
                  │     to generate final response text and UI actions.                                     │
                  │                                                                                         │
                  └────────────────────────────────────────────┬────────────────────────────────────────────┘
                                                               │ 6. Extracts final `direct_response_text` & `ui_actions`
                                                               │    from LLM output.
                                                               │
                                                               │ 7. Extracts `TurnContextPackage` from LLM output
                                                               │    and saves to Redis: `turn_context:{convoId}`
                                                               │
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │ `conversation.controller.ts`  │
                                               │ - Logs assistant's message    │
                                               │ - Returns response to client  │
                                               └───────────────┬───────────────┘
                                                               │ 8. Final JSON response sent to UI
                                                               ▼
                                               ┌───────────────────────────────┐
                                               │      USER INTERFACE LAYER     │
                                               │ (Displays text & executes UI actions) │
                                               └───────────────────────────────┘
```

---

## **3. Flow 2: The Fast Loop (Post-Conversation Ingestion)**

**Objective:** To analyze a completed conversation and transform it into structured knowledge entities.
**Primary Actor:** `IngestionAnalyst` (Worker)

```
                                       ┌────────────────────────────────────┐
                                       │       `conversation-timeout-worker`    │
                                       │ (Listens for Redis Key Expiry Notifications) │
                                       └───────────────────┬──────────────────┘
                                                           │ 1. `conversation:timeout:{convoId}` key expires.
                                                           │
                                                           │ 2. Worker updates Conversation status to 'ended' in PG.
                                                           │
                                                           │ 3. Worker adds a job to the `ingestion-queue`.
                                                           │    Job Payload: { conversationId, userId }
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │      `ingestion-queue` (BullMQ)    │
                                       └───────────────────┬──────────────────┘
                                                           │ 4. `ingestion-worker` picks up job.
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │    `IngestionAnalyst` Worker       │
                                       └───────────────────┬──────────────────┘
                                                           │ 5. Gathers all data for its "Single Synthesis Call":
                                                           │    - Fetches FullConversationTranscript (PG)
                                                           │    - Fetches UserMemoryProfile & KnowledgeGraphSchema (PG)
                                                           │
                                                           │ 6. Calls `HolisticAnalysisTool.execute()`
                                                           │
                                                           │ 7. Receives structured JSON with `persistence_payload`
                                                           │    and `forward_looking_context`.
                                                           │
                 ┌─────────────────────────────────────────┴─────────────────────────────────────────┐
                 │                                                                                   │
      8a. PERSISTS `persistence_payload`                                     8b. PERSISTS `forward_looking_context`
                 │                                                                                   │
                 ▼                                                                                   ▼
   ┌───────────────────────────────┐                                                     ┌──────────────────────────┐
   │         POSTGRESQL            │                                                     │        POSTGRESQL        │
   │ - Updates Conversation summary/score │                                                     │ - Updates User.next_      │
   │ - Creates new MemoryUnits      │                                                     │   conversation_context_ │
   │ - Creates new Concepts         │                                                     │   package              │
   │ - Creates new GrowthEvents     │                                                     └──────────────────────────┘
   └──────────────┬────────────────┘
                  │
   ┌──────────────▼────────────────┐
   │            NEO4J              │
   │ - Creates new :MemoryUnit nodes│
   │ - Creates new :Concept nodes   │
   │ - Creates new :RELATED_TO, etc.│
   │   relationships                │
   └──────────────┬────────────────┘
                  │
   ┌──────────────▼────────────────┐
   │            WEAVIATE           │
   │ - Creates vector embeddings for│
   │   new content (UserKnowledgeItems)│
   └──────────────┬────────────────┘
                  │
                  │ 9. Gathers all newly created, persistent entities
                  │    (MemoryUnits, Concepts).
                  │
                  │ 10. PUBLISHES EVENT(S)
                  ▼
   ┌────────────────────────────────────┐
   │       `card-and-graph-queue`       │
   │ Event: { type: "new_entities_created", userId, entities: [...] } │
   └────────────────────────────────────┘
```

---

## **4. Flow 3: The Presentation Loop (Card & Graph Generation)**

**Objective:** To create the UI-ready data for the 2D Card Canvas and the 3D Knowledge Cosmos, based on events from the Fast and Slow loops.
**Primary Actors:** `CardWorker`, `GraphProjectionWorker`

```
                            ┌────────────────────────────────────┐
                            │       `card-and-graph-queue`       │
                            │ Event: { type: "...", userId, data: ... } │
                            └───────────────────┬──────────────────┘
                                                │ 1. Event published by IngestionAnalyst or InsightEngine
                                                │
                 ┌──────────────────────────────┴──────────────────────────────┐
                 │                                                             │
      2a. `card-worker` subscribes                                2b. `graph-projection-worker` subscribes
                 │     (if event type is relevant, e.g., 'new_entities_created')          (if event type requires projection update)
                 │                                                             │
                 ▼                                                             ▼
   ┌───────────────────────────┐                                 ┌───────────────────────────┐
   │       `CardWorker`        │                                 │  `GraphProjectionWorker`  │
   └───────────┬───────────────┘                                 └───────────┬───────────────┘
               │ 3a. For each entity in event payload...                     │ 3b. Fetches latest graph structure (Neo4j)
               │                                                             │     and vectors (Weaviate).
               │ 4a. Calls `CardFactory.createCard()`                        │
               │     which checks `card_eligibility_rules.json`              │ 4b. Runs dimensionality reduction
               │                                                             │     (e.g., UMAP) to get 3D coordinates.
               │ 5a. If eligible, creates new `Card` record.                 │
               │                                                             │ 5b. Saves the complete projection data.
               ▼                                                             ▼
   ┌───────────────────────────┐                                 ┌───────────────────────────┐
   │         POSTGRESQL        │                                 │         POSTGRESQL        │
   │  - New record in `cards` table. │                                 │  - Updates `user_graph_projections` table. │
   └───────────────────────────┘                                 └───────────────────────────┘
                                                                             │ OR
                                                                 ┌───────────▼───────────────┐
                                                                 │       CDN (S3/CloudFront)   │
                                                                 │ - Uploads new projection JSON file. │
                                                                 └─────────────────────────────┘
```

---


## **5. Flow 4: The Slow Loop (Cyclical Insight)**

**Objective:** To perform deep, strategic analysis of the user's graph, refine the ontology, and generate long-term guidance.
**Primary Actor:** `InsightEngine` (Worker)

```
                                       ┌────────────────────────────────────┐
                                       │        Scheduler (Cron Job)        │
                                       └───────────────────┬──────────────────┘
                                                           │ 1. Runs periodically (e.g., hourly).
                                                           │
                                                           │ 2. Queries PG for eligible users (based on
                                                           │    time since last cycle & activity threshold).
                                                           │
                                                           │ 3. For each eligible user, adds a job to
                                                           │    the `insight-queue`.
                                                           │    Job Payload: { userId }
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │       `insight-queue` (BullMQ)     │
                                       └───────────────────┬──────────────────┘
                                                           │ 4. `insight-worker` picks up job.
                                                           ▼
                                       ┌────────────────────────────────────┐
                                       │      `InsightEngine` Worker        │
                                       └───────────────────┬──────────────────┘
                                                           │ 5. **PHASE I: DATA COMPILATION**
                                                           │    - Instantiates `InsightDataCompiler`.
                                                           │    - Calls compiler to build the three input packages:
                                                           │      * `IngestionActivitySummary` (from PG)
                                                           │      * `GraphAnalysisPackage` (from Neo4j/Weaviate)
                                                           │      * `StrategicInsightPackage` (from Neo4j)
                                                           │    - Fetches other context (Prev. Profile, KGS, etc.).
                                                           │
                                                           │ 6. **PHASE II: STRATEGIC SYNTHESIS**
                                                           │    - Calls `StrategicSynthesisTool.execute()` with all
                                                           │      compiled data and context packages.
                                                           │
                                                           │ 7. Receives single structured JSON with `persistence_payload`
                                                           │    and `forward_looking_context`.
                                                           │
                 ┌─────────────────────────────────────────┴─────────────────────────────────────────┐
                 │                                                                                   │
      8a. **PHASE III: PERSIST `persistence_payload`**                       8b. **PHASE III: PERSIST `forward_looking_context`**
                 │                                                                                   │
                 ▼                                                                                   ▼
   ┌───────────────────────────────┐                                                     ┌──────────────────────────┐
   │            NEO4J              │                                                     │        POSTGRESQL        │
   │ - Executes `ontology_update_  │                                                     │ - Updates User.memory_profile │
   │   cypher_statements` (merges,  │                                                     │ - Updates User.knowledge_ │
   │   archives, new relationships) │                                                     │   graph_schema           │
   └───────────────────────────────┘                                                     │ - Updates User cycle     │
                                                                                         │   timestamps/counters    │
   ┌───────────────────────────────┐                                                     └──────────────────────────┘
   │         POSTGRESQL            │
   │ - Creates `cycle_report` DerivedArtifact │
   │ - Creates `ProactivePrompt` records (for quests) │
   └──────────────┬────────────────┘
                  │
                  │ 9. **PHASE IV: EVENT PUBLISHING**
                  │    - Gathers new `DerivedArtifact` & `ProactivePrompt` entities.
                  │
                  │ 10. Publishes event to the presentation queue.
                  ▼
   ┌────────────────────────────────────┐
   │       `card-and-graph-queue`       │
   │ Event: { type: "cycle_artifacts_created", userId, entities: [...] } │
   └────────────────────────────────────┘
```