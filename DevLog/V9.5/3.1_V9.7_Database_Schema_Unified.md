### **`3.1_V9.6_Database_Schema_Unified.md`**


# V9.7 Definitive Unified Database Schema

**Document Version:** 9.7
**Purpose:** To provide the single, canonical source of truth for the schemas of all persistence layers: PostgreSQL, Neo4j, and Weaviate. This version is complete, exhaustive, and implementation-ready.

---

## **Part 1: PostgreSQL V9.7 Schema (Prisma Format)**

**Location:** `packages/database/prisma/schema.prisma`

This is the **System of Record**.

```prisma
// packages/database/prisma/schema.prisma
// V9.7 - Definitive Production Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================================================
// SECTION 1: CORE USER & SESSION MANAGEMENT
// ========================================================================
model User {
  user_id             String    @id @default(uuid())
  email               String    @unique
  hashed_password     String?
  name                String?
  region              String    @default("us")
  timezone            String?   @default("UTC")
  language_preference String?   @default("en")
  profile_picture_url String?
  account_status      String    @default("active")
  created_at          DateTime  @default(now())
  last_active_at      DateTime? @updatedAt

  // V9.7: Core context packages
  memory_profile                    Json? @db.JsonB
  knowledge_graph_schema            Json? @db.JsonB
  next_conversation_context_package Json? @db.JsonB

  // V9.7: Cycle management fields
  last_cycle_started_at   DateTime?
  concepts_created_in_cycle Int     @default(0)
  
  // V9.7: User-configurable settings
  preferences Json? @db.JsonB

  // --- Relations ---
  sessions                UserSession[]
  conversations           Conversation[]
  cards                   Card[]
  memory_units            MemoryUnit[]
  concepts                Concept[]
  media_items             Media[]
  derived_artifacts       DerivedArtifact[]
  user_challenges         UserChallenge[]
  proactive_prompts       ProactivePrompt[]
  growth_events           GrowthEvent[]
  communities             Community[]
  interaction_logs        InteractionLog[]
  graph_projections       UserGraphProjection[]

  @@map("users")
}

model UserSession {
  session_id     String   @id @default(uuid())
  user_id        String
  user           User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  device_info    Json?    @db.JsonB
  ip_address     String?
  user_agent     String?
  created_at     DateTime @default(now())
  expires_at     DateTime
  last_active_at DateTime @updatedAt

  @@index([user_id])
  @@map("user_sessions")
}


// ========================================================================
// SECTION 2: CONVERSATION & INTERACTION LOGGING
// ========================================================================
model Conversation {
  id               String    @id @default(uuid())
  user_id          String
  user             User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  title            String?
  start_time       DateTime  @default(now())
  ended_at         DateTime?
  status           String    @default("active") // 'active', 'ended', 'processing', 'processed'
  importance_score Float?
  context_summary  String?
  metadata         Json?     @db.JsonB
  source_card_id   String?
  source_card      Card?     @relation(fields: [source_card_id], references: [card_id], onDelete: SetNull)

  messages             ConversationMessage[]
  spawned_memory_units MemoryUnit[]

  @@index([user_id, status])
  @@map("conversations")
}

model ConversationMessage {
  id                String       @id @default(uuid())
  conversation_id   String
  conversation      Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  role              String       // 'user' or 'assistant'
  content           String
  timestamp         DateTime     @default(now())
  llm_call_metadata Json?        @db.JsonB
  media_ids         String[]     @default([])

  @@index([conversation_id, timestamp])
  @@map("conversation_messages")
}


// ========================================================================
// SECTION 3: PRESENTATION & KNOWLEDGE ENTITIES
// ========================================================================
model Card {
  card_id             String    @id @default(uuid())
  user_id             String
  user                User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  card_type           String
  source_entity_id    String
  source_entity_type  String    // 'MemoryUnit', 'Concept', 'DerivedArtifact', 'ProactivePrompt'
  status              String    @default("active_canvas") // 'active_canvas', 'active_archive', 'completed'
  is_favorited        Boolean   @default(false)
  display_data        Json?     @db.JsonB
  is_synced           Boolean   @default(true)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  initiated_conversations Conversation[]

  @@index([user_id, status])
  @@map("cards")
}

model MemoryUnit {
  muid                    String    @id @default(uuid())
  user_id                 String
  user                    User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  title                   String
  content                 String
  creation_ts             DateTime
  ingestion_ts            DateTime  @default(now())
  last_modified_ts        DateTime  @updatedAt
  importance_score        Float?
  sentiment_score         Float?
  source_conversation_id  String?
  source_conversation     Conversation? @relation(fields: [source_conversation_id], references: [id], onDelete: SetNull)
  
  media_items             Media[]
  derived_artifacts_as_source DerivedArtifact[]

  @@map("memory_units")
}

model Concept {
  concept_id String @id @default(uuid())
  user_id    String
  user       User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  name       String
  type       String
  description         String?
  status              String     @default("active") // 'active', 'merged', 'archived'
  salience            Float?
  created_at          DateTime   @default(now())
  last_updated_ts     DateTime   @updatedAt
  community_id        String?
  community           Community? @relation(fields: [community_id], references: [community_id], onDelete: SetNull)
  merged_into_concept_id String?
  merged_into_concept    Concept?   @relation("ConceptMergeTarget", fields: [merged_into_concept_id], references: [concept_id], onDelete: NoAction, onUpdate: NoAction)
  merged_from_concepts   Concept[]  @relation("ConceptMergeTarget")

  derived_artifacts_as_source DerivedArtifact[]

  @@unique([user_id, name, type])
  @@map("concepts")
}

model Media {
  media_id          String     @id @default(uuid())
  user_id           String
  user              User       @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  memory_unit_id    String?
  memory_unit       MemoryUnit? @relation(fields: [memory_unit_id], references: [muid], onDelete: SetNull)
  type              String     // 'image', 'audio', 'document'
  storage_url       String
  filename          String?
  mime_type         String?
  size_bytes        Int?
  hash              String?    @unique
  processing_status String     @default("pending")
  metadata          Json?      @db.JsonB
  created_at        DateTime   @default(now())

  @@map("media_items")
}

// ========================================================================
// SECTION 4: GROWTH, GUIDANCE & DERIVED CONTENT
// ========================================================================
model GrowthEvent {
  event_id    String   @id @default(uuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  entity_id   String
  entity_type String
  dim_key     String
  delta       Float
  source      String
  created_at  DateTime @default(now())
  details     Json?    @db.JsonB // { rationale: string }
  @@map("growth_events")
}

model UserChallenge {
  user_challenge_id String    @id @default(uuid())
  user_id           String
  user              User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  challenge_template_id String
  status                String    @default("active")
  start_time            DateTime  @default(now())
  completion_time       DateTime?
  progress_data         Json?     @db.JsonB
  @@map("user_challenges")
}

model ProactivePrompt {
  prompt_id    String    @id @default(uuid())
  user_id      String
  user         User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  prompt_text  String
  source_agent String
  status       String    @default("pending")
  created_at   DateTime  @default(now())
  metadata     Json?     @db.JsonB
  @@map("proactive_prompts")
}

model DerivedArtifact {
  artifact_id        String    @id @default(uuid())
  user_id            String
  user               User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  artifact_type      String    // 'insight_summary', 'cycle_report', 'trophy'
  title              String
  content_narrative  String?
  content_data       Json?     @db.JsonB
  source_memory_unit_id String?
  source_memory_unit    MemoryUnit? @relation(fields: [source_memory_unit_id], references: [muid], onDelete: SetNull)
  source_concept_id     String?
  source_concept        Concept?    @relation(fields: [source_concept_id], references: [concept_id], onDelete: SetNull)
  created_at            DateTime    @default(now())
  @@map("derived_artifacts")
}

model Community {
  community_id     String    @id @default(uuid())
  user_id          String
  user             User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  name             String
  description      String?
  created_at       DateTime  @default(now())
  last_analyzed_ts DateTime? @updatedAt
  
  concepts Concept[]
  @@map("communities")
}

// ========================================================================
// SECTION 5: UNIFIED INTERACTION & 3D COSMOS
// ========================================================================
model InteractionLog {
  interaction_id String   @id @default(uuid())
  user_id        String
  user           User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  timestamp      DateTime @default(now())
  interaction_type String
  target_entity_id   String?
  target_entity_type String?
  content_text      String?
  content_structured Json?    @db.JsonB
  metadata         Json?    @db.JsonB
  @@map("interaction_logs")
}

model UserGraphProjection {
  projection_id       String   @id @default(uuid())
  user_id             String
  user                User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  status              String   @default("completed")
  projection_data     Json     @db.JsonB
  created_at          DateTime @default(now())

  @@index([user_id, created_at(sort: Desc)])
  @@map("user_graph_projections")
}
```

---

## **Part 2: Neo4j V9.7 Graph Schema (Cypher DDL)**

**Location:** `packages/database/src/neo4j/schema.cypher`

This is the **System of Relationships**. Its properties mirror the V9.7 PostgreSQL schema.

```cypher
// V9.7 Definitive Schema for Neo4j 5.x

// --- CONSTRAINTS (Ensure Uniqueness & Create Backing Indexes) ---
CREATE CONSTRAINT user_userId_unique IF NOT EXISTS FOR (n:User) REQUIRE n.userId IS UNIQUE;
CREATE CONSTRAINT memoryunit_muid_unique IF NOT EXISTS FOR (n:MemoryUnit) REQUIRE n.muid IS UNIQUE;
CREATE CONSTRAINT concept_id_unique IF NOT EXISTS FOR (n:Concept) REQUIRE n.id IS UNIQUE;
CREATE CONSTRAINT derivedartifact_id_unique IF NOT EXISTS FOR (n:DerivedArtifact) REQUIRE n.id IS UNIQUE;
CREATE CONSTRAINT community_community_id_unique IF NOT EXISTS FOR (n:Community) REQUIRE n.community_id IS UNIQUE;

// --- INDEXES (For Query Performance) ---
CREATE INDEX memoryunit_userId_idx IF NOT EXISTS FOR (n:MemoryUnit) ON (n.userId);
CREATE INDEX concept_userId_idx IF NOT EXISTS FOR (n:Concept) ON (n.userId);
CREATE INDEX derivedartifact_userId_idx IF NOT EXISTS FOR (n:DerivedArtifact) ON (n.userId);
CREATE INDEX community_userId_idx IF NOT EXISTS FOR (n:Community) ON (n.userId);

CREATE INDEX memoryunit_creation_ts_idx IF NOT EXISTS FOR (n:MemoryUnit) ON (n.creation_ts);
CREATE INDEX concept_name_idx IF NOT EXISTS FOR (n:Concept) ON (n.name);
CREATE INDEX concept_type_idx IF NOT EXISTS FOR (n:Concept) ON (n.type);
CREATE INDEX concept_status_idx IF NOT EXISTS FOR (n:Concept) ON (n.status);
```

---

## **Part 3: Weaviate V9.7 Vector Schema (JSON Format)**

**Location:** `packages/database/src/weaviate/schema.json`

This is the **System of Semantics**, unified into a single class.

```json
{
  "classes": [
    {
      "class": "UserKnowledgeItem",
      "description": "A unified searchable item representing textual content from any source entity.",
      "vectorizer": "none",
      "properties": [
        { "name": "externalId", "dataType": ["uuid"] },
        { "name": "userId", "dataType": ["string"], "indexInverted": true },
        { "name": "sourceEntityType", "dataType": ["string"], "indexInverted": true },
        { "name": "sourceEntityId", "dataType": ["uuid"], "indexInverted": true },
        { "name": "textContent", "dataType": ["text"] },
        { "name": "title", "dataType": ["text"], "indexInverted": true, "tokenization": "word" },
        { "name": "embeddingModelVersion", "dataType": ["string"], "indexInverted": true },
        { "name": "createdAt", "dataType": ["date"], "indexInverted": true },
        { "name": "importanceScore", "dataType": ["number"], "indexInverted": true },
        { "name": "tags", "dataType": ["text[]"], "indexInverted": true, "tokenization": "word" }
      ]
    }
  ]
}
```
```